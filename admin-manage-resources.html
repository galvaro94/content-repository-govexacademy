<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Resources - GovEx Academy</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #0d1117;
            color: #e6edf3;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { createRoot } = ReactDOM;

        // Icon component using Lucide icons
        function Icon({ name, size = 16, className = "", ...props }) {
            const LucideIcon = lucide[name.charAt(0).toUpperCase() + name.slice(1).replace(/-([a-z])/g, (g) => g[1].toUpperCase())];
            if (!LucideIcon) {
                console.warn(`Icon "${name}" not found`);
                return <span className={`inline-block w-${Math.floor(size/4)} h-${Math.floor(size/4)} ${className}`} {...props} />;
            }
            return <LucideIcon size={size} className={className} {...props} />;
        }

        // Google Sheets Service
        const GoogleSheetsService = {
            API_KEY: 'AIzaSyBUa8W2lZXxRNfqJ3Ov0MWUPeTd0TjkRhg',
            SHEET_ID: '1GSqiViIPp4GPAe4ugZ2ImXShsU1NP37CjT_I3Ck-AR4',

            async fetchFormResponses() {
                const RANGE = 'Form Responses 1!A2:H';
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.SHEET_ID}/values/${RANGE}?key=${this.API_KEY}`;

                try {
                    const response = await fetch(url);
                    const data = await response.json();

                    if (!data.values) {
                        return [];
                    }

                    return data.values.map((row, index) => {
                        const [
                            timestamp = '',
                            description = '',
                            topic = '',
                            purpose = '',
                            envisionedFormat = '',
                            audience = '',
                            program = '',
                            additionalContext = ''
                        ] = row;

                        return {
                            id: index + 1,
                            timestamp,
                            description,
                            topic,
                            purpose,
                            envisionedFormat,
                            audience,
                            program,
                            additionalContext,
                            status: 'pending'
                        };
                    });
                } catch (error) {
                    console.error('Error fetching form responses:', error);
                    throw error;
                }
            }
        };

        function ManageResourcesApp() {
            const [requests, setRequests] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [statusOverrides, setStatusOverrides] = useState({});

            // Load status overrides from localStorage
            useEffect(() => {
                const saved = localStorage.getItem('resourceRequestStatuses');
                if (saved) {
                    try {
                        setStatusOverrides(JSON.parse(saved));
                    } catch (e) {
                        console.error('Error loading saved statuses:', e);
                    }
                }
            }, []);

            // Save status overrides to localStorage
            useEffect(() => {
                localStorage.setItem('resourceRequestStatuses', JSON.stringify(statusOverrides));
            }, [statusOverrides]);

            // Load data from Google Sheets
            useEffect(() => {
                const loadData = async () => {
                    try {
                        setIsLoading(true);
                        const data = await GoogleSheetsService.fetchFormResponses();
                        setRequests(data);
                        setError(null);
                    } catch (err) {
                        setError('Failed to load data from Google Sheets');
                        console.error(err);
                    } finally {
                        setIsLoading(false);
                    }
                };

                loadData();

                // Refresh every 30 seconds
                const interval = setInterval(loadData, 30000);
                return () => clearInterval(interval);
            }, []);

            const updateStatus = (requestId, newStatus) => {
                setStatusOverrides(prev => ({
                    ...prev,
                    [requestId]: newStatus
                }));
            };

            const getStatus = (request) => {
                return statusOverrides[request.id] || request.status || 'pending';
            };

            const requestsWithStatus = useMemo(() => {
                return requests.map(request => ({
                    ...request,
                    currentStatus: getStatus(request)
                }));
            }, [requests, statusOverrides]);

            const statusCounts = useMemo(() => {
                const counts = { pending: 0, 'in-review': 0, completed: 0 };
                requestsWithStatus.forEach(request => {
                    counts[request.currentStatus] = (counts[request.currentStatus] || 0) + 1;
                });
                return counts;
            }, [requestsWithStatus]);

            const getStatusBadgeClass = (status) => {
                switch (status) {
                    case 'pending':
                        return 'bg-yellow-500 bg-opacity-20 text-yellow-300 border-yellow-500';
                    case 'in-review':
                        return 'bg-blue-500 bg-opacity-20 text-blue-300 border-blue-500';
                    case 'completed':
                        return 'bg-green-500 bg-opacity-20 text-green-300 border-green-500';
                    default:
                        return 'bg-gray-500 bg-opacity-20 text-gray-300 border-gray-500';
                }
            };

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-[#0d1117] flex items-center justify-center">
                        <div className="text-center">
                            <Icon name="loader-2" className="mx-auto text-[#8b949e] mb-4 animate-spin" size={48} />
                            <h3 className="text-lg font-medium text-[#e6edf3] mb-2">Loading Requests</h3>
                            <p className="text-[#8b949e]">Syncing data from Google Sheets...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen bg-[#0d1117] flex items-center justify-center">
                        <div className="text-center">
                            <Icon name="alert-circle" className="mx-auto text-red-400 mb-4" size={48} />
                            <h3 className="text-lg font-medium text-[#e6edf3] mb-2">Error Loading Data</h3>
                            <p className="text-[#8b949e] mb-4">{error}</p>
                            <button
                                onClick={() => window.location.reload()}
                                className="px-4 py-2 bg-[#137fec] text-white rounded-lg hover:bg-[#1c8fed] transition-colors"
                            >
                                Retry
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-[#0d1117]">
                    {/* Header */}
                    <header className="bg-[#161b22] border-b border-[#30363d] px-6 py-4">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-3">
                                <button
                                    onClick={() => window.location.href = './index.html'}
                                    className="p-2 hover:bg-[#30363d] rounded-lg transition-colors"
                                >
                                    <Icon name="arrow-left" className="text-[#8b949e]" />
                                </button>
                                <div>
                                    <h1 className="text-xl font-semibold text-[#e6edf3]">Manage Resource Requests</h1>
                                    <p className="text-xs text-[#8b949e]">Review and track resource requests from Google Forms</p>
                                </div>
                            </div>
                            <div className="flex items-center space-x-4">
                                <div className="flex items-center space-x-2">
                                    <span className={`px-2 py-1 rounded-full text-xs border ${getStatusBadgeClass('pending')}`}>
                                        Pending ({statusCounts.pending})
                                    </span>
                                    <span className={`px-2 py-1 rounded-full text-xs border ${getStatusBadgeClass('in-review')}`}>
                                        In Review ({statusCounts['in-review']})
                                    </span>
                                    <span className={`px-2 py-1 rounded-full text-xs border ${getStatusBadgeClass('completed')}`}>
                                        Completed ({statusCounts.completed})
                                    </span>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="p-6">
                        <div className="mb-6">
                            <h2 className="text-lg font-medium text-[#e6edf3] mb-2">
                                Resource Requests ({requestsWithStatus.length})
                            </h2>
                            <p className="text-[#8b949e]">
                                Manage resource requests submitted through Google Forms
                            </p>
                        </div>

                        {requestsWithStatus.length === 0 ? (
                            <div className="text-center py-12 bg-[#161b22] rounded-lg border border-[#30363d]">
                                <Icon name="inbox" className="mx-auto text-[#8b949e] mb-4" size={48} />
                                <h3 className="text-lg font-medium text-[#e6edf3] mb-2">No requests found</h3>
                                <p className="text-[#8b949e]">New requests will appear here when submitted</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {requestsWithStatus.map((request) => (
                                    <div
                                        key={request.id}
                                        className="bg-[#161b22] border border-[#30363d] rounded-lg p-6 hover:border-[#404854] transition-colors"
                                    >
                                        <div className="flex items-start justify-between mb-4">
                                            <div className="flex-1">
                                                <h3 className="text-lg font-medium text-[#e6edf3] mb-2">
                                                    {request.description || 'Untitled Request'}
                                                </h3>
                                                <div className="flex items-center space-x-4 text-sm text-[#8b949e]">
                                                    <span>Topic: {request.topic || 'Not specified'}</span>
                                                    <span>Program: {request.program || 'Not specified'}</span>
                                                    <span>Format: {request.envisionedFormat || 'Not specified'}</span>
                                                </div>
                                            </div>
                                            <div className="flex items-center space-x-3">
                                                <span className={`px-3 py-1 rounded-full text-xs border ${getStatusBadgeClass(request.currentStatus)}`}>
                                                    {request.currentStatus.charAt(0).toUpperCase() + request.currentStatus.slice(1)}
                                                </span>
                                                <select
                                                    value={request.currentStatus}
                                                    onChange={(e) => updateStatus(request.id, e.target.value)}
                                                    className="bg-[#21262d] border border-[#30363d] text-[#e6edf3] text-xs px-2 py-1 rounded"
                                                >
                                                    <option value="pending">Pending</option>
                                                    <option value="in-review">In Review</option>
                                                    <option value="completed">Completed</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label className="block text-xs font-medium text-[#8b949e] mb-1">Purpose</label>
                                                <p className="text-sm text-[#e6edf3]">{request.purpose || 'Not specified'}</p>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-[#8b949e] mb-1">Audience</label>
                                                <p className="text-sm text-[#e6edf3]">{request.audience || 'Not specified'}</p>
                                            </div>
                                        </div>

                                        {request.additionalContext && (
                                            <div className="mb-4">
                                                <label className="block text-xs font-medium text-[#8b949e] mb-1">Additional Context</label>
                                                <p className="text-sm text-[#e6edf3]">{request.additionalContext}</p>
                                            </div>
                                        )}

                                        <div className="flex items-center justify-between text-xs text-[#8b949e]">
                                            <span>Submitted: {new Date(request.timestamp).toLocaleString()}</span>
                                            <span>ID: {request.id}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        // Render the app
        const root = createRoot(document.getElementById('root'));
        root.render(<ManageResourcesApp />);
    </script>
</body>
</html>