<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GovEx Academy Resources</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        * {
            scrollbar-width: thin;
            scrollbar-color: #30363d #0d1117;
        }

        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        *::-webkit-scrollbar-track {
            background: #0d1117;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #30363d;
            border-radius: 4px;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #484f58;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-overlay {
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-[#0d1117] text-[#e6edf3]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // ==========================================
        // GOOGLE SHEETS CONFIGURATION
        // ==========================================
        // STEP 1: Replace these values with your actual credentials:
        // - Get your API_KEY from Google Cloud Console
        // - Get your SHEET_ID from your Google Sheets URL
        // - Adjust the RANGE to match your data location
        //
        // STEP 2: Google Sheets Column Structure (A-N):
        // A: Resource Name | B: Description | C: English Link | D: Spanish Link
        // E: Portuguese Link | F: Italian Link | G: GovEx or External Resource | H: City Shared?
        // I: Topics | J: Programs Used | K: File Type | L: Fillable? | M: Authors | N: Last Updated
        //
        // STEP 3: For File Requests (optional):
        // - Create a separate Google Sheet for file requests
        // - Replace 'YOUR_FILE_REQUESTS_SHEET_ID' below
        // - Headers: Timestamp, Name, Email, Description, Program, Additional Context, Status, Priority
        // ==========================================

        // User authentication data - All accounts have access to enhanced Universal Search
        const USERS = [
            { id: 1, email: "jane.doe@govex.org", password: "demo123", name: "Jane Doe", role: "Program Manager", avatar: "JD" },
            { id: 2, email: "john.smith@govex.org", password: "demo123", name: "John Smith", role: "Data Analyst", avatar: "JS" },
            { id: 3, email: "sarah.miller@govex.org", password: "demo123", name: "Sarah Miller", role: "Research Director", avatar: "SM" },
            { id: 4, email: "admin@govex.org", password: "admin123", name: "Admin User", role: "Administrator", avatar: "AU" },
            { id: 5, email: "admin@govex.com", password: "admin123", name: "Admin User", role: "Administrator", avatar: "AU" },
            { id: 6, email: "test@govex.org", password: "test123", name: "Test User", role: "Analyst", avatar: "TU" },
            { id: 7, email: "demo@govex.org", password: "demo123", name: "Demo User", role: "Coordinator", avatar: "DU" },
            { id: 8, email: "user@govex.org", password: "user123", name: "General User", role: "Researcher", avatar: "GU" },
            { id: 9, email: "manager@govex.org", password: "manager123", name: "Project Manager", role: "Project Manager", avatar: "PM" },
            { id: 10, email: "analyst@govex.org", password: "analyst123", name: "Senior Analyst", role: "Senior Data Analyst", avatar: "SA" }
        ];

        // Mock Database Structure
        const MOCK_DATABASE = {
            programs: [
                {
                    id: 1,
                    name: "Bloomberg City Data Alliance",
                    shortName: "CDA",
                    cohorts: [
                        { id: 1, name: "Cohort 1", active: false },
                        { id: 2, name: "Cohort 2", active: false },
                        { id: 3, name: "Cohort 3", active: false },
                        { id: 4, name: "Cohort 4", active: true }
                    ],
                    color: "#3b82f6"
                },
                {
                    id: 2,
                    name: "Bloomberg Harvard City Leadership Initiative Data Track",
                    shortName: "BHCLI",
                    cohorts: [
                        { id: 7, name: "Cohort 7", active: false },
                        { id: 8, name: "Cohort 8", active: false },
                        { id: 9, name: "Cohort 9", active: true }
                    ],
                    color: "#8b5cf6"
                },
                {
                    id: 3,
                    name: "What Works Cities Sprints",
                    shortName: "WWC",
                    cohorts: [
                        { id: 1, name: "Sprint 1", active: false },
                        { id: 2, name: "Sprint 2", active: true },
                        { id: 3, name: "Sprint 3", active: false }
                    ],
                    color: "#10b981"
                },
                {
                    id: 4,
                    name: "AI Courses",
                    shortName: "AI",
                    cohorts: [
                        { id: 1, name: "Cohort 1", active: true },
                        { id: 2, name: "Cohort 2", active: false }
                    ],
                    color: "#f59e0b"
                },
                {
                    id: 5,
                    name: "Self-Guided Courses",
                    shortName: "SGC",
                    cohorts: [
                        { id: 1, name: "All Sessions", active: true }
                    ],
                    color: "#ef4444"
                }
            ],
            resources: [
                {
                    id: 1,
                    resourceName: "A-to-Z Master Inventory",
                    englishLink: "https://docs.google.com/spreadsheets/d/abc123/edit",
                    spanishLink: "https://docs.google.com/spreadsheets/d/abc124/edit",
                    portugueseLink: null,
                    italianLink: null,
                    govexOrExternal: "GovEx",
                    topics: ["Data Inventory", "Data Management", "Data Quality"],
                    programsUsed: ["CDA3", "CDA4", "BH9"],
                    fileType: ".xlsx",
                    fillable: true,
                    authors: ["Laila", "Jacquie"],
                    lastUpdated: "2024-09-28",
                    description: "A comprehensive inventory of all available resources for data management and analysis",
                    version: "v2.1",
                    createdYear: 2024,
                    isFavorite: false
                },
                {
                    id: 2,
                    resourceName: "Project Proposal Template",
                    englishLink: "https://docs.google.com/document/d/xyz789/edit",
                    spanishLink: null,
                    portugueseLink: null,
                    italianLink: null,
                    govexOrExternal: "GovEx",
                    topics: ["Capacity Building", "Internal Culture"],
                    programsUsed: ["BH9", "WWC"],
                    fileType: ".docx",
                    fillable: true,
                    authors: ["Sarah", "Michael"],
                    lastUpdated: "2024-07-20",
                    description: "Standardized template for submitting data project proposals with evaluation criteria",
                    version: "v1.3",
                    createdYear: 2024,
                    isFavorite: true
                },
                {
                    id: 3,
                    resourceName: "Data Ethics Framework",
                    englishLink: "https://docs.google.com/document/d/def456/edit",
                    spanishLink: "https://docs.google.com/document/d/def457/edit",
                    portugueseLink: "https://docs.google.com/document/d/def458/edit",
                    italianLink: null,
                    govexOrExternal: "External",
                    topics: ["Data Quality", "Transparency", "External Stakeholders"],
                    programsUsed: ["WWC", "AI1"],
                    fileType: ".pdf",
                    fillable: false,
                    authors: ["External Partner"],
                    lastUpdated: "2024-06-10",
                    description: "Guidelines and best practices for ethical data collection and usage",
                    version: "v3.0",
                    createdYear: 2024,
                    isFavorite: false
                },
                {
                    id: 4,
                    resourceName: "AI Implementation Roadmap",
                    englishLink: "https://docs.google.com/presentation/d/ghi123/edit",
                    spanishLink: null,
                    portugueseLink: null,
                    italianLink: null,
                    govexOrExternal: "GovEx",
                    topics: ["Capacity Building", "Internal Culture", "Data Management"],
                    programsUsed: ["AI1", "AI2"],
                    fileType: ".pptx",
                    fillable: false,
                    authors: ["Chris", "Emily"],
                    lastUpdated: "2024-08-01",
                    description: "Step-by-step guide for implementing AI solutions in city government",
                    version: "v1.0",
                    createdYear: 2024,
                    isFavorite: true
                },
                {
                    id: 5,
                    resourceName: "Data Visualization Best Practices",
                    englishLink: "https://example.com/video/dataviz",
                    spanishLink: "https://example.com/video/dataviz-es",
                    portugueseLink: null,
                    italianLink: null,
                    govexOrExternal: "External",
                    topics: ["Data Quality", "Transparency"],
                    programsUsed: ["CDA3", "CDA4"],
                    fileType: ".html",
                    fillable: false,
                    authors: ["External Expert"],
                    lastUpdated: "2024-05-22",
                    description: "Video tutorial covering effective data visualization techniques and tools",
                    version: "v2.0",
                    createdYear: 2023,
                    isFavorite: false
                },
                {
                    id: 6,
                    resourceName: "Performance Metrics Dashboard",
                    englishLink: "https://docs.google.com/spreadsheets/d/jkl456/edit",
                    spanishLink: null,
                    portugueseLink: null,
                    italianLink: null,
                    govexOrExternal: "GovEx",
                    topics: ["Data Inventory", "Transparency", "External Stakeholders"],
                    programsUsed: ["SGC"],
                    fileType: ".xlsx",
                    fillable: true,
                    authors: ["Laila", "Chris"],
                    lastUpdated: "2024-07-15",
                    description: "Interactive dashboard template for tracking city performance metrics",
                    version: "v1.5",
                    createdYear: 2024,
                    isFavorite: true
                },
                {
                    id: 7,
                    resourceName: "Open Data Policy Framework",
                    englishLink: "https://docs.google.com/document/d/mno789/edit",
                    spanishLink: "https://docs.google.com/document/d/mno790/edit",
                    portugueseLink: null,
                    italianLink: "https://docs.google.com/document/d/mno791/edit",
                    govexOrExternal: "GovEx",
                    topics: ["Transparency", "External Stakeholders", "Data Management"],
                    programsUsed: ["WWC", "BH9"],
                    fileType: ".pdf",
                    fillable: false,
                    authors: ["Sarah", "Jacquie"],
                    lastUpdated: "2024-04-30",
                    description: "Comprehensive framework for developing and implementing open data policies",
                    version: "v2.2",
                    createdYear: 2023,
                    isFavorite: false
                },
                {
                    id: 8,
                    resourceName: "Machine Learning Fundamentals",
                    englishLink: "https://docs.google.com/presentation/d/pqr123/edit",
                    spanishLink: null,
                    portugueseLink: null,
                    italianLink: null,
                    govexOrExternal: "External",
                    topics: ["Capacity Building", "Data Quality"],
                    programsUsed: ["AI1", "AI2", "CDA4"],
                    fileType: ".pptx",
                    fillable: false,
                    authors: ["External Expert", "University Partner"],
                    lastUpdated: "2024-06-25",
                    description: "Introduction to machine learning concepts for government applications",
                    version: "v1.1",
                    createdYear: 2024,
                    isFavorite: false
                },
                {
                    id: 9,
                    resourceName: "Data Governance Handbook",
                    englishLink: "https://docs.google.com/document/d/stu456/edit",
                    spanishLink: "https://docs.google.com/document/d/stu457/edit",
                    portugueseLink: "https://docs.google.com/document/d/stu458/edit",
                    italianLink: "https://docs.google.com/document/d/stu459/edit",
                    govexOrExternal: "GovEx",
                    topics: ["Data Management", "Internal Culture", "Capacity Building"],
                    programsUsed: ["BH7", "BH8", "BH9"],
                    fileType: ".pdf",
                    fillable: false,
                    authors: ["Michael", "Emily"],
                    lastUpdated: "2024-03-28",
                    description: "Essential guide for establishing data governance structures in city departments",
                    version: "v3.1",
                    createdYear: 2023,
                    isFavorite: true
                },
                {
                    id: 10,
                    resourceName: "Community Engagement Toolkit",
                    englishLink: "https://docs.google.com/spreadsheets/d/vwx789/edit",
                    spanishLink: "https://docs.google.com/spreadsheets/d/vwx790/edit",
                    portugueseLink: null,
                    italianLink: null,
                    govexOrExternal: "GovEx",
                    topics: ["External Stakeholders", "Transparency", "Capacity Building"],
                    programsUsed: ["CDA3", "CDA4", "WWC"],
                    fileType: ".xlsx",
                    fillable: true,
                    authors: ["Laila", "Sarah"],
                    lastUpdated: "2024-08-10",
                    description: "Tools and strategies for engaging communities in data-driven decision making",
                    version: "v1.8",
                    createdYear: 2024,
                    isFavorite: false
                },
                {
                    id: 11,
                    resourceName: "Budget Analysis Workshop Materials",
                    englishLink: "https://example.com/workshop/budget",
                    spanishLink: null,
                    portugueseLink: null,
                    italianLink: null,
                    govexOrExternal: "External",
                    topics: ["Capacity Building", "Data Management"],
                    programsUsed: ["BH7", "BH8"],
                    fileType: ".html",
                    fillable: false,
                    authors: ["Workshop Provider"],
                    lastUpdated: "2024-07-05",
                    description: "Interactive workshop materials for analyzing and optimizing city budgets",
                    version: "v2.3",
                    createdYear: 2024,
                    isFavorite: false
                },
                {
                    id: 12,
                    resourceName: "Data Privacy Compliance Checklist",
                    englishLink: "https://docs.google.com/document/d/abc999/edit",
                    spanishLink: "https://docs.google.com/document/d/abc998/edit",
                    portugueseLink: "https://docs.google.com/document/d/abc997/edit",
                    italianLink: null,
                    govexOrExternal: "GovEx",
                    topics: ["Data Quality", "Internal Culture", "Transparency"],
                    programsUsed: ["SGC", "AI1"],
                    fileType: ".docx",
                    fillable: true,
                    authors: ["Chris", "Jacquie"],
                    lastUpdated: "2024-08-15",
                    description: "Comprehensive checklist for data privacy regulations and compliance requirements",
                    version: "v1.2",
                    createdYear: 2024,
                    isFavorite: true
                }
            ],
            fileRequests: [
                {
                    id: 1,
                    description: "Guide on advanced data analysis techniques",
                    program: "Bloomberg City Data Alliance",
                    cohort: "Cohort 4",
                    status: "In Review",
                    dateSubmitted: "2024-07-26",
                    requestedBy: "John Smith",
                    assignedTo: "Laila",
                    notes: "Working on creating comprehensive guide",
                    expectedCompletion: "2024-08-15",
                    additionalContext: "Need practical examples and case studies for municipal data analysis"
                },
                {
                    id: 2,
                    description: "Template for citizen feedback collection",
                    program: "What Works Cities Sprints",
                    cohort: "Sprint 2",
                    status: "Open",
                    dateSubmitted: "2024-08-01",
                    requestedBy: "Emily Davis",
                    assignedTo: null,
                    notes: null,
                    expectedCompletion: null,
                    additionalContext: "Should include both digital and paper-based feedback mechanisms"
                },
                {
                    id: 3,
                    description: "Video tutorial on GIS mapping for beginners",
                    program: "Bloomberg Harvard City Leadership Initiative Data Track",
                    cohort: "Cohort 9",
                    status: "Completed",
                    dateSubmitted: "2024-07-15",
                    requestedBy: "Michael Chen",
                    assignedTo: "Chris",
                    notes: "Video completed and uploaded to resource library",
                    expectedCompletion: "2024-07-30",
                    additionalContext: "Focus on QGIS and ArcGIS basics for city planners"
                },
                {
                    id: 4,
                    description: "Best practices for AI ethics in government",
                    program: "AI Courses",
                    cohort: "Cohort 1",
                    status: "In Review",
                    dateSubmitted: "2024-08-05",
                    requestedBy: "Sarah Miller",
                    assignedTo: "Emily",
                    notes: "Research phase completed, drafting document",
                    expectedCompletion: "2024-08-20",
                    additionalContext: "Include case studies from other cities and legal considerations"
                },
                {
                    id: 5,
                    description: "Gap: Missing budget analysis tools for small cities",
                    program: "Self-Guided Courses",
                    cohort: "All Sessions",
                    status: "Open",
                    dateSubmitted: "2024-08-10",
                    requestedBy: "Jane Doe",
                    assignedTo: null,
                    notes: null,
                    expectedCompletion: null,
                    additionalContext: "Current resources focus on large cities, need tools for municipalities under 50k population"
                },
                {
                    id: 6,
                    description: "Data visualization checklist for presentations",
                    program: "Bloomberg City Data Alliance",
                    cohort: "Cohort 3",
                    status: "Rejected",
                    dateSubmitted: "2024-07-20",
                    requestedBy: "Alex Johnson",
                    assignedTo: "Jacquie",
                    notes: "Similar resource already exists in the database",
                    expectedCompletion: null,
                    additionalContext: "Quick reference guide for creating effective charts and graphs"
                }
            ],
            recentActivity: [
                {
                    id: 1,
                    type: "request_update",
                    resource: "Advanced Data Analysis Guide",
                    requestId: 1,
                    user: "Laila",
                    timestamp: "2 hours ago",
                    description: "File request moved to In Review"
                },
                {
                    id: 2,
                    type: "update",
                    resource: "Data Privacy Compliance Guide",
                    programId: 5,
                    cohortId: 1,
                    user: "Sarah Miller",
                    timestamp: "4 hours ago",
                    description: "Document updated"
                },
                {
                    id: 3,
                    type: "request_completed",
                    resource: "GIS Mapping Tutorial",
                    requestId: 3,
                    user: "Chris",
                    timestamp: "Today",
                    description: "File request completed and published"
                },
                {
                    id: 4,
                    type: "new",
                    resource: "Community Engagement Toolkit",
                    programId: 1,
                    cohortId: 4,
                    user: "John Smith",
                    timestamp: "Yesterday",
                    description: "New resource added"
                },
                {
                    id: 5,
                    type: "request_new",
                    resource: "Budget Analysis Tools",
                    requestId: 5,
                    user: "Jane Doe",
                    timestamp: "Yesterday",
                    description: "New gap identification submitted"
                }
            ]
        };

        // Bulk User Upload Configuration
        const bulkUserUploadConfig = {
            maxRows: 10000,
            batchSize: 100,
            allowedDomains: [], // e.g., ["city.gov", "partner.org"]
            blockUnknownDomains: false,
            defaultRole: "Researcher",
            featureFlag: "enableBulkUserUpload",
            inviteEmailsDefault: true,
            supportedFileTypes: ['.csv', '.xlsx'],
            maxFileSize: 10 * 1024 * 1024 // 10MB
        };

        // Mock data for bulk upload testing
        const mockExistingUsers = ['john.smith@govex.org', 'jane.doe@govex.org', 'admin@govex.org', 'admin@govex.com'];

        const availableRoles = ['Administrator', 'Program Manager', 'Data Analyst', 'Research Director', 'Analyst', 'Coordinator', 'Researcher', 'Project Manager', 'Senior Data Analyst'];

        // ==========================================
        // NOTIFICATION & REPORTING SYSTEM DATA MODEL
        // ==========================================

        // Feature flag for notifications system
        const NOTIFICATIONS_V1_ENABLED = true;

        // Role permissions mapping with reporting frequency controls
        const ROLE_PERMISSIONS = {
            'Administrator': {
                level: 'admin',
                canViewAll: true,
                canManagePrograms: true,
                canSendAsNeeded: true,
                allowedFrequencies: ['weekly', 'monthly', 'quarterly', 'yearly', 'as_needed'],
                defaultFrequencies: ['weekly', 'as_needed'],
                maxReports: 'unlimited',
                canManageRoleSettings: true
            },
            'Program Manager': {
                level: 'manager',
                canViewAll: false,
                canManagePrograms: true,
                canSendAsNeeded: true,
                allowedFrequencies: ['weekly', 'monthly', 'quarterly', 'as_needed'],
                defaultFrequencies: ['weekly', 'as_needed'],
                maxReports: 10,
                canManageRoleSettings: false
            },
            'Project Manager': {
                level: 'manager',
                canViewAll: false,
                canManagePrograms: true,
                canSendAsNeeded: true,
                allowedFrequencies: ['weekly', 'monthly', 'quarterly', 'as_needed'],
                defaultFrequencies: ['weekly', 'as_needed'],
                maxReports: 10,
                canManageRoleSettings: false
            },
            'Research Director': {
                level: 'manager',
                canViewAll: false,
                canManagePrograms: true,
                canSendAsNeeded: true,
                allowedFrequencies: ['weekly', 'monthly', 'quarterly', 'yearly', 'as_needed'],
                defaultFrequencies: ['weekly', 'monthly', 'as_needed'],
                maxReports: 15,
                canManageRoleSettings: false
            },
            'Data Analyst': {
                level: 'user',
                canViewAll: false,
                canManagePrograms: false,
                canSendAsNeeded: false,
                allowedFrequencies: ['weekly', 'monthly'],
                defaultFrequencies: ['weekly'],
                maxReports: 5,
                canManageRoleSettings: false
            },
            'Senior Data Analyst': {
                level: 'user',
                canViewAll: false,
                canManagePrograms: false,
                canSendAsNeeded: false,
                allowedFrequencies: ['weekly', 'monthly', 'quarterly'],
                defaultFrequencies: ['weekly', 'monthly'],
                maxReports: 8,
                canManageRoleSettings: false
            },
            'Analyst': {
                level: 'user',
                canViewAll: false,
                canManagePrograms: false,
                canSendAsNeeded: false,
                allowedFrequencies: ['weekly', 'monthly'],
                defaultFrequencies: ['weekly'],
                maxReports: 3,
                canManageRoleSettings: false
            },
            'Coordinator': {
                level: 'user',
                canViewAll: false,
                canManagePrograms: false,
                canSendAsNeeded: false,
                allowedFrequencies: ['weekly', 'monthly'],
                defaultFrequencies: ['weekly'],
                maxReports: 5,
                canManageRoleSettings: false
            },
            'Researcher': {
                level: 'user',
                canViewAll: false,
                canManagePrograms: false,
                canSendAsNeeded: false,
                allowedFrequencies: ['weekly'],
                defaultFrequencies: ['weekly'],
                maxReports: 2,
                canManageRoleSettings: false
            }
        };

        // Default notification preferences
        const DEFAULT_NOTIFICATION_PREFERENCES = {
            weekly: { enabled: true, day: 1, time: '09:00' }, // Monday 9 AM
            monthly: { enabled: false, day: 1, time: '09:00' }, // First of month
            quarterly: { enabled: false, day: 1, time: '09:00' },
            yearly: { enabled: false, day: 1, time: '09:00' },
            as_needed: { enabled: true },
            channels: ['email', 'in_app'],
            timezone: 'America/New_York'
        };

        // Extended database structure for notifications
        const NOTIFICATION_DATABASE = {
            // Notification preferences per user per program
            notificationPreferences: [
                // Example: User 1 (Jane Doe - Program Manager) preferences
                {
                    userId: 1,
                    programId: 1, // CDA
                    cadence: 'weekly',
                    enabled: true,
                    channels: ['email', 'in_app'],
                    digestDayOfWeek: 1, // Monday
                    digestTime: '09:00',
                    timezone: 'America/New_York'
                },
                {
                    userId: 1,
                    programId: 1,
                    cadence: 'as_needed',
                    enabled: true,
                    channels: ['email', 'in_app'],
                    timezone: 'America/New_York'
                }
            ],

            // Report schedules
            reportSchedules: [
                {
                    id: 1,
                    userId: 4, // Admin
                    scope: 'ALL',
                    programIds: [],
                    cadence: 'weekly',
                    nextRunAt: new Date('2024-10-28T09:00:00-04:00'),
                    timezone: 'America/New_York',
                    enabled: true,
                    createdAt: new Date('2024-10-01T09:00:00-04:00')
                }
            ],

            // Notification events (change capture)
            notificationEvents: [
                {
                    id: 1,
                    resourceId: 1,
                    changeType: 'updated',
                    occurredAt: new Date('2024-10-23T14:30:00-04:00'),
                    tagIds: [1, 2], // Data Inventory, Data Management
                    programIds: [1, 2], // CDA, BHCLI
                    userId: 3, // Sarah Miller
                    details: 'Resource updated: A-to-Z Master Inventory'
                },
                {
                    id: 2,
                    resourceId: 2, // Project Proposal Template
                    changeType: 'created',
                    occurredAt: new Date('2024-10-23T10:15:00-04:00'),
                    tagIds: [3], // Data Quality
                    programIds: [2], // BHCLI
                    userId: 1, // Jane Doe
                    details: 'New resource added: Project Proposal Template'
                },
                {
                    id: 3,
                    resourceId: 4, // AI Implementation Roadmap
                    changeType: 'updated',
                    occurredAt: new Date('2024-10-23T09:45:00-04:00'),
                    tagIds: [4], // Capacity Building
                    programIds: [4], // AI
                    userId: 2, // John Smith
                    details: 'Resource updated: AI Implementation Roadmap'
                },
                {
                    id: 4,
                    resourceId: 6, // Performance Metrics Dashboard
                    changeType: 'as_needed',
                    occurredAt: new Date('2024-10-23T16:20:00-04:00'),
                    tagIds: [1, 5], // Data Inventory, Transparency
                    programIds: [5], // SGC
                    userId: 3, // Sarah Miller
                    details: 'Urgent: Performance Metrics Dashboard requires immediate attention'
                },
                {
                    id: 5,
                    resourceId: 7, // Open Data Policy Framework
                    changeType: 'updated',
                    occurredAt: new Date('2024-10-22T11:30:00-04:00'),
                    tagIds: [5, 6], // Transparency, External Stakeholders
                    programIds: [3], // WWC
                    userId: 1, // Jane Doe
                    details: 'Resource updated: Open Data Policy Framework'
                }
            ],

            // Generated digests (materialized for history)
            digests: [
                {
                    id: 1,
                    userId: 1,
                    cadence: 'weekly',
                    windowStart: new Date('2024-10-14T00:00:00-04:00'),
                    windowEnd: new Date('2024-10-21T23:59:59-04:00'),
                    programIds: [1, 2],
                    itemCount: 3,
                    generatedAt: new Date('2024-10-21T09:00:00-04:00'),
                    events: [1, 2]
                }
            ],

            // Delivery log
            deliveryLog: [
                {
                    id: 1,
                    userId: 1,
                    digestId: 1,
                    channel: 'email',
                    status: 'sent',
                    sentAt: new Date('2024-10-21T09:05:00-04:00'),
                    details: 'Weekly digest delivered successfully'
                }
            ],

            // Role-based reporting configuration (admin customizable)
            roleReportingConfig: {
                'Administrator': {
                    allowedFrequencies: ['weekly', 'monthly', 'quarterly', 'yearly', 'as_needed'],
                    maxConcurrentReports: 'unlimited',
                    reportRetentionDays: 365,
                    canScheduleCustomReports: true
                },
                'Program Manager': {
                    allowedFrequencies: ['weekly', 'monthly', 'quarterly', 'as_needed'],
                    maxConcurrentReports: 10,
                    reportRetentionDays: 180,
                    canScheduleCustomReports: true
                },
                'Project Manager': {
                    allowedFrequencies: ['weekly', 'monthly', 'quarterly', 'as_needed'],
                    maxConcurrentReports: 10,
                    reportRetentionDays: 180,
                    canScheduleCustomReports: true
                },
                'Research Director': {
                    allowedFrequencies: ['weekly', 'monthly', 'quarterly', 'yearly', 'as_needed'],
                    maxConcurrentReports: 15,
                    reportRetentionDays: 270,
                    canScheduleCustomReports: true
                },
                'Data Analyst': {
                    allowedFrequencies: ['weekly', 'monthly'],
                    maxConcurrentReports: 5,
                    reportRetentionDays: 90,
                    canScheduleCustomReports: false
                },
                'Senior Data Analyst': {
                    allowedFrequencies: ['weekly', 'monthly', 'quarterly'],
                    maxConcurrentReports: 8,
                    reportRetentionDays: 120,
                    canScheduleCustomReports: false
                },
                'Analyst': {
                    allowedFrequencies: ['weekly', 'monthly'],
                    maxConcurrentReports: 3,
                    reportRetentionDays: 60,
                    canScheduleCustomReports: false
                },
                'Coordinator': {
                    allowedFrequencies: ['weekly', 'monthly'],
                    maxConcurrentReports: 5,
                    reportRetentionDays: 90,
                    canScheduleCustomReports: false
                },
                'Researcher': {
                    allowedFrequencies: ['weekly'],
                    maxConcurrentReports: 2,
                    reportRetentionDays: 30,
                    canScheduleCustomReports: false
                }
            },

            // Program-user associations (who has access to which programs)
            programMemberships: [
                { userId: 1, programId: 1, role: 'manager' }, // Jane Doe - CDA
                { userId: 1, programId: 2, role: 'manager' }, // Jane Doe - BHCLI
                { userId: 2, programId: 1, role: 'member' }, // John Smith - CDA
                { userId: 3, programId: 3, role: 'manager' }, // Sarah Miller - WWC
                { userId: 4, programId: 1, role: 'admin' }, // Admin - All
                { userId: 4, programId: 2, role: 'admin' },
                { userId: 4, programId: 3, role: 'admin' },
                { userId: 4, programId: 4, role: 'admin' },
                { userId: 4, programId: 5, role: 'admin' },
                { userId: 5, programId: 1, role: 'admin' }, // Admin User (.com) - All
                { userId: 5, programId: 2, role: 'admin' },
                { userId: 5, programId: 3, role: 'admin' },
                { userId: 5, programId: 4, role: 'admin' },
                { userId: 5, programId: 5, role: 'admin' },
                { userId: 6, programId: 1, role: 'member' }, // Test User - CDA
                { userId: 6, programId: 4, role: 'member' }, // Test User - AI
                { userId: 7, programId: 2, role: 'member' }, // Demo User - BHCLI
                { userId: 7, programId: 5, role: 'member' }, // Demo User - SGC
                { userId: 8, programId: 3, role: 'member' }, // General User - WWC
                { userId: 9, programId: 1, role: 'manager' }, // Project Manager - CDA
                { userId: 9, programId: 2, role: 'manager' }, // Project Manager - BHCLI
                { userId: 10, programId: 4, role: 'member' }, // Senior Analyst - AI
                { userId: 10, programId: 5, role: 'member' }, // Senior Analyst - SGC
            ]
        };

        // ==========================================
        // NOTIFICATION SYSTEM SERVICES & HELPERS
        // ==========================================

        // Notification service functions
        const NotificationService = {
            // Get user's role permissions
            getUserPermissions(user) {
                return ROLE_PERMISSIONS[user?.role] || ROLE_PERMISSIONS['Researcher'];
            },

            // Get role-based reporting configuration
            getRoleReportingConfig(role) {
                return NOTIFICATION_DATABASE.roleReportingConfig[role] || NOTIFICATION_DATABASE.roleReportingConfig['Researcher'];
            },

            // Check if user can access a specific frequency
            canUserAccessFrequency(user, frequency) {
                const roleConfig = this.getRoleReportingConfig(user.role);
                return roleConfig.allowedFrequencies.includes(frequency);
            },

            // Get allowed frequencies for user's role
            getAllowedFrequenciesForUser(user) {
                const roleConfig = this.getRoleReportingConfig(user.role);
                return roleConfig.allowedFrequencies;
            },

            // Check if user has reached max concurrent reports
            hasReachedMaxReports(userId) {
                const user = USERS.find(u => u.id === userId);
                if (!user) return true;

                const roleConfig = this.getRoleReportingConfig(user.role);
                if (roleConfig.maxConcurrentReports === 'unlimited') return false;

                const userReports = NOTIFICATION_DATABASE.reportSchedules.filter(r => r.userId === userId && r.enabled);
                return userReports.length >= roleConfig.maxConcurrentReports;
            },

            // Admin function: Update role reporting configuration
            updateRoleReportingConfig(role, config) {
                if (!NOTIFICATION_DATABASE.roleReportingConfig[role]) return false;
                NOTIFICATION_DATABASE.roleReportingConfig[role] = { ...NOTIFICATION_DATABASE.roleReportingConfig[role], ...config };
                return true;
            },

            // Admin function: Get all role configurations
            getAllRoleConfigurations() {
                return NOTIFICATION_DATABASE.roleReportingConfig;
            },

            // Get programs user has access to
            getUserPrograms(userId) {
                console.log('NotificationService.getUserPrograms called', { userId, NOTIFICATIONS_V1_ENABLED });
                if (!NOTIFICATIONS_V1_ENABLED) return [];

                const memberships = NOTIFICATION_DATABASE.programMemberships.filter(m => m.userId === userId);
                console.log('Found memberships for user', { userId, memberships });

                const programs = memberships.map(m => ({
                    ...MOCK_DATABASE.programs.find(p => p.id === m.programId),
                    membershipRole: m.role
                })).filter(Boolean);

                console.log('Mapped programs for user', { userId, programs });
                return programs;
            },

            // Get user's notification preferences for a program
            getUserPreferences(userId, programId) {
                const prefs = NOTIFICATION_DATABASE.notificationPreferences.filter(
                    p => p.userId === userId && p.programId === programId
                );

                if (prefs.length === 0) {
                    return this.createDefaultPreferences(userId, programId);
                }

                return prefs.reduce((acc, pref) => {
                    acc[pref.cadence] = pref;
                    return acc;
                }, {});
            },

            // Create default preferences for a user-program combination
            createDefaultPreferences(userId, programId) {
                const defaults = {};
                Object.entries(DEFAULT_NOTIFICATION_PREFERENCES).forEach(([cadence, config]) => {
                    if (typeof config === 'object' && config.enabled !== undefined) {
                        defaults[cadence] = {
                            userId,
                            programId,
                            cadence,
                            enabled: config.enabled,
                            channels: DEFAULT_NOTIFICATION_PREFERENCES.channels,
                            digestDayOfWeek: config.day,
                            digestTime: config.time,
                            timezone: DEFAULT_NOTIFICATION_PREFERENCES.timezone
                        };
                    }
                });
                return defaults;
            },

            // Save user preferences
            saveUserPreferences(userId, programId, preferences) {
                // Remove existing preferences for this user-program
                NOTIFICATION_DATABASE.notificationPreferences =
                    NOTIFICATION_DATABASE.notificationPreferences.filter(
                        p => !(p.userId === userId && p.programId === programId)
                    );

                // Add new preferences
                Object.values(preferences).forEach(pref => {
                    if (pref.enabled) {
                        NOTIFICATION_DATABASE.notificationPreferences.push(pref);
                    }
                });

                return true;
            },

            // Enable notifications with default settings
            enableNotificationsForUser(userId) {
                const userPrograms = this.getUserPrograms(userId);
                let created = 0;

                userPrograms.forEach(program => {
                    const existingPrefs = this.getUserPreferences(userId, program.id);
                    if (Object.keys(existingPrefs).length === 0) {
                        const defaultPrefs = this.createDefaultPreferences(userId, program.id);
                        this.saveUserPreferences(userId, program.id, defaultPrefs);
                        created++;
                    }
                });

                return { success: true, programsConfigured: created };
            },

            // Capture resource change event
            captureResourceChange(resourceId, changeType, userId, details = '') {
                const resource = MOCK_DATABASE.resources.find(r => r.id === resourceId);
                if (!resource) return null;

                // Map topics to tag IDs (simplified)
                const tagIds = resource.topics ? resource.topics.map((_, index) => index + 1) : [];

                // Map programs used to program IDs
                const programIds = this.mapProgramsUsedToIds(resource.programsUsed || []);

                const event = {
                    id: NOTIFICATION_DATABASE.notificationEvents.length + 1,
                    resourceId,
                    changeType,
                    occurredAt: new Date(),
                    tagIds,
                    programIds,
                    userId,
                    details: details || `Resource ${changeType}: ${resource.resourceName}`
                };

                NOTIFICATION_DATABASE.notificationEvents.push(event);

                // Trigger as-needed notifications if applicable
                if (changeType === 'created' || changeType === 'as_needed') {
                    this.triggerAsNeededNotifications(event);
                }

                return event;
            },

            // Map program codes to IDs
            mapProgramsUsedToIds(programsUsed) {
                const mapping = {
                    'CDA1': 1, 'CDA2': 1, 'CDA3': 1, 'CDA4': 1,
                    'BH7': 2, 'BH8': 2, 'BH9': 2, 'BHCLI': 2,
                    'WWC': 3,
                    'AI1': 4, 'AI2': 4,
                    'SGC': 5
                };

                return [...new Set(programsUsed.map(p => mapping[p]).filter(Boolean))];
            },

            // Trigger immediate as-needed notifications
            triggerAsNeededNotifications(event) {
                // Find users who should receive as-needed notifications for these programs
                const targetUsers = NOTIFICATION_DATABASE.notificationPreferences.filter(pref =>
                    pref.cadence === 'as_needed' &&
                    pref.enabled &&
                    event.programIds.includes(pref.programId)
                );

                targetUsers.forEach(pref => {
                    this.deliverNotification(pref.userId, 'as_needed', [event], 'immediate');
                });
            },

            // Generate weekly digest for a user
            generateWeeklyDigest(userId) {
                const userPrograms = this.getUserPrograms(userId);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);

                const relevantEvents = NOTIFICATION_DATABASE.notificationEvents.filter(event =>
                    event.occurredAt >= weekAgo &&
                    event.programIds.some(pid => userPrograms.some(p => p.id === pid))
                );

                if (relevantEvents.length === 0) return null;

                const digest = {
                    id: NOTIFICATION_DATABASE.digests.length + 1,
                    userId,
                    cadence: 'weekly',
                    windowStart: weekAgo,
                    windowEnd: new Date(),
                    programIds: userPrograms.map(p => p.id),
                    itemCount: relevantEvents.length,
                    generatedAt: new Date(),
                    events: relevantEvents.map(e => e.id)
                };

                NOTIFICATION_DATABASE.digests.push(digest);
                return digest;
            },

            // Deliver notification via specified channels
            deliverNotification(userId, type, events, priority = 'normal') {
                const user = USERS.find(u => u.id === userId);
                if (!user) return false;

                const deliveryRecord = {
                    id: NOTIFICATION_DATABASE.deliveryLog.length + 1,
                    userId,
                    type,
                    channel: 'in_app', // Primary channel for demo
                    status: 'sent',
                    sentAt: new Date(),
                    details: `${type} notification with ${events.length} item(s)`,
                    events: events.map(e => e.id || e)
                };

                NOTIFICATION_DATABASE.deliveryLog.push(deliveryRecord);
                return deliveryRecord;
            },

            // Get notifications for user (for bell dropdown and notifications page)
            getUserNotifications(userId, since = null) {
                const userPrograms = this.getUserPrograms(userId);
                const programIds = userPrograms.map(p => p.id);

                let events = NOTIFICATION_DATABASE.notificationEvents.filter(event =>
                    event.programIds.some(pid => programIds.includes(pid))
                );

                if (since) {
                    events = events.filter(event => event.occurredAt >= since);
                }

                // Group by cadence/timeframe
                const grouped = {
                    as_needed: events.filter(e => e.changeType === 'as_needed'),
                    this_week: events.filter(e => {
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return e.occurredAt >= weekAgo && e.changeType !== 'as_needed';
                    }),
                    older: events.filter(e => {
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return e.occurredAt < weekAgo && e.changeType !== 'as_needed';
                    })
                };

                return grouped;
            }
        };

        // Bulk Upload Helper Functions
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email.toLowerCase().trim());
        }

        function normalizeEmail(email) {
            return email.toLowerCase().trim();
        }

        function validateDomain(email, allowedDomains) {
            if (!allowedDomains || allowedDomains.length === 0) return true;
            const domain = email.split('@')[1];
            return allowedDomains.includes(domain);
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 2) throw new Error('CSV must have at least a header row and one data row');

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                rows.push(row);
            }

            return { headers, rows };
        }

        async function parseSpreadsheet(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const result = parseCSV(text);
                        resolve(result);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        async function previewImport(rows, mapping, config) {
            await new Promise(resolve => setTimeout(resolve, 500)); // Simulate API delay

            const previews = [];
            const emailsSeen = new Set();

            for (const row of rows) {
                const email = normalizeEmail(row[mapping.email] || '');
                const firstName = row[mapping.firstName] || '';
                const lastName = row[mapping.lastName] || '';
                const role = row[mapping.role] || config.defaultRole;
                const department = row[mapping.department] || '';
                const notes = row[mapping.notes] || '';

                let status = 'ready';
                let error = '';

                // Validate email
                if (!email) {
                    status = 'invalid_email';
                    error = 'Email is required';
                } else if (!validateEmail(email)) {
                    status = 'invalid_email';
                    error = 'Invalid email format';
                } else if (emailsSeen.has(email)) {
                    status = 'duplicate_in_file';
                    error = 'Duplicate email in file';
                } else if (mockExistingUsers.includes(email)) {
                    status = 'already_exists';
                    error = 'User already exists';
                } else if (bulkUserUploadConfig.allowedDomains.length > 0 && !validateDomain(email, bulkUserUploadConfig.allowedDomains)) {
                    status = 'disallowed_domain';
                    error = 'Domain not allowed';
                } else if (!availableRoles.includes(role)) {
                    status = 'invalid_role';
                    error = `Invalid role: ${role}`;
                }

                emailsSeen.add(email);

                previews.push({
                    email,
                    firstName,
                    lastName,
                    role,
                    department,
                    notes,
                    status,
                    error
                });
            }

            return previews;
        }

        async function runUserImport(payload) {
            await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate processing time

            const result = {
                importId: Date.now().toString(),
                created: 0,
                invited: 0,
                skipped: 0,
                errors: [],
                processed: 0,
                total: payload.rows.length,
                queued: false
            };

            for (const row of payload.rows) {
                result.processed++;

                if (payload.dryRun) {
                    // Dry run - just count what would happen
                    if (validateEmail(row.email) && !mockExistingUsers.includes(normalizeEmail(row.email))) {
                        result.created++;
                        if (payload.sendInviteEmails) {
                            result.invited++;
                        }
                    } else {
                        result.skipped++;
                    }
                } else {
                    // Real run - would actually create users
                    if (validateEmail(row.email) && !mockExistingUsers.includes(normalizeEmail(row.email))) {
                        // In real implementation, would create user here
                        result.created++;
                        if (payload.sendInviteEmails) {
                            result.invited++;
                        }
                        // Add to mock existing users to prevent duplicates in future runs
                        mockExistingUsers.push(normalizeEmail(row.email));
                    } else {
                        result.skipped++;
                        result.errors.push({
                            email: row.email,
                            error: 'Invalid email or user already exists'
                        });
                    }
                }
            }

            return result;
        }

        // Search Configuration
        const searchConfig = {
            debounceMs: 250,
            groups: ["top", "recentByYou", "trending", "related"],
            maxPerGroup: 5,
            weights: { text: 0.45, user: 0.25, pop: 0.15, fresh: 0.10, org: 0.05 },
            useEmbeddings: false,       // fallback to tags if false
            showTimestamps: true,
            minCharsToQuery: 1,
            enablePredictiveSearch: true
        };

        // Search Item Type Definition and Mock Data
        const mockSearchItems = [
            {
                id: "1",
                title: "A-to-Z Master Inventory",
                type: "document",
                url: "https://docs.google.com/spreadsheets/d/abc123/edit",
                tags: ["data inventory", "data management", "data quality"],
                popularity_7d: 85,
                last_updated: "2024-09-28T00:00:00Z",
                last_used_by_you: "2024-10-15T14:30:00Z",
                org_priority: 0.9
            },
            {
                id: "2",
                title: "Data Quality Framework",
                type: "document",
                url: "https://docs.google.com/document/d/xyz789/edit",
                tags: ["data quality", "governance", "standards"],
                popularity_7d: 72,
                last_updated: "2024-09-20T00:00:00Z",
                last_used_by_you: "2024-10-14T09:15:00Z",
                org_priority: 0.8
            },
            {
                id: "3",
                title: "Project Proposal Template",
                type: "document",
                url: "https://docs.google.com/document/d/xyz789/edit",
                tags: ["templates", "project management", "capacity building"],
                popularity_7d: 45,
                last_updated: "2024-07-20T00:00:00Z",
                last_used_by_you: "2024-10-10T16:20:00Z",
                org_priority: 0.7
            },
            {
                id: "4",
                title: "Data Ethics Framework",
                type: "report",
                url: "https://docs.google.com/document/d/def456/edit",
                tags: ["ethics", "transparency", "governance"],
                popularity_7d: 38,
                last_updated: "2024-06-10T00:00:00Z",
                last_used_by_you: null,
                org_priority: 0.6
            },
            {
                id: "5",
                title: "AI Implementation Roadmap",
                type: "document",
                url: "https://docs.google.com/presentation/d/ghi123/edit",
                tags: ["artificial intelligence", "implementation", "roadmap"],
                popularity_7d: 91,
                last_updated: "2024-08-01T00:00:00Z",
                last_used_by_you: "2024-10-12T11:45:00Z",
                org_priority: 0.9
            },
            {
                id: "6",
                title: "Data Visualization Best Practices",
                type: "module",
                url: "https://example.com/video/dataviz",
                tags: ["visualization", "best practices", "training"],
                popularity_7d: 67,
                last_updated: "2024-05-22T00:00:00Z",
                last_used_by_you: "2024-10-11T13:30:00Z",
                org_priority: 0.5
            },
            {
                id: "7",
                title: "Performance Metrics Dashboard",
                type: "dataset",
                url: "https://docs.google.com/spreadsheets/d/jkl456/edit",
                tags: ["metrics", "performance", "dashboard"],
                popularity_7d: 29,
                last_updated: "2024-09-15T00:00:00Z",
                last_used_by_you: null,
                org_priority: 0.4
            },
            {
                id: "8",
                title: "Data Catalog Playbook",
                type: "document",
                url: "https://example.com/catalog-guide",
                tags: ["data catalog", "data inventory", "playbook"],
                popularity_7d: 54,
                last_updated: "2024-08-15T00:00:00Z",
                last_used_by_you: "2024-10-08T10:00:00Z",
                org_priority: 0.8
            },
            {
                id: "9",
                title: "Metadata Standards Guide",
                type: "document",
                url: "https://example.com/metadata-guide",
                tags: ["metadata", "standards", "data governance"],
                popularity_7d: 33,
                last_updated: "2024-07-10T00:00:00Z",
                last_used_by_you: null,
                org_priority: 0.6
            },
            {
                id: "10",
                title: "Asset Registry Template",
                type: "document",
                url: "https://example.com/asset-registry",
                tags: ["asset registry", "inventory", "template"],
                popularity_7d: 41,
                last_updated: "2024-09-05T00:00:00Z",
                last_used_by_you: "2024-10-13T15:20:00Z",
                org_priority: 0.7
            }
        ];

        // Mock user usage history - Personalized for different user types
        const mockUserUsageByRole = {
            "Administrator": {
                "1": 12, "2": 8, "5": 10, "6": 6, "8": 4, "10": 3
            },
            "Program Manager": {
                "3": 15, "5": 12, "7": 8, "9": 5, "10": 7
            },
            "Data Analyst": {
                "1": 20, "2": 15, "6": 12, "8": 10, "9": 3
            },
            "Research Director": {
                "4": 18, "5": 14, "6": 11, "7": 9, "8": 6
            },
            "Analyst": {
                "1": 10, "2": 12, "6": 8, "8": 5, "10": 4
            },
            "Coordinator": {
                "3": 8, "5": 6, "7": 10, "9": 7, "10": 5
            },
            "Researcher": {
                "4": 9, "6": 11, "8": 7, "9": 4, "10": 6
            },
            "Project Manager": {
                "3": 14, "5": 11, "7": 13, "9": 8, "10": 9
            },
            "Senior Data Analyst": {
                "1": 25, "2": 20, "6": 18, "8": 15, "9": 10
            }
        };

        // Data Adapter Functions
        async function fetchSearchCandidates(query) {
            // Get real resources from Google Sheets data
            const currentData = await fetchDataFromGoogleSheets();
            const resources = currentData.resources || [];

            if (!query || query.length < searchConfig.minCharsToQuery) {
                // Return top 8 most recently updated resources
                return resources
                    .sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated))
                    .slice(0, 8)
                    .map(transformResourceToSearchItem);
            }

            // Advanced text matching with Google Sheets data
            const queryLower = query.toLowerCase();
            const queryWords = queryLower.split(' ').filter(word => word.length > 1);

            return resources.filter(resource => {
                // Search in resource name (highest priority)
                if (resource.resourceName && resource.resourceName.toLowerCase().includes(queryLower)) {
                    return true;
                }

                // Search in description
                if (resource.description && resource.description.toLowerCase().includes(queryLower)) {
                    return true;
                }

                // Search in topics
                if (resource.topics && resource.topics.some(topic =>
                    topic.toLowerCase().includes(queryLower) ||
                    queryWords.some(word => topic.toLowerCase().includes(word))
                )) {
                    return true;
                }

                // Search in authors
                if (resource.authors && resource.authors.some(author =>
                    author.toLowerCase().includes(queryLower)
                )) {
                    return true;
                }

                // Search in programs used
                if (resource.programsUsed && resource.programsUsed.some(program =>
                    program.toLowerCase().includes(queryLower)
                )) {
                    return true;
                }

                // Search in file type
                if (resource.fileType && resource.fileType.toLowerCase().includes(queryLower)) {
                    return true;
                }

                return false;
            }).map(transformResourceToSearchItem);
        }

        // Transform Google Sheets resource to search item format
        function transformResourceToSearchItem(resource) {
            return {
                id: resource.id.toString(),
                title: resource.resourceName || 'Untitled Resource',
                type: getSearchItemType(resource.fileType),
                url: resource.englishLink || resource.spanishLink || resource.portugueseLink || resource.italianLink || '#',
                tags: resource.topics || [],
                popularity_7d: Math.random() * 100, // Could be enhanced with real analytics
                last_updated: resource.lastUpdated + 'T00:00:00Z',
                last_used_by_you: null, // Could be enhanced with user tracking
                org_priority: resource.govexOrExternal === 'GovEx' ? 0.9 : 0.7,
                authors: resource.authors || [],
                programs: resource.programsUsed || [],
                fillable: resource.fillable || false,
                description: resource.description || ''
            };
        }

        // Map file types to search item types
        function getSearchItemType(fileType) {
            if (!fileType) return 'document';
            const type = fileType.toLowerCase();
            if (type.includes('xlsx') || type.includes('xls')) return 'dataset';
            if (type.includes('pdf')) return 'document';
            if (type.includes('docx') || type.includes('doc')) return 'document';
            if (type.includes('pptx') || type.includes('ppt')) return 'presentation';
            if (type.includes('html')) return 'page';
            return 'document';
        }

        async function fetchUserUsage(userId) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 50));

            // Find user and return role-based usage
            const user = USERS.find(u => u.id.toString() === userId.toString());
            const userRole = user ? user.role : 'Researcher';
            return mockUserUsageByRole[userRole] || mockUserUsageByRole['Researcher'];
        }

        async function fetchTrending() {
            // Get real resources and find trending ones based on recent updates and GovEx priority
            const currentData = await fetchDataFromGoogleSheets();
            const resources = currentData.resources || [];

            return resources
                .map(transformResourceToSearchItem)
                .sort((a, b) => {
                    // Sort by organization priority (GovEx first) and recent updates
                    const priorityDiff = b.org_priority - a.org_priority;
                    if (priorityDiff !== 0) return priorityDiff;
                    return new Date(b.last_updated) - new Date(a.last_updated);
                })
                .slice(0, searchConfig.maxPerGroup);
        }

        async function fetchRelatedByTags(query) {
            // Get real resources and find related ones by topics/tags
            const currentData = await fetchDataFromGoogleSheets();
            const resources = currentData.resources || [];

            const queryLower = query.toLowerCase();
            const queryWords = queryLower.split(' ').filter(word => word.length > 2);

            // Find resources with overlapping topics, authors, or programs
            return resources
                .filter(resource => {
                    const hasTopicOverlap = resource.topics && resource.topics.some(topic =>
                        queryWords.some(word => topic.toLowerCase().includes(word))
                    );
                    const hasAuthorOverlap = resource.authors && resource.authors.some(author =>
                        queryWords.some(word => author.toLowerCase().includes(word))
                    );
                    const hasProgramOverlap = resource.programsUsed && resource.programsUsed.some(program =>
                        queryWords.some(word => program.toLowerCase().includes(word))
                    );
                    const notExactMatch = !(resource.resourceName && resource.resourceName.toLowerCase().includes(queryLower));

                    return (hasTopicOverlap || hasAuthorOverlap || hasProgramOverlap) && notExactMatch;
                })
                .map(transformResourceToSearchItem)
                .slice(0, searchConfig.maxPerGroup);
        }

        // Ranking Logic
        function calculateTextRelevance(query, item) {
            if (!query) return 0;

            const queryLower = query.toLowerCase();
            const titleLower = item.title.toLowerCase();

            // Exact title match gets highest score
            if (titleLower === queryLower) return 1.0;

            // Title starts with query gets high score
            if (titleLower.startsWith(queryLower)) return 0.9;

            // Title contains query gets medium score
            if (titleLower.includes(queryLower)) return 0.7;

            // Tag exact match gets good score
            const tagMatch = item.tags.some(tag => tag.toLowerCase() === queryLower);
            if (tagMatch) return 0.8;

            // Tag contains query gets lower score
            const tagContains = item.tags.some(tag => tag.toLowerCase().includes(queryLower));
            if (tagContains) return 0.5;

            return 0;
        }

        function calculateUserRecentUsage(item, userUsage) {
            const usage = userUsage[item.id] || 0;
            const maxUsage = Math.max(...Object.values(userUsage));
            if (maxUsage === 0) return 0;

            // Normalize usage frequency (0-0.7)
            let score = (usage / maxUsage) * 0.7;

            // Boost for recent usage
            if (item.last_used_by_you) {
                const lastUsed = new Date(item.last_used_by_you);
                const now = new Date();
                const daysSinceUsed = (now - lastUsed) / (1000 * 60 * 60 * 24);

                if (daysSinceUsed <= 1) score += 0.3;      // Used today
                else if (daysSinceUsed <= 7) score += 0.2;  // Used this week
                else if (daysSinceUsed <= 30) score += 0.1; // Used this month
            }

            return Math.min(score, 1.0);
        }

        function calculateGlobalPopularity(item) {
            const popularity = item.popularity_7d || 0;
            // Normalize to 0-1 based on max observed popularity
            const maxPopularity = 100; // Assuming max popularity of 100
            return Math.min(popularity / maxPopularity, 1.0);
        }

        function calculateFreshness(item) {
            if (!item.last_updated) return 0;

            const lastUpdated = new Date(item.last_updated);
            const now = new Date();
            const daysSinceUpdate = (now - lastUpdated) / (1000 * 60 * 60 * 24);

            if (daysSinceUpdate <= 7) return 1.0;       // Updated this week
            if (daysSinceUpdate <= 30) return 0.7;      // Updated this month
            if (daysSinceUpdate <= 90) return 0.4;      // Updated this quarter
            if (daysSinceUpdate <= 365) return 0.2;     // Updated this year

            return 0.1; // Older than a year
        }

        function rankItems(query, items, userUsage, config = searchConfig) {
            return items.map(item => {
                const textRelevance = calculateTextRelevance(query, item);
                const userRecentUsage = calculateUserRecentUsage(item, userUsage);
                const globalPopularity = calculateGlobalPopularity(item);
                const freshness = calculateFreshness(item);
                const orgPriority = item.org_priority || 0;

                const score =
                    config.weights.text * textRelevance +
                    config.weights.user * userRecentUsage +
                    config.weights.pop * globalPopularity +
                    config.weights.fresh * freshness +
                    config.weights.org * orgPriority;

                return { ...item, score, textRelevance, userRecentUsage };
            })
            .sort((a, b) => {
                if (Math.abs(a.score - b.score) < 0.01) {
                    // Break ties by last_used_by_you
                    const aLastUsed = a.last_used_by_you ? new Date(a.last_used_by_you) : new Date(0);
                    const bLastUsed = b.last_used_by_you ? new Date(b.last_used_by_you) : new Date(0);
                    if (aLastUsed.getTime() !== bLastUsed.getTime()) {
                        return bLastUsed - aLastUsed;
                    }
                    // Then by last_updated
                    const aUpdated = new Date(a.last_updated || 0);
                    const bUpdated = new Date(b.last_updated || 0);
                    return bUpdated - aUpdated;
                }
                return b.score - a.score;
            });
        }

        // Google Sheets API Configuration
        const GOOGLE_SHEETS_CONFIG = {
            API_KEY: 'AIzaSyBUa8W2lZXxRNfqJ3Ov0MWUPeTd0TjkRhg',
            SHEET_ID: '1GSqiViIPp4GPAe4ugZ2ImXShsU1NP37CjT_I3Ck-AR4',
            RANGE: 'Sheet1!A2:N', // Gets columns A through N starting from row 2 (skipping headers)
        };

        // File Requests Google Sheets Configuration
        const FILE_REQUESTS_SHEETS_CONFIG = {
            API_KEY: 'AIzaSyBUa8W2lZXxRNfqJ3Ov0MWUPeTd0TjkRhg',
            SHEET_ID: 'YOUR_FILE_REQUESTS_SHEET_ID', // Replace with your file requests sheet ID
            RANGE: 'FileRequests!A2:H', // Columns: Timestamp, Name, Email, Description, Program, Additional Context, Status, Priority
        };

        // Google Sheets API service functions
        const GoogleSheetsService = {
            async fetchSheetData() {
                const { API_KEY, SHEET_ID, RANGE } = GOOGLE_SHEETS_CONFIG;

                if (!API_KEY || API_KEY === 'YOUR_API_KEY' || !SHEET_ID || SHEET_ID === 'YOUR_SHEET_ID') {
                    console.warn('Google Sheets API not configured, using mock data');
                    return MOCK_DATABASE;
                }

                console.log(' Fetching data from Google Sheets...', { SHEET_ID, RANGE });

                try {
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
                    const response = await fetch(url);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const values = data.values || [];

                    console.log(' Google Sheets response:', {
                        totalRows: values.length,
                        firstRow: values[0],
                        sheetData: data
                    });

                    // If no data is returned from Google Sheets, fall back to mock data
                    if (values.length === 0) {
                        console.warn(' No data returned from Google Sheets, using mock data');
                        return MOCK_DATABASE;
                    }

                    const transformedData = this.transformSheetData(values);
                    console.log(' Transformed data:', {
                        resourceCount: transformedData.resources.length,
                        sampleResource: transformedData.resources[0]
                    });

                    return transformedData;
                } catch (error) {
                    console.error('Error fetching from Google Sheets:', error);
                    throw error;
                }
            },

            transformSheetData(rows) {
                // Transform Google Sheets rows into our app's data structure
                const resources = rows.map((row, index) => {
                    const [
                        resourceName = '',
                        description = '',
                        englishLink = '',
                        spanishLink = '',
                        portugueseLink = '',
                        italianLink = '',
                        govexOrExternal = '',
                        cityShared = '',
                        topics = '',
                        programsUsed = '',
                        fileType = '',
                        fillable = '',
                        authors = '',
                        lastUpdated = ''
                    ] = row;

                    return {
                        id: index + 1,
                        resourceName: resourceName.trim(),
                        description: description.trim(),
                        englishLink: englishLink.trim() || null,
                        spanishLink: spanishLink.trim() || null,
                        portugueseLink: portugueseLink.trim() || null,
                        italianLink: italianLink.trim() || null,
                        govexOrExternal: govexOrExternal.trim(),
                        cityShared: this.parseBooleanField(cityShared),
                        topics: this.parseArrayField(topics),
                        programsUsed: this.parseArrayField(programsUsed),
                        fileType: fileType.trim(),
                        fillable: this.parseBooleanField(fillable),
                        authors: this.parseArrayField(authors),
                        lastUpdated: lastUpdated.trim(),
                        // Additional fields for compatibility with existing code
                        isFavorite: false
                    };
                }).filter(resource => resource.resourceName); // Filter out empty rows

                return {
                    programs: MOCK_DATABASE.programs, // Keep existing programs structure
                    resources: resources
                };
            },

            parseArrayField(field) {
                if (!field || typeof field !== 'string') return [];
                // Handle comma-separated values, semicolon-separated, or pipe-separated
                return field.split(/[,;|]/).map(item => item.trim()).filter(item => item);
            },

            parseBooleanField(field) {
                if (!field || typeof field !== 'string') return false;
                const lowerField = field.toLowerCase().trim();
                return lowerField === 'yes' || lowerField === 'true' || lowerField === '1' || lowerField === 'fillable';
            }
        };

        // Main data fetching function
        async function fetchDataFromGoogleSheets() {
            try {
                console.log(' Starting data fetch...');
                const result = await GoogleSheetsService.fetchSheetData();
                console.log(' Data fetch completed successfully');
                return result;
            } catch (error) {
                console.error(' Failed to fetch data from Google Sheets, falling back to mock data:', error);
                console.log(' Using mock data with', MOCK_DATABASE.resources.length, 'resources');
                return MOCK_DATABASE;
            }
        }

        // File Requests Google Sheets Service
        const FileRequestsService = {
            async submitFileRequest(requestData) {
                const { API_KEY, SHEET_ID } = FILE_REQUESTS_SHEETS_CONFIG;

                if (!API_KEY || !SHEET_ID || SHEET_ID === 'YOUR_FILE_REQUESTS_SHEET_ID') {
                    console.warn('File Requests Google Sheets not configured, using local storage');
                    return this.saveToLocalStorage(requestData);
                }

                try {
                    // For now, we'll use the append method via Google Sheets API
                    // Note: This requires enabling Google Sheets API for writing
                    const timestamp = new Date().toISOString();
                    const values = [[
                        timestamp,
                        requestData.userName || 'Anonymous',
                        requestData.userEmail || 'unknown@email.com',
                        requestData.description,
                        requestData.program,
                        requestData.additionalContext || '',
                        'Submitted', // Default status
                        'Medium' // Default priority
                    ]];

                    // TODO: Replace with actual Google Sheets API append call
                    // This is a placeholder for the actual implementation
                    console.log('Would submit to Google Sheets:', { values });

                    // For now, save to localStorage as fallback
                    return this.saveToLocalStorage(requestData);

                } catch (error) {
                    console.error('Error submitting to Google Sheets:', error);
                    return this.saveToLocalStorage(requestData);
                }
            },

            saveToLocalStorage(requestData) {
                try {
                    const existingRequests = JSON.parse(localStorage.getItem('govex_file_requests') || '[]');
                    const newRequest = {
                        id: Date.now(),
                        ...requestData,
                        timestamp: new Date().toISOString(),
                        status: 'Submitted'
                    };
                    existingRequests.push(newRequest);
                    localStorage.setItem('govex_file_requests', JSON.stringify(existingRequests));
                    return { success: true, request: newRequest };
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                    return { success: false, error: error.message };
                }
            },

            async getFileRequests() {
                const { API_KEY, SHEET_ID, RANGE } = FILE_REQUESTS_SHEETS_CONFIG;

                if (!API_KEY || !SHEET_ID || SHEET_ID === 'YOUR_FILE_REQUESTS_SHEET_ID') {
                    return this.getFromLocalStorage();
                }

                try {
                    // TODO: Implement actual Google Sheets read
                    console.log('Would fetch from Google Sheets');
                    return this.getFromLocalStorage();
                } catch (error) {
                    console.error('Error fetching from Google Sheets:', error);
                    return this.getFromLocalStorage();
                }
            },

            getFromLocalStorage() {
                try {
                    return JSON.parse(localStorage.getItem('govex_file_requests') || '[]');
                } catch (error) {
                    console.error('Error reading from localStorage:', error);
                    return [];
                }
            }
        };

        // Icon components using Lucide
        function Icon({ name, className = "", size = 20 }) {
            useEffect(() => {
                lucide.createIcons();
            }, []);

            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        }

        /**
         * UniversalSearch Component
         *
         * A comprehensive search component with predictive suggestions.
         *
         * Features:
         * - Type-ahead predictions with multiple groups (Top Results, Recently Used, Trending, Related)
         * - Configurable ranking weights (text relevance, user usage, popularity, freshness, org priority)
         * - Keyboard navigation (Up/Down/Enter/Esc)
         * - Debounced queries with request cancellation
         * - Accessibility support (ARIA roles)
         * - Analytics telemetry
         *
         * To wire real endpoints:
         * 1. Replace mock adapter functions (fetchSearchCandidates, fetchUserUsage, etc.)
         * 2. Update searchConfig object for your specific needs
         * 3. Configure analytics events in handleAnalytics function
         * 4. Update type mappings and styling as needed
         *
         * Configuration via searchConfig object:
         * - debounceMs: Delay before firing queries
         * - weights: Ranking algorithm weights
         * - maxPerGroup: Maximum items per result group
         * - enablePredictiveSearch: Feature flag
         */
        function UniversalSearch({ currentUserId, onOpen, searchQuery, setSearchQuery }) {
            const [isOpen, setIsOpen] = useState(false);
            const [results, setResults] = useState({
                top: [],
                recentByYou: [],
                trending: [],
                related: []
            });
            const [activeIndex, setActiveIndex] = useState(-1);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [lastQuery, setLastQuery] = useState('');

            const inputRef = useRef(null);
            const dropdownRef = useRef(null);
            const abortControllerRef = useRef(null);
            const queryCache = useRef(new Map());

            // Debounced search function
            const debouncedSearch = useCallback(
                useMemo(() => {
                    let timeoutId;
                    return (query) => {
                        clearTimeout(timeoutId);
                        timeoutId = setTimeout(() => performSearch(query), searchConfig.debounceMs);
                    };
                }, []),
                []
            );

            // Perform search with caching and request cancellation
            const performSearch = async (query) => {
                if (!searchConfig.enablePredictiveSearch) return;

                // Cancel previous request
                if (abortControllerRef.current) {
                    abortControllerRef.current.abort();
                }

                // Check cache first
                const cacheKey = query.toLowerCase().trim();
                if (queryCache.current.has(cacheKey)) {
                    setResults(queryCache.current.get(cacheKey));
                    setLastQuery(query);
                    return;
                }

                setLoading(true);
                setError(null);
                abortControllerRef.current = new AbortController();

                try {
                    const [candidates, userUsage, trending, related] = await Promise.all([
                        fetchSearchCandidates(query),
                        fetchUserUsage(currentUserId),
                        query.length >= 3 ? fetchTrending() : Promise.resolve([]),
                        query.length >= 3 ? fetchRelatedByTags(query) : Promise.resolve([])
                    ]);

                    if (abortControllerRef.current.signal.aborted) return;

                    // Rank and deduplicate results
                    const rankedCandidates = rankItems(query, candidates, userUsage);

                    // Group results
                    const topResults = rankedCandidates.slice(0, searchConfig.maxPerGroup);

                    // Recently used by user (filter from ranked results)
                    const recentByYou = rankedCandidates
                        .filter(item => item.userRecentUsage > 0)
                        .slice(0, searchConfig.maxPerGroup);

                    // Remove duplicates from other groups
                    const usedIds = new Set([...topResults.map(r => r.id), ...recentByYou.map(r => r.id)]);
                    const trendingFiltered = trending.filter(item => !usedIds.has(item.id)).slice(0, searchConfig.maxPerGroup);
                    const relatedFiltered = related.filter(item => !usedIds.has(item.id)).slice(0, searchConfig.maxPerGroup);

                    const searchResults = {
                        top: topResults,
                        recentByYou,
                        trending: trendingFiltered,
                        related: relatedFiltered
                    };

                    setResults(searchResults);
                    setLastQuery(query);

                    // Cache results (keep last 5 queries)
                    if (queryCache.current.size >= 5) {
                        const firstKey = queryCache.current.keys().next().value;
                        queryCache.current.delete(firstKey);
                    }
                    queryCache.current.set(cacheKey, searchResults);

                    // Analytics
                    handleAnalytics('search_typed', { queryLength: query.length });

                } catch (err) {
                    if (!abortControllerRef.current.signal.aborted) {
                        setError('Search failed. Please try again.');
                        console.error('Search error:', err);
                    }
                } finally {
                    setLoading(false);
                }
            };

            // Handle input changes
            const handleInputChange = (e) => {
                const value = e.target.value;
                setSearchQuery(value);
                setActiveIndex(-1);

                if (value.length >= searchConfig.minCharsToQuery) {
                    debouncedSearch(value);
                } else {
                    setResults({ top: [], recentByYou: [], trending: [], related: [] });
                }
            };

            // Handle focus
            const handleFocus = () => {
                setIsOpen(true);
                handleAnalytics('search_opened');

                if (searchQuery.length < searchConfig.minCharsToQuery) {
                    performSearch(''); // Load defaults
                }
            };

            // Handle blur (with delay to allow clicks)
            const handleBlur = () => {
                setTimeout(() => setIsOpen(false), 200);
            };

            // Get flattened results for keyboard navigation
            const flatResults = useMemo(() => {
                const flat = [];
                Object.entries(results).forEach(([groupKey, items]) => {
                    items.forEach((item, index) => {
                        flat.push({ ...item, groupKey, groupIndex: index });
                    });
                });
                return flat;
            }, [results]);

            // Handle keyboard navigation
            const handleKeyDown = (e) => {
                if (!isOpen) return;

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        setActiveIndex(prev => Math.min(prev + 1, flatResults.length - 1));
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        setActiveIndex(prev => Math.max(prev - 1, -1));
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (activeIndex >= 0 && flatResults[activeIndex]) {
                            handleResultClick(flatResults[activeIndex]);
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        setIsOpen(false);
                        inputRef.current?.blur();
                        break;
                }
            };

            // Handle result selection
            const handleResultClick = (item) => {
                handleAnalytics('search_result_selected', { id: item.id, type: item.type });

                if (onOpen) {
                    onOpen(item.url);
                } else {
                    window.open(item.url, '_blank', 'noopener,noreferrer');
                }

                setIsOpen(false);
                setSearchQuery('');
            };

            // Handle result hover for analytics
            const handleResultHover = (item) => {
                handleAnalytics('search_result_hovered', { id: item.id });
            };

            // Analytics helper
            const handleAnalytics = (event, data = {}) => {
                // Implement your analytics tracking here
                console.log('Analytics:', event, data);
                // Example: analytics.track(event, data);
            };

            // Format timestamp
            const formatTimestamp = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                if (diffDays === 0) return 'Today';
                if (diffDays === 1) return 'Yesterday';
                if (diffDays < 7) return `${diffDays}d ago`;
                if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;
                return `${Math.floor(diffDays / 30)}mo ago`;
            };

            // Get type icon
            const getTypeIcon = (type) => {
                switch (type) {
                    case 'document': return 'file-text';
                    case 'dataset': return 'database';
                    case 'module': return 'book-open';
                    case 'report': return 'file-bar-chart';
                    case 'page': return 'globe';
                    default: return 'file';
                }
            };

            // Get type color
            const getTypeColor = (type) => {
                switch (type) {
                    case 'document': return 'bg-blue-500';
                    case 'dataset': return 'bg-green-500';
                    case 'module': return 'bg-purple-500';
                    case 'report': return 'bg-orange-500';
                    case 'page': return 'bg-indigo-500';
                    default: return 'bg-gray-500';
                }
            };

            // Handle slash key shortcut
            useEffect(() => {
                const handleSlashKey = (e) => {
                    if (e.key === '/' && !e.ctrlKey && !e.metaKey && document.activeElement?.tagName !== 'INPUT') {
                        e.preventDefault();
                        inputRef.current?.focus();
                    }
                };

                document.addEventListener('keydown', handleSlashKey);
                return () => document.removeEventListener('keydown', handleSlashKey);
            }, []);

            // Group labels
            const groupLabels = {
                top: 'Top Results',
                recentByYou: 'Recently Used by You',
                trending: 'Trending',
                related: `Related to "${lastQuery}"`
            };

            // Empty state
            const hasResults = Object.values(results).some(group => group.length > 0);
            const showEmptyState = isOpen && !loading && !hasResults && searchQuery.length >= searchConfig.minCharsToQuery;

            return (
                <div className="relative flex-1 max-w-2xl">
                    <div className="relative">
                        <Icon name="search" className="absolute left-3 top-1/2 transform -translate-y-1/2 text-[#8b949e]" size={18} />
                        <input
                            ref={inputRef}
                            type="text"
                            placeholder="Search data, docs, or modules..."
                            value={searchQuery}
                            onChange={handleInputChange}
                            onFocus={handleFocus}
                            onBlur={handleBlur}
                            onKeyDown={handleKeyDown}
                            className="w-full bg-[#0d1117] border border-[#30363d] rounded-lg pl-10 pr-4 py-2 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] transition-colors"
                            role="combobox"
                            aria-expanded={isOpen}
                            aria-autocomplete="list"
                            aria-owns="search-results"
                        />
                        {loading && (
                            <div className="absolute right-3 top-1/2 transform -translate-y-1/2">
                                <div className="animate-spin rounded-full h-4 w-4 border-2 border-[#137fec] border-t-transparent"></div>
                            </div>
                        )}
                    </div>

                    {/* Dropdown Results */}
                    {isOpen && (
                        <div
                            ref={dropdownRef}
                            id="search-results"
                            className="absolute top-full left-0 right-0 mt-2 bg-[#161b22] border border-[#30363d] rounded-lg shadow-lg z-50 max-h-96 overflow-y-auto"
                            role="listbox"
                        >
                            {error && (
                                <div className="p-4 text-center text-[#f85149] text-sm">
                                    {error}
                                </div>
                            )}

                            {showEmptyState && (
                                <div className="p-4 text-center">
                                    <div className="text-[#8b949e] text-sm mb-3">No results. Try broader terms.</div>
                                    <div className="space-y-1">
                                        <button
                                            onClick={() => handleResultClick({ url: '#', id: 'help-1' })}
                                            className="block w-full text-left px-3 py-2 text-[#137fec] hover:bg-[#30363d] rounded text-sm transition-colors"
                                        >
                                            Browse all resources
                                        </button>
                                        <button
                                            onClick={() => handleResultClick({ url: '#', id: 'help-2' })}
                                            className="block w-full text-left px-3 py-2 text-[#137fec] hover:bg-[#30363d] rounded text-sm transition-colors"
                                        >
                                            View popular content
                                        </button>
                                        <button
                                            onClick={() => handleResultClick({ url: '#', id: 'help-3' })}
                                            className="block w-full text-left px-3 py-2 text-[#137fec] hover:bg-[#30363d] rounded text-sm transition-colors"
                                        >
                                            Request new resource
                                        </button>
                                    </div>
                                </div>
                            )}

                            {!error && !showEmptyState && Object.entries(results).map(([groupKey, items]) => {
                                if (items.length === 0) return null;

                                return (
                                    <div key={groupKey} className="border-b border-[#30363d] last:border-b-0">
                                        <div className="px-4 py-2 bg-[#0d1117] text-xs font-medium text-[#8b949e] uppercase tracking-wider">
                                            {groupLabels[groupKey]} ({items.length})
                                        </div>
                                        {items.map((item, index) => {
                                            const flatIndex = flatResults.findIndex(r => r.id === item.id);
                                            const isActive = flatIndex === activeIndex;

                                            return (
                                                <div
                                                    key={item.id}
                                                    className={`px-4 py-3 cursor-pointer transition-colors border-l-2 ${
                                                        isActive
                                                            ? 'bg-[#137fec] bg-opacity-10 border-l-[#137fec] text-[#e6edf3]'
                                                            : 'border-l-transparent hover:bg-[#30363d] text-[#e6edf3]'
                                                    }`}
                                                    onClick={() => handleResultClick(item)}
                                                    onMouseEnter={() => handleResultHover(item)}
                                                    role="option"
                                                    aria-selected={isActive}
                                                >
                                                    <div className="flex items-start justify-between">
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center space-x-2 mb-1">
                                                                <Icon name={getTypeIcon(item.type)} size={14} className="text-[#8b949e] flex-shrink-0" />
                                                                <span className={`inline-block px-2 py-0.5 rounded text-xs font-medium text-white ${getTypeColor(item.type)}`}>
                                                                    {item.type}
                                                                </span>
                                                                <h4 className="font-medium text-sm truncate">{item.title}</h4>
                                                            </div>
                                                            {item.tags && item.tags.length > 0 && (
                                                                <div className="flex flex-wrap gap-1 mb-1">
                                                                    {item.tags.slice(0, 3).map(tag => (
                                                                        <span key={tag} className="inline-block px-1.5 py-0.5 bg-[#30363d] text-[#8b949e] rounded text-xs">
                                                                            {tag}
                                                                        </span>
                                                                    ))}
                                                                    {item.tags.length > 3 && (
                                                                        <span className="inline-block px-1.5 py-0.5 bg-[#30363d] text-[#8b949e] rounded text-xs">
                                                                            +{item.tags.length - 3}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                        {searchConfig.showTimestamps && (
                                                            <div className="text-xs text-[#8b949e] ml-2 flex-shrink-0">
                                                                {item.last_used_by_you && (
                                                                    <div>Used {formatTimestamp(item.last_used_by_you)}</div>
                                                                )}
                                                                {item.last_updated && (
                                                                    <div>Updated {formatTimestamp(item.last_updated)}</div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        }

        // Login Component
        function LoginPage({ onLogin }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');

                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 800));

                const user = USERS.find(u => u.email === email && u.password === password);

                if (user) {
                    onLogin(user);
                } else {
                    setError('Invalid email or password');
                }
                setIsLoading(false);
            };

            return (
                <div className="min-h-screen bg-[#0d1117] flex items-center justify-center p-4">
                    <div className="w-full max-w-md">
                        <div className="bg-[#161b22] border border-[#30363d] rounded-lg p-8 shadow-xl">
                            <div className="text-center mb-8">
                                <div className="w-16 h-16 bg-[#137fec] rounded-lg flex items-center justify-center mx-auto mb-4">
                                    <Icon name="book-open" className="text-white" size={32} />
                                </div>
                                <h1 className="text-2xl font-bold text-[#e6edf3]">GovEx Academy</h1>
                                <p className="text-[#8b949e] mt-2">Sign in to access your resources</p>
                            </div>

                            <form onSubmit={handleLogin} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-[#e6edf3] mb-2">Email</label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="w-full bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] transition-colors"
                                        placeholder="Enter your email"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-[#e6edf3] mb-2">Password</label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] transition-colors"
                                        placeholder="Enter your password"
                                        required
                                    />
                                </div>
                                {error && (
                                    <div className="p-3 bg-[#f85149] bg-opacity-10 border border-[#f85149] rounded-lg">
                                        <p className="text-[#f85149] text-sm">{error}</p>
                                    </div>
                                )}
                                <button
                                    type="submit"
                                    disabled={isLoading}
                                    className="w-full bg-[#137fec] text-white py-2 px-4 rounded-lg hover:bg-[#1c8fed] transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                                >
                                    {isLoading ? (
                                        <>
                                            <Icon name="loader-2" className="animate-spin mr-2" size={16} />
                                            Signing in...
                                        </>
                                    ) : (
                                        'Sign In'
                                    )}
                                </button>
                            </form>

                            <div className="mt-6 p-4 bg-[#0d1117] rounded-lg">
                                <p className="text-xs text-[#8b949e] mb-3"> Test Enhanced Universal Search - All accounts have access:</p>
                                <div className="grid grid-cols-1 gap-2 text-xs">
                                    <div className="flex justify-between">
                                        <span className="text-[#e6edf3]">admin@govex.com</span>
                                        <span className="text-[#8b949e]">admin123</span>
                                        <span className="text-[#137fec] text-xs">Admin</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-[#e6edf3]">jane.doe@govex.org</span>
                                        <span className="text-[#8b949e]">demo123</span>
                                        <span className="text-[#137fec] text-xs">Manager</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-[#e6edf3]">john.smith@govex.org</span>
                                        <span className="text-[#8b949e]">demo123</span>
                                        <span className="text-[#137fec] text-xs">Analyst</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-[#e6edf3]">test@govex.org</span>
                                        <span className="text-[#8b949e]">test123</span>
                                        <span className="text-[#137fec] text-xs">Test User</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-[#e6edf3]">analyst@govex.org</span>
                                        <span className="text-[#8b949e]">analyst123</span>
                                        <span className="text-[#137fec] text-xs">Sr. Analyst</span>
                                    </div>
                                </div>
                                <div className="mt-3 pt-2 border-t border-[#30363d]">
                                    <p className="text-xs text-[#8b949e]"> Try typing "data", "AI", or "/" for instant search</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // BulkUploadCard Component for Settings
        function BulkUploadCard({ currentUser, onClose }) {
            const [step, setStep] = useState(1); // 1: Upload, 2: Map, 3: Preview, 4: Import, 5: Results
            const [file, setFile] = useState(null);
            const [data, setData] = useState(null);
            const [mapping, setMapping] = useState({});
            const [preview, setPreview] = useState([]);
            const [dryRun, setDryRun] = useState(true);
            const [sendEmails, setSendEmails] = useState(bulkUserUploadConfig.inviteEmailsDefault);
            const [defaultRole, setDefaultRole] = useState(bulkUserUploadConfig.defaultRole);
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState('');

            const fileInputRef = useRef(null);

            // Check if user has admin permissions
            const hasPermission = currentUser?.role === 'Administrator';

            if (!hasPermission) {
                return (
                    <div className="p-6 text-center">
                        <Icon name="shield-x" className="mx-auto text-[#f85149] mb-4" size={48} />
                        <h3 className="text-lg font-medium text-[#e6edf3] mb-2">Access Denied</h3>
                        <p className="text-[#8b949e]">You need Administrator permissions to access bulk user upload.</p>
                    </div>
                );
            }

            if (!bulkUserUploadConfig.featureFlag) {
                return (
                    <div className="p-6 text-center">
                        <Icon name="toggle-left" className="mx-auto text-[#8b949e] mb-4" size={48} />
                        <h3 className="text-lg font-medium text-[#e6edf3] mb-2">Feature Disabled</h3>
                        <p className="text-[#8b949e]">Bulk user upload is currently disabled.</p>
                    </div>
                );
            }

            const handleFileSelect = async (selectedFile) => {
                setError('');
                setFile(selectedFile);

                // Validate file
                if (selectedFile.size > bulkUserUploadConfig.maxFileSize) {
                    setError('File too large. Maximum size is 10MB.');
                    return;
                }

                const fileExt = '.' + selectedFile.name.split('.').pop().toLowerCase();
                if (!bulkUserUploadConfig.supportedFileTypes.includes(fileExt)) {
                    setError('Unsupported file type. Please upload a CSV file.');
                    return;
                }

                setLoading(true);
                try {
                    const parsed = await parseSpreadsheet(selectedFile);
                    setData(parsed);

                    // Auto-detect column mapping
                    const autoMapping = {};
                    const headerLower = parsed.headers.map(h => h.toLowerCase());

                    // Try to match common column names
                    const mappings = {
                        email: ['email', 'email address', 'e-mail'],
                        firstName: ['first name', 'firstname', 'given name', 'name'],
                        lastName: ['last name', 'lastname', 'surname', 'family name'],
                        role: ['role', 'position', 'title', 'job title'],
                        department: ['department', 'dept', 'division', 'team'],
                        notes: ['notes', 'comments', 'remarks']
                    };

                    Object.entries(mappings).forEach(([field, candidates]) => {
                        for (const candidate of candidates) {
                            const index = headerLower.indexOf(candidate);
                            if (index !== -1) {
                                autoMapping[field] = parsed.headers[index];
                                break;
                            }
                        }
                    });

                    setMapping(autoMapping);
                    setStep(2);
                } catch (err) {
                    setError('Failed to parse file: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                const droppedFiles = Array.from(e.dataFiles || e.target.files);
                if (droppedFiles.length > 0) {
                    handleFileSelect(droppedFiles[0]);
                }
            };

            const generatePreview = async () => {
                if (!mapping.email) {
                    setError('Email column mapping is required');
                    return;
                }

                setLoading(true);
                try {
                    const previews = await previewImport(data.rows, mapping, { defaultRole });
                    setPreview(previews);
                    setStep(3);
                } catch (err) {
                    setError('Failed to generate preview: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const executeImport = async () => {
                const readyRows = preview.filter(p => p.status === 'ready');
                if (readyRows.length === 0) {
                    setError('No valid rows to import');
                    return;
                }

                setLoading(true);
                setStep(4);

                try {
                    const importResult = await runUserImport({
                        rows: readyRows,
                        dryRun,
                        defaultRole,
                        sendInviteEmails: sendEmails,
                        batchSize: bulkUserUploadConfig.batchSize
                    });

                    setResult(importResult);
                    setStep(5);
                } catch (err) {
                    setError('Import failed: ' + err.message);
                    setStep(3);
                } finally {
                    setLoading(false);
                }
            };

            const downloadErrorReport = () => {
                const errorRows = preview.filter(p => p.status !== 'ready');
                const csvContent = 'Email,Error,Status\n' +
                    errorRows.map(row => `"${row.email}","${row.error}","${row.status}"`).join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bulk_upload_errors.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            };

            const downloadReceipt = () => {
                if (!result) return;

                const csvContent = `Import Receipt
Import ID: ${result.importId}
Date: ${new Date().toISOString()}
Total Processed: ${result.total}
Created: ${result.created}
Invited: ${result.invited}
Skipped: ${result.skipped}
Errors: ${result.errors.length}
Dry Run: ${dryRun ? 'Yes' : 'No'}

Errors:
${result.errors.map(e => `${e.email}: ${e.error}`).join('\n')}`;

                const blob = new Blob([csvContent], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bulk_upload_receipt_${result.importId}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            };

            const getStatusBadge = (status) => {
                const badges = {
                    ready: 'bg-green-500 text-white',
                    invalid_email: 'bg-red-500 text-white',
                    duplicate_in_file: 'bg-yellow-500 text-black',
                    already_exists: 'bg-blue-500 text-white',
                    disallowed_domain: 'bg-purple-500 text-white',
                    invalid_role: 'bg-orange-500 text-white'
                };
                return badges[status] || 'bg-gray-500 text-white';
            };

            const getStatusLabel = (status) => {
                const labels = {
                    ready: 'Ready',
                    invalid_email: 'Invalid Email',
                    duplicate_in_file: 'Duplicate',
                    already_exists: 'Exists',
                    disallowed_domain: 'Domain Blocked',
                    invalid_role: 'Invalid Role'
                };
                return labels[status] || status;
            };

            const summaryCounts = preview.reduce((acc, p) => {
                acc[p.status] = (acc[p.status] || 0) + 1;
                return acc;
            }, {});

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-[#161b22] border border-[#30363d] rounded-lg shadow-lg w-full max-w-6xl max-h-[95vh] overflow-hidden">
                        {/* Header */}
                        <div className="flex items-center justify-between p-6 border-b border-[#30363d]">
                            <div>
                                <h2 className="text-xl font-semibold text-[#e6edf3]">Bulk User Upload</h2>
                                <p className="text-sm text-[#8b949e] mt-1">Upload spreadsheet to create user accounts</p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-[#30363d] rounded transition-colors">
                                <Icon name="x" className="text-[#8b949e]" size={20} />
                            </button>
                        </div>

                        {/* Progress Steps */}
                        <div className="px-6 py-4 bg-[#0d1117] border-b border-[#30363d]">
                            <div className="flex items-center space-x-8">
                                {[
                                    { num: 1, label: 'Upload', icon: 'upload' },
                                    { num: 2, label: 'Map Columns', icon: 'columns' },
                                    { num: 3, label: 'Preview', icon: 'eye' },
                                    { num: 4, label: 'Import', icon: 'play' },
                                    { num: 5, label: 'Results', icon: 'check-circle' }
                                ].map((s) => (
                                    <div key={s.num} className={`flex items-center space-x-2 ${step >= s.num ? 'text-[#137fec]' : 'text-[#8b949e]'}`}>
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center border-2 ${
                                            step >= s.num ? 'border-[#137fec] bg-[#137fec] bg-opacity-20' : 'border-[#30363d]'
                                        }`}>
                                            {step > s.num ? (
                                                <Icon name="check" size={16} />
                                            ) : (
                                                <span className="text-xs font-medium">{s.num}</span>
                                            )}
                                        </div>
                                        <span className="text-sm font-medium">{s.label}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Content */}
                        <div className="p-6 overflow-y-auto max-h-[calc(95vh-200px)]">
                            {error && (
                                <div className="mb-4 p-4 bg-[#f85149] bg-opacity-10 border border-[#f85149] rounded-lg">
                                    <p className="text-[#f85149] text-sm">{error}</p>
                                </div>
                            )}

                            {/* Step 1: Upload */}
                            {step === 1 && (
                                <div className="space-y-6">
                                    <div
                                        className="border-2 border-dashed border-[#30363d] rounded-lg p-12 text-center hover:border-[#137fec] transition-colors cursor-pointer"
                                        onClick={() => fileInputRef.current?.click()}
                                        onDrop={handleDrop}
                                        onDragOver={(e) => e.preventDefault()}
                                    >
                                        <Icon name="upload-cloud" className="mx-auto text-[#8b949e] mb-4" size={48} />
                                        <h3 className="text-lg font-medium text-[#e6edf3] mb-2">
                                            {loading ? 'Processing file...' : 'Upload Spreadsheet'}
                                        </h3>
                                        <p className="text-[#8b949e] mb-4">
                                            Drag and drop a CSV file, or click to browse
                                        </p>
                                        <p className="text-xs text-[#8b949e]">
                                            Supported: CSV files up to 10MB, max {bulkUserUploadConfig.maxRows.toLocaleString()} rows
                                        </p>
                                        {loading && (
                                            <div className="mt-4">
                                                <div className="animate-spin rounded-full h-8 w-8 border-2 border-[#137fec] border-t-transparent mx-auto"></div>
                                            </div>
                                        )}
                                    </div>

                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        accept=".csv,.xlsx"
                                        onChange={(e) => e.target.files[0] && handleFileSelect(e.target.files[0])}
                                        className="hidden"
                                    />

                                    <div className="bg-[#0d1117] rounded-lg p-4">
                                        <h4 className="text-sm font-medium text-[#e6edf3] mb-2">Expected CSV Format:</h4>
                                        <div className="text-xs text-[#8b949e] space-y-1">
                                            <div><strong>Required:</strong> Email</div>
                                            <div><strong>Optional:</strong> First Name, Last Name, Role, Department, Notes</div>
                                            <div className="mt-2 text-[#f85149]"><strong>Example:</strong></div>
                                            <code className="block mt-1 p-2 bg-[#161b22] rounded text-[#e6edf3]">
                                                Email,First Name,Last Name,Role{'\n'}
                                                user1@city.gov,John,Doe,Data Analyst{'\n'}
                                                user2@city.gov,Jane,Smith,Researcher
                                            </code>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Step 2: Map Columns */}
                            {step === 2 && data && (
                                <div className="space-y-6">
                                    <div>
                                        <h3 className="text-lg font-medium text-[#e6edf3] mb-2">Map Columns</h3>
                                        <p className="text-[#8b949e] text-sm">
                                            Map your spreadsheet columns to user fields. Found {data.rows.length} rows to process.
                                        </p>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {[
                                            { key: 'email', label: 'Email', required: true },
                                            { key: 'firstName', label: 'First Name', required: false },
                                            { key: 'lastName', label: 'Last Name', required: false },
                                            { key: 'role', label: 'Role', required: false },
                                            { key: 'department', label: 'Department', required: false },
                                            { key: 'notes', label: 'Notes', required: false }
                                        ].map((field) => (
                                            <div key={field.key}>
                                                <label className="block text-sm font-medium text-[#e6edf3] mb-2">
                                                    {field.label} {field.required && <span className="text-[#f85149]">*</span>}
                                                </label>
                                                <select
                                                    value={mapping[field.key] || ''}
                                                    onChange={(e) => setMapping(prev => ({ ...prev, [field.key]: e.target.value }))}
                                                    className="w-full bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] focus:outline-none focus:border-[#137fec]"
                                                >
                                                    <option value="">-- Select Column --</option>
                                                    {data.headers.map(header => (
                                                        <option key={header} value={header}>{header}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="bg-[#0d1117] rounded-lg p-4">
                                        <h4 className="text-sm font-medium text-[#e6edf3] mb-2">Default Settings</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-[#e6edf3] mb-2">Default Role</label>
                                                <select
                                                    value={defaultRole}
                                                    onChange={(e) => setDefaultRole(e.target.value)}
                                                    className="w-full bg-[#161b22] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] focus:outline-none focus:border-[#137fec]"
                                                >
                                                    {availableRoles.map(role => (
                                                        <option key={role} value={role}>{role}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex space-x-4">
                                        <button
                                            onClick={() => setStep(1)}
                                            className="px-4 py-2 border border-[#30363d] text-[#e6edf3] rounded-lg hover:bg-[#30363d] transition-colors"
                                        >
                                            Back
                                        </button>
                                        <button
                                            onClick={generatePreview}
                                            disabled={!mapping.email || loading}
                                            className="px-4 py-2 bg-[#137fec] text-white rounded-lg hover:bg-[#1c8fed] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            {loading ? 'Generating Preview...' : 'Generate Preview'}
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Step 3: Preview */}
                            {step === 3 && preview.length > 0 && (
                                <div className="space-y-6">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <h3 className="text-lg font-medium text-[#e6edf3] mb-2">Preview & Validation</h3>
                                            <p className="text-[#8b949e] text-sm">
                                                Review the processed data before importing
                                            </p>
                                        </div>
                                        <div className="flex space-x-2">
                                            {Object.entries(summaryCounts).map(([status, count]) => (
                                                <div key={status} className={`px-2 py-1 rounded text-xs font-medium ${getStatusBadge(status)}`}>
                                                    {getStatusLabel(status)}: {count}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Settings */}
                                    <div className="bg-[#0d1117] rounded-lg p-4">
                                        <h4 className="text-sm font-medium text-[#e6edf3] mb-3">Import Settings</h4>
                                        <div className="flex items-center space-x-6">
                                            <label className="flex items-center space-x-2 cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={dryRun}
                                                    onChange={(e) => setDryRun(e.target.checked)}
                                                    className="rounded border-[#30363d] bg-[#0d1117] text-[#137fec] focus:ring-[#137fec]"
                                                />
                                                <span className="text-[#e6edf3] text-sm">Dry Run (recommended)</span>
                                            </label>
                                            <label className="flex items-center space-x-2 cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={sendEmails}
                                                    onChange={(e) => setSendEmails(e.target.checked)}
                                                    className="rounded border-[#30363d] bg-[#0d1117] text-[#137fec] focus:ring-[#137fec]"
                                                />
                                                <span className="text-[#e6edf3] text-sm">Send Invite Emails</span>
                                            </label>
                                        </div>
                                    </div>

                                    {/* Preview Table */}
                                    <div className="bg-[#0d1117] rounded-lg overflow-hidden">
                                        <div className="max-h-64 overflow-y-auto">
                                            <table className="w-full">
                                                <thead className="bg-[#161b22] sticky top-0">
                                                    <tr>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-[#8b949e] uppercase">Status</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-[#8b949e] uppercase">Email</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-[#8b949e] uppercase">Name</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-[#8b949e] uppercase">Role</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-[#8b949e] uppercase">Error</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-[#30363d]">
                                                    {preview.map((row, index) => (
                                                        <tr key={index} className="hover:bg-[#161b22]">
                                                            <td className="px-4 py-3">
                                                                <span className={`px-2 py-1 rounded text-xs font-medium ${getStatusBadge(row.status)}`}>
                                                                    {getStatusLabel(row.status)}
                                                                </span>
                                                            </td>
                                                            <td className="px-4 py-3 text-sm text-[#e6edf3]">{row.email}</td>
                                                            <td className="px-4 py-3 text-sm text-[#e6edf3]">
                                                                {[row.firstName, row.lastName].filter(Boolean).join(' ') || ''}
                                                            </td>
                                                            <td className="px-4 py-3 text-sm text-[#e6edf3]">{row.role}</td>
                                                            <td className="px-4 py-3 text-sm text-[#f85149]">{row.error || ''}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div className="flex items-center justify-between">
                                        <div className="flex space-x-2">
                                            <button
                                                onClick={() => setStep(2)}
                                                className="px-4 py-2 border border-[#30363d] text-[#e6edf3] rounded-lg hover:bg-[#30363d] transition-colors"
                                            >
                                                Back
                                            </button>
                                            {Object.keys(summaryCounts).some(s => s !== 'ready') && (
                                                <button
                                                    onClick={downloadErrorReport}
                                                    className="px-4 py-2 border border-[#f85149] text-[#f85149] rounded-lg hover:bg-[#f85149] hover:text-white transition-colors"
                                                >
                                                    Download Error Report
                                                </button>
                                            )}
                                        </div>
                                        <button
                                            onClick={executeImport}
                                            disabled={!summaryCounts.ready || loading}
                                            className="px-4 py-2 bg-[#137fec] text-white rounded-lg hover:bg-[#1c8fed] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            {dryRun ? 'Run Dry Import' : 'Run Import'} ({summaryCounts.ready || 0} users)
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Step 4: Import Progress */}
                            {step === 4 && (
                                <div className="text-center space-y-6">
                                    <div className="animate-spin rounded-full h-16 w-16 border-4 border-[#137fec] border-t-transparent mx-auto"></div>
                                    <div>
                                        <h3 className="text-lg font-medium text-[#e6edf3] mb-2">
                                            {dryRun ? 'Running Dry Import...' : 'Creating Users...'}
                                        </h3>
                                        <p className="text-[#8b949e]">
                                            Processing {preview.filter(p => p.status === 'ready').length} users
                                        </p>
                                    </div>
                                </div>
                            )}

                            {/* Step 5: Results */}
                            {step === 5 && result && (
                                <div className="space-y-6">
                                    <div className="text-center">
                                        <Icon name="check-circle" className="mx-auto text-green-500 mb-4" size={64} />
                                        <h3 className="text-xl font-medium text-[#e6edf3] mb-2">
                                            {dryRun ? 'Dry Run Complete' : 'Import Complete'}
                                        </h3>
                                        <p className="text-[#8b949e]">
                                            {dryRun ? 'No users were actually created' : 'Users have been successfully processed'}
                                        </p>
                                    </div>

                                    <div className="bg-[#0d1117] rounded-lg p-6">
                                        <h4 className="text-lg font-medium text-[#e6edf3] mb-4">Import Summary</h4>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            <div className="text-center">
                                                <div className="text-2xl font-bold text-green-500">{result.created}</div>
                                                <div className="text-sm text-[#8b949e]">{dryRun ? 'Would Create' : 'Created'}</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="text-2xl font-bold text-blue-500">{result.invited}</div>
                                                <div className="text-sm text-[#8b949e]">{dryRun ? 'Would Invite' : 'Invited'}</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="text-2xl font-bold text-yellow-500">{result.skipped}</div>
                                                <div className="text-sm text-[#8b949e]">Skipped</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="text-2xl font-bold text-red-500">{result.errors.length}</div>
                                                <div className="text-sm text-[#8b949e]">Errors</div>
                                            </div>
                                        </div>
                                    </div>

                                    {result.errors.length > 0 && (
                                        <div className="bg-[#f85149] bg-opacity-10 border border-[#f85149] rounded-lg p-4">
                                            <h5 className="text-sm font-medium text-[#f85149] mb-2">Errors ({result.errors.length})</h5>
                                            <div className="text-xs text-[#f85149] max-h-32 overflow-y-auto">
                                                {result.errors.map((error, index) => (
                                                    <div key={index}>{error.email}: {error.error}</div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    <div className="flex items-center justify-between">
                                        <button
                                            onClick={downloadReceipt}
                                            className="px-4 py-2 border border-[#30363d] text-[#e6edf3] rounded-lg hover:bg-[#30363d] transition-colors"
                                        >
                                            <Icon name="download" className="mr-2" size={16} />
                                            Download Receipt
                                        </button>
                                        <div className="space-x-2">
                                            <button
                                                onClick={() => {
                                                    setStep(1);
                                                    setFile(null);
                                                    setData(null);
                                                    setMapping({});
                                                    setPreview([]);
                                                    setResult(null);
                                                    setError('');
                                                }}
                                                className="px-4 py-2 border border-[#30363d] text-[#e6edf3] rounded-lg hover:bg-[#30363d] transition-colors"
                                            >
                                                Import Another File
                                            </button>
                                            <button
                                                onClick={onClose}
                                                className="px-4 py-2 bg-[#137fec] text-white rounded-lg hover:bg-[#1c8fed] transition-colors"
                                            >
                                                Done
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==========================================
        // NOTIFICATION UI COMPONENTS
        // ==========================================

        // Notification Bell Component
        function NotificationBell({ currentUser }) {
            const [showDropdown, setShowDropdown] = useState(false);
            const [notifications, setNotifications] = useState({ as_needed: [], this_week: [], older: [] });
            const [unreadCount, setUnreadCount] = useState(0);

            // Load notifications when component mounts or user changes
            useEffect(() => {
                console.log('NotificationBell: Component mounted/updated', {
                    currentUser,
                    NOTIFICATIONS_V1_ENABLED,
                    userId: currentUser?.id
                });

                if (currentUser && NOTIFICATIONS_V1_ENABLED) {
                    try {
                        const userNotifications = NotificationService.getUserNotifications(currentUser.id);
                        console.log('NotificationBell: Loaded notifications', userNotifications);
                        setNotifications(userNotifications);

                        // Calculate unread count (last 24 hours)
                        const dayAgo = new Date();
                        dayAgo.setDate(dayAgo.getDate() - 1);
                        const recentEvents = [...userNotifications.as_needed, ...userNotifications.this_week]
                            .filter(event => event.occurredAt >= dayAgo);
                        setUnreadCount(recentEvents.length);
                        console.log('NotificationBell: Unread count', recentEvents.length);
                    } catch (error) {
                        console.error('NotificationBell: Error loading notifications', error);
                    }
                }
            }, [currentUser]);

            const totalNotifications = notifications.as_needed.length + notifications.this_week.length;

            const formatTimeAgo = (date) => {
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                return `${diffDays}d ago`;
            };

            const getResourceById = (resourceId) => {
                // Try to find in current resources first, then fallback to mock data
                const allResources = [...(window.currentResources || []), ...MOCK_DATABASE.resources];
                return allResources.find(r => r.id === resourceId);
            };

            const handleNotificationClick = (event) => {
                const resource = getResourceById(event.resourceId);
                if (resource && resource.englishLink) {
                    window.open(resource.englishLink, '_blank', 'noopener,noreferrer');
                }
                setShowDropdown(false);
            };

            if (!NOTIFICATIONS_V1_ENABLED) {
                console.log('NotificationBell: Feature disabled, returning null');
                return null;
            }

            console.log('NotificationBell: Rendering with', {
                totalNotifications,
                unreadCount,
                showDropdown
            });

            return (
                <div className="relative">
                    <button
                        onClick={() => {
                            console.log('NotificationBell: Button clicked, toggling dropdown');
                            setShowDropdown(!showDropdown);
                        }}
                        className="relative p-2 bg-[#30363d] hover:bg-[#484f58] text-[#e6edf3] rounded-lg transition-colors"
                        title="Notifications"
                        style={{ minWidth: '40px', minHeight: '40px' }}
                    >
                        <Icon name="bell" size={16} />
                        
                        {unreadCount > 0 && (
                            <div className="absolute -top-1 -right-1 w-5 h-5 bg-[#f85149] rounded-full flex items-center justify-center">
                                <span className="text-xs text-white font-bold">
                                    {unreadCount > 9 ? '9+' : unreadCount}
                                </span>
                            </div>
                        )}
                    </button>

                    {showDropdown && (
                        <div className="absolute right-0 mt-2 w-96 bg-[#161b22] border border-[#30363d] rounded-lg shadow-lg z-50 max-h-96 overflow-hidden">
                            <div className="p-4 border-b border-[#30363d]">
                                <div className="flex items-center justify-between">
                                    <h3 className="text-lg font-semibold text-[#e6edf3]">Notifications</h3>
                                    <span className="text-sm text-[#8b949e]">{totalNotifications} items</span>
                                </div>
                            </div>

                            <div className="max-h-80 overflow-y-auto">
                                {/* As Needed Notifications */}
                                {notifications.as_needed.length > 0 && (
                                    <div className="p-3 border-b border-[#30363d]">
                                        <h4 className="text-sm font-medium text-[#f85149] mb-2">Urgent Updates</h4>
                                        {notifications.as_needed.map(event => {
                                            const resource = getResourceById(event.resourceId);
                                            return (
                                                <div
                                                    key={event.id}
                                                    onClick={() => handleNotificationClick(event)}
                                                    className="p-2 hover:bg-[#0d1117] rounded cursor-pointer transition-colors"
                                                >
                                                    <div className="flex items-start space-x-2">
                                                        <div className="w-2 h-2 bg-[#f85149] rounded-full mt-2 flex-shrink-0"></div>
                                                        <div className="flex-1 min-w-0">
                                                            <p className="text-sm text-[#e6edf3] font-medium truncate">
                                                                {resource?.resourceName || 'Unknown Resource'}
                                                            </p>
                                                            <p className="text-xs text-[#8b949e] mt-1">{event.details}</p>
                                                            <p className="text-xs text-[#8b949e] mt-1">{formatTimeAgo(event.occurredAt)}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}

                                {/* This Week Notifications */}
                                {notifications.this_week.length > 0 && (
                                    <div className="p-3 border-b border-[#30363d]">
                                        <h4 className="text-sm font-medium text-[#58a6ff] mb-2">This Week</h4>
                                        {notifications.this_week.slice(0, 5).map(event => {
                                            const resource = getResourceById(event.resourceId);
                                            return (
                                                <div
                                                    key={event.id}
                                                    onClick={() => handleNotificationClick(event)}
                                                    className="p-2 hover:bg-[#0d1117] rounded cursor-pointer transition-colors"
                                                >
                                                    <div className="flex items-start space-x-2">
                                                        <div className="w-2 h-2 bg-[#58a6ff] rounded-full mt-2 flex-shrink-0"></div>
                                                        <div className="flex-1 min-w-0">
                                                            <p className="text-sm text-[#e6edf3] truncate">
                                                                {resource?.resourceName || 'Unknown Resource'}
                                                            </p>
                                                            <p className="text-xs text-[#8b949e] mt-1">{event.details}</p>
                                                            <p className="text-xs text-[#8b949e] mt-1">{formatTimeAgo(event.occurredAt)}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}

                                {/* Empty State */}
                                {totalNotifications === 0 && (
                                    <div className="p-6 text-center">
                                        <Icon name="bell-off" size={32} className="text-[#8b949e] mx-auto mb-2" />
                                        <p className="text-[#8b949e] text-sm">No new notifications</p>
                                        <p className="text-[#8b949e] text-xs mt-1">We'll notify you when there are updates</p>
                                    </div>
                                )}

                                {/* Footer */}
                                {totalNotifications > 0 && (
                                    <div className="p-3 border-t border-[#30363d]">
                                        <button
                                            onClick={() => {
                                                setShowDropdown(false);
                                                // Navigate to notifications page (TODO: implement routing)
                                            }}
                                            className="w-full text-center text-sm text-[#58a6ff] hover:text-[#79c0ff] transition-colors"
                                        >
                                            View all notifications
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Settings Button Component
        function SettingsButton({ currentUser }) {
            const [showModal, setShowModal] = useState(false);

            console.log('SettingsButton: Rendering', {
                currentUser,
                NOTIFICATIONS_V1_ENABLED,
                showModal
            });

            if (!NOTIFICATIONS_V1_ENABLED) return null;

            return (
                <>
                    <button
                        onClick={() => {
                            console.log('SettingsButton: Button clicked, opening modal');
                            setShowModal(true);
                        }}
                        className="p-2 bg-[#30363d] hover:bg-[#484f58] text-[#e6edf3] rounded-lg transition-colors"
                        title="Settings"
                        style={{ minWidth: '40px', minHeight: '40px' }}
                    >
                        <Icon name="settings" size={16} />
                        
                    </button>

                    {showModal && (
                        <SettingsModal
                            currentUser={currentUser}
                            onClose={() => setShowModal(false)}
                        />
                    )}
                </>
            );
        }

        // Settings Modal Component
        function SettingsModal({ currentUser, onClose }) {
            console.log('SettingsModal: Component rendered', { currentUser, onClose: typeof onClose });

            const [activeTab, setActiveTab] = useState('notifications');
            const [isEnabling, setIsEnabling] = useState(false);
            const [showSuccessToast, setShowSuccessToast] = useState(false);
            const [showUndoToast, setShowUndoToast] = useState(false);
            const [preferencesModified, setPreferencesModified] = useState(false);

            // Get user permissions
            const permissions = NotificationService.getUserPermissions(currentUser);
            const userPrograms = NotificationService.getUserPrograms(currentUser.id);

            console.log('SettingsModal: User data loaded', {
                currentUser,
                permissions,
                userPrograms,
                userProgramsLength: userPrograms.length
            });

            // Load user preferences for each program
            const [programPreferences, setProgramPreferences] = useState({});

            useEffect(() => {
                console.log('SettingsModal: Loading preferences for programs', userPrograms);
                if (userPrograms.length > 0) {
                    const prefs = {};
                    userPrograms.forEach(program => {
                        prefs[program.id] = NotificationService.getUserPreferences(currentUser.id, program.id);
                    });
                    console.log('SettingsModal: Loaded preferences', prefs);
                    setProgramPreferences(prefs);
                }
            }, [currentUser.id, userPrograms]);

            const handleEnableNotifications = async () => {
                setIsEnabling(true);
                try {
                    const result = NotificationService.enableNotificationsForUser(currentUser.id);
                    if (result.success) {
                        setShowSuccessToast(true);
                        setPreferencesModified(true);

                        // Refresh preferences
                        const prefs = {};
                        userPrograms.forEach(program => {
                            prefs[program.id] = NotificationService.getUserPreferences(currentUser.id, program.id);
                        });
                        setProgramPreferences(prefs);

                        setTimeout(() => setShowSuccessToast(false), 5000);
                    }
                } catch (error) {
                    console.error('Failed to enable notifications:', error);
                } finally {
                    setIsEnabling(false);
                }
            };

            const handleUndoEnable = () => {
                // Reset preferences (simplified for demo)
                userPrograms.forEach(program => {
                    NotificationService.saveUserPreferences(currentUser.id, program.id, {});
                });

                setProgramPreferences({});
                setPreferencesModified(false);
                setShowUndoToast(true);
                setTimeout(() => setShowUndoToast(false), 3000);
            };

            const updateProgramPreference = (programId, cadence, updates) => {
                const currentPrefs = { ...programPreferences };
                if (!currentPrefs[programId]) {
                    currentPrefs[programId] = NotificationService.createDefaultPreferences(currentUser.id, programId);
                }

                currentPrefs[programId][cadence] = {
                    ...currentPrefs[programId][cadence],
                    ...updates
                };

                setProgramPreferences(currentPrefs);

                // Save to service
                NotificationService.saveUserPreferences(currentUser.id, programId, currentPrefs[programId]);
            };

            const hasAnyPreferences = Object.keys(programPreferences).length > 0 &&
                Object.values(programPreferences).some(prefs => Object.keys(prefs).length > 0);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay">
                    <div className="bg-[#161b22] border border-[#30363d] rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden modal-content">
                        {/* Header */}
                        <div className="p-6 border-b border-[#30363d]">
                            <div className="flex items-center justify-between">
                                <h2 className="text-xl font-semibold text-[#e6edf3]">Settings</h2>
                                <button
                                    onClick={onClose}
                                    className="text-[#8b949e] hover:text-[#e6edf3] transition-colors"
                                >
                                    <Icon name="x" size={24} />
                                </button>
                            </div>
                        </div>

                        {/* Success Toast */}
                        {showSuccessToast && (
                            <div className="mx-6 mt-4 p-3 bg-[#238636] bg-opacity-20 border border-[#238636] rounded-lg flex items-center justify-between">
                                <div className="flex items-center space-x-2">
                                    <Icon name="check-circle" className="text-[#238636]" size={16} />
                                    <span className="text-[#238636] text-sm">
                                        Notifications enabled! Default settings applied to {userPrograms.length} program(s).
                                    </span>
                                </div>
                                <button
                                    onClick={handleUndoEnable}
                                    className="text-[#238636] hover:text-[#2ea043] text-sm underline"
                                >
                                    Undo
                                </button>
                            </div>
                        )}

                        {/* Undo Toast */}
                        {showUndoToast && (
                            <div className="mx-6 mt-4 p-3 bg-[#8b949e] bg-opacity-20 border border-[#8b949e] rounded-lg flex items-center space-x-2">
                                <Icon name="info" className="text-[#8b949e]" size={16} />
                                <span className="text-[#8b949e] text-sm">
                                    Notification settings have been reset.
                                </span>
                            </div>
                        )}

                        {/* Tabs */}
                        <div className="flex border-b border-[#30363d] px-6">
                            <button
                                onClick={() => setActiveTab('notifications')}
                                className={`px-4 py-3 text-sm font-medium transition-colors border-b-2 ${
                                    activeTab === 'notifications'
                                        ? 'text-[#58a6ff] border-[#58a6ff]'
                                        : 'text-[#8b949e] border-transparent hover:text-[#e6edf3]'
                                }`}
                            >
                                Notifications
                            </button>
                            <button
                                onClick={() => setActiveTab('reports')}
                                className={`px-4 py-3 text-sm font-medium transition-colors border-b-2 ${
                                    activeTab === 'reports'
                                        ? 'text-[#58a6ff] border-[#58a6ff]'
                                        : 'text-[#8b949e] border-transparent hover:text-[#e6edf3]'
                                }`}
                            >
                                Reports
                            </button>
                            {permissions.canManageRoleSettings && (
                                <button
                                    onClick={() => setActiveTab('admin')}
                                    className={`px-4 py-3 text-sm font-medium transition-colors border-b-2 ${
                                        activeTab === 'admin'
                                            ? 'text-[#58a6ff] border-[#58a6ff]'
                                            : 'text-[#8b949e] border-transparent hover:text-[#e6edf3]'
                                    }`}
                                >
                                    <Icon name="shield" size={14} className="inline mr-1" />
                                    Role Administration
                                </button>
                            )}
                        </div>

                        {/* Content */}
                        <div className="p-6 max-h-[60vh] overflow-y-auto">
                            {activeTab === 'notifications' && (
                                <NotificationSettings
                                    currentUser={currentUser}
                                    userPrograms={userPrograms}
                                    programPreferences={programPreferences}
                                    onUpdatePreference={updateProgramPreference}
                                    hasAnyPreferences={hasAnyPreferences}
                                    onEnableNotifications={handleEnableNotifications}
                                    isEnabling={isEnabling}
                                    permissions={permissions}
                                />
                            )}

                            {activeTab === 'reports' && (
                                <ReportSettings
                                    currentUser={currentUser}
                                    userPrograms={userPrograms}
                                    permissions={permissions}
                                />
                            )}

                            {activeTab === 'admin' && permissions.canManageRoleSettings && (
                                <RoleAdministration
                                    currentUser={currentUser}
                                    permissions={permissions}
                                />
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Role Administration Component (Admin Only)
        function RoleAdministration({ currentUser, permissions }) {
            const [roleConfigs, setRoleConfigs] = useState({});
            const [editingRole, setEditingRole] = useState(null);
            const [savedChanges, setSavedChanges] = useState(false);

            useEffect(() => {
                const configs = NotificationService.getAllRoleConfigurations();
                setRoleConfigs(configs);
            }, []);

            const handleUpdateRoleConfig = (role, field, value) => {
                const updatedConfigs = {
                    ...roleConfigs,
                    [role]: {
                        ...roleConfigs[role],
                        [field]: value
                    }
                };
                setRoleConfigs(updatedConfigs);
            };

            const handleSaveRoleConfig = (role) => {
                const success = NotificationService.updateRoleReportingConfig(role, roleConfigs[role]);
                if (success) {
                    setSavedChanges(true);
                    setEditingRole(null);
                    setTimeout(() => setSavedChanges(false), 3000);
                }
            };

            const allFrequencies = ['weekly', 'monthly', 'quarterly', 'yearly', 'as_needed'];

            const roleHierarchy = [
                { category: 'Administrators', roles: ['Administrator'] },
                { category: 'Management', roles: ['Research Director', 'Program Manager', 'Project Manager'] },
                { category: 'Analysts', roles: ['Senior Data Analyst', 'Data Analyst', 'Analyst'] },
                { category: 'Support Staff', roles: ['Coordinator', 'Researcher'] }
            ];

            return (
                <div className="space-y-6">
                    <div>
                        <h3 className="text-lg font-semibold text-[#e6edf3] mb-2">
                            Role-Based Reporting Administration
                        </h3>
                        <p className="text-sm text-[#8b949e] mb-4">
                            Configure reporting frequency permissions and limits for each role level.
                        </p>
                    </div>

                    {savedChanges && (
                        <div className="p-3 bg-[#238636] bg-opacity-20 border border-[#238636] rounded-lg flex items-center space-x-2">
                            <Icon name="check-circle" className="text-[#238636]" size={16} />
                            <span className="text-[#238636] text-sm">
                                Role configuration updated successfully.
                            </span>
                        </div>
                    )}

                    {roleHierarchy.map(group => (
                        <div key={group.category} className="space-y-4">
                            <h4 className="text-md font-medium text-[#e6edf3] border-b border-[#30363d] pb-2">
                                {group.category}
                            </h4>

                            {group.roles.map(role => {
                                const config = roleConfigs[role];
                                if (!config) return null;

                                const isEditing = editingRole === role;

                                return (
                                    <div key={role} className="p-4 bg-[#0d1117] border border-[#30363d] rounded-lg">
                                        <div className="flex items-center justify-between mb-4">
                                            <div>
                                                <h5 className="text-sm font-medium text-[#e6edf3]">{role}</h5>
                                                <p className="text-xs text-[#8b949e]">
                                                    Max Reports: {config.maxConcurrentReports === 'unlimited' ? 'Unlimited' : config.maxConcurrentReports} |
                                                    Retention: {config.reportRetentionDays} days
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => setEditingRole(isEditing ? null : role)}
                                                className="px-3 py-1 text-sm bg-[#30363d] hover:bg-[#484f58] text-[#e6edf3] rounded transition-colors"
                                            >
                                                {isEditing ? 'Cancel' : 'Edit'}
                                            </button>
                                        </div>

                                        {isEditing ? (
                                            <div className="space-y-4">
                                                {/* Allowed Frequencies */}
                                                <div>
                                                    <label className="block text-sm font-medium text-[#e6edf3] mb-2">
                                                        Allowed Reporting Frequencies
                                                    </label>
                                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                                        {allFrequencies.map(freq => (
                                                            <label key={freq} className="flex items-center space-x-2">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={config.allowedFrequencies.includes(freq)}
                                                                    onChange={(e) => {
                                                                        const newFreqs = e.target.checked
                                                                            ? [...config.allowedFrequencies, freq]
                                                                            : config.allowedFrequencies.filter(f => f !== freq);
                                                                        handleUpdateRoleConfig(role, 'allowedFrequencies', newFreqs);
                                                                    }}
                                                                    className="bg-[#161b22] border border-[#30363d] rounded"
                                                                />
                                                                <span className="text-sm text-[#e6edf3] capitalize">
                                                                    {freq.replace('_', ' ')}
                                                                </span>
                                                            </label>
                                                        ))}
                                                    </div>
                                                </div>

                                                {/* Max Concurrent Reports */}
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-medium text-[#e6edf3] mb-2">
                                                            Max Concurrent Reports
                                                        </label>
                                                        <select
                                                            value={config.maxConcurrentReports}
                                                            onChange={(e) => handleUpdateRoleConfig(role, 'maxConcurrentReports',
                                                                e.target.value === 'unlimited' ? 'unlimited' : parseInt(e.target.value)
                                                            )}
                                                            className="w-full bg-[#161b22] border border-[#30363d] rounded px-3 py-2 text-[#e6edf3]"
                                                        >
                                                            <option value="1">1</option>
                                                            <option value="2">2</option>
                                                            <option value="3">3</option>
                                                            <option value="5">5</option>
                                                            <option value="8">8</option>
                                                            <option value="10">10</option>
                                                            <option value="15">15</option>
                                                            <option value="unlimited">Unlimited</option>
                                                        </select>
                                                    </div>

                                                    <div>
                                                        <label className="block text-sm font-medium text-[#e6edf3] mb-2">
                                                            Report Retention (Days)
                                                        </label>
                                                        <select
                                                            value={config.reportRetentionDays}
                                                            onChange={(e) => handleUpdateRoleConfig(role, 'reportRetentionDays', parseInt(e.target.value))}
                                                            className="w-full bg-[#161b22] border border-[#30363d] rounded px-3 py-2 text-[#e6edf3]"
                                                        >
                                                            <option value="30">30 days</option>
                                                            <option value="60">60 days</option>
                                                            <option value="90">90 days</option>
                                                            <option value="120">120 days</option>
                                                            <option value="180">180 days</option>
                                                            <option value="270">270 days</option>
                                                            <option value="365">365 days</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                {/* Custom Reports Permission */}
                                                <div>
                                                    <label className="flex items-center space-x-2">
                                                        <input
                                                            type="checkbox"
                                                            checked={config.canScheduleCustomReports}
                                                            onChange={(e) => handleUpdateRoleConfig(role, 'canScheduleCustomReports', e.target.checked)}
                                                            className="bg-[#161b22] border border-[#30363d] rounded"
                                                        />
                                                        <span className="text-sm text-[#e6edf3]">
                                                            Can schedule custom reports
                                                        </span>
                                                    </label>
                                                </div>

                                                <button
                                                    onClick={() => handleSaveRoleConfig(role)}
                                                    className="px-4 py-2 bg-[#238636] hover:bg-[#2ea043] text-white rounded transition-colors"
                                                >
                                                    Save Configuration
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="space-y-2">
                                                <div>
                                                    <span className="text-xs text-[#8b949e] font-medium">Allowed Frequencies:</span>
                                                    <div className="flex flex-wrap gap-1 mt-1">
                                                        {config.allowedFrequencies.map(freq => (
                                                            <span key={freq} className="text-xs px-2 py-1 bg-[#30363d] text-[#e6edf3] rounded capitalize">
                                                                {freq.replace('_', ' ')}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div className="text-xs text-[#8b949e]">
                                                    <span className="font-medium">Custom Reports:</span> {config.canScheduleCustomReports ? 'Allowed' : 'Not Allowed'}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    ))}

                    {/* Quick Actions */}
                    <div className="p-4 bg-[#0d1117] border border-[#30363d] rounded-lg">
                        <h4 className="text-md font-medium text-[#e6edf3] mb-4">Quick Actions</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <button className="p-3 bg-[#30363d] hover:bg-[#484f58] text-[#e6edf3] rounded transition-colors text-left">
                                <div className="text-sm font-medium">Reset All to Defaults</div>
                                <div className="text-xs text-[#8b949e] mt-1">Restore default role configurations</div>
                            </button>
                            <button className="p-3 bg-[#30363d] hover:bg-[#484f58] text-[#e6edf3] rounded transition-colors text-left">
                                <div className="text-sm font-medium">Export Configuration</div>
                                <div className="text-xs text-[#8b949e] mt-1">Download current role settings</div>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Notification Settings Component
        function NotificationSettings({
            currentUser,
            userPrograms,
            programPreferences,
            onUpdatePreference,
            hasAnyPreferences,
            onEnableNotifications,
            isEnabling,
            permissions
        }) {
            // Get allowed frequencies for user's role
            const allowedFrequencies = NotificationService.getAllowedFrequenciesForUser(currentUser);
            const roleConfig = NotificationService.getRoleReportingConfig(currentUser.role);

            const allCadences = [
                { key: 'weekly', label: 'Weekly Digest', description: 'Summary of changes every week' },
                { key: 'monthly', label: 'Monthly Summary', description: 'Monthly overview of updates' },
                { key: 'quarterly', label: 'Quarterly Report', description: 'Quarterly program updates' },
                { key: 'yearly', label: 'Annual Review', description: 'Annual resource summary' },
                { key: 'as_needed', label: 'Urgent Updates', description: 'Immediate notifications for critical changes' }
            ];

            // Filter cadences based on user's role permissions
            const cadences = allCadences.filter(cadence => allowedFrequencies.includes(cadence.key));

            const timeOptions = [
                { value: '08:00', label: '8:00 AM' },
                { value: '09:00', label: '9:00 AM' },
                { value: '10:00', label: '10:00 AM' },
                { value: '12:00', label: '12:00 PM' },
                { value: '17:00', label: '5:00 PM' }
            ];

            const dayOptions = [
                { value: 1, label: 'Monday' },
                { value: 2, label: 'Tuesday' },
                { value: 3, label: 'Wednesday' },
                { value: 4, label: 'Thursday' },
                { value: 5, label: 'Friday' }
            ];

            return (
                <div className="space-y-6">
                    {/* Enable Notifications Section */}
                    {!hasAnyPreferences && (
                        <div className="p-6 bg-[#0d1117] border border-[#30363d] rounded-lg">
                            <div className="text-center">
                                <Icon name="bell" size={48} className="text-[#58a6ff] mx-auto mb-4" />
                                <h3 className="text-lg font-semibold text-[#e6edf3] mb-2">
                                    Enable Notifications & Reports
                                </h3>
                                <p className="text-[#8b949e] mb-6 max-w-lg mx-auto">
                                    Stay updated with automatic notifications about resource changes, weekly digests,
                                    and program updates. We'll set up sensible defaults for all your programs.
                                </p>
                                <button
                                    onClick={onEnableNotifications}
                                    disabled={isEnabling}
                                    className="px-6 py-3 bg-[#238636] hover:bg-[#2ea043] disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg transition-colors font-medium flex items-center space-x-2 mx-auto"
                                >
                                    {isEnabling ? (
                                        <>
                                            <Icon name="loader-2" size={16} className="animate-spin" />
                                            <span>Setting up...</span>
                                        </>
                                    ) : (
                                        <>
                                            <Icon name="bell" size={16} />
                                            <span>Enable Notifications & Reports</span>
                                        </>
                                    )}
                                </button>
                                <p className="text-xs text-[#8b949e] mt-4">
                                    Default: Weekly digest on Monday at 9:00 AM + urgent updates
                                </p>
                            </div>
                        </div>
                    )}

                    {/* Role-based limitations notice */}
                    {hasAnyPreferences && (
                        <div className="p-4 bg-[#0d1117] border border-[#30363d] rounded-lg">
                            <div className="flex items-center space-x-2 mb-3">
                                <Icon name="user" size={16} className="text-[#58a6ff]" />
                                <h4 className="text-sm font-medium text-[#e6edf3]">
                                    Your Role: {currentUser.role}
                                </h4>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
                                <div>
                                    <span className="text-[#8b949e] font-medium">Available Frequencies:</span>
                                    <div className="flex flex-wrap gap-1 mt-1">
                                        {allowedFrequencies.map(freq => (
                                            <span key={freq} className="px-2 py-1 bg-[#30363d] text-[#e6edf3] rounded capitalize">
                                                {freq.replace('_', ' ')}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <span className="text-[#8b949e] font-medium">Max Reports:</span>
                                    <div className="text-[#e6edf3] mt-1">
                                        {roleConfig.maxConcurrentReports === 'unlimited' ? 'Unlimited' : roleConfig.maxConcurrentReports}
                                    </div>
                                </div>
                                <div>
                                    <span className="text-[#8b949e] font-medium">Report Retention:</span>
                                    <div className="text-[#e6edf3] mt-1">
                                        {roleConfig.reportRetentionDays} days
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Program-specific preferences */}
                    {hasAnyPreferences && userPrograms.length > 0 && (
                        <div className="space-y-6">
                            <div>
                                <h3 className="text-lg font-semibold text-[#e6edf3] mb-2">
                                    Program Notification Preferences
                                </h3>
                                <p className="text-sm text-[#8b949e] mb-4">
                                    Configure how you want to receive notifications for each program you're part of.
                                    <span className="text-[#f85149] font-medium"> Available frequencies are limited by your role.</span>
                                </p>
                            </div>

                            {userPrograms.map(program => {
                                const prefs = programPreferences[program.id] || {};
                                return (
                                    <div key={program.id} className="p-6 bg-[#0d1117] border border-[#30363d] rounded-lg">
                                        <div className="flex items-center space-x-3 mb-6">
                                            <div
                                                className="w-4 h-4 rounded"
                                                style={{ backgroundColor: program.color }}
                                            ></div>
                                            <h4 className="text-lg font-medium text-[#e6edf3]">{program.name}</h4>
                                            <span className="text-sm text-[#8b949e]">({program.shortName})</span>
                                            <span className="text-xs px-2 py-1 bg-[#30363d] text-[#8b949e] rounded">
                                                {program.membershipRole}
                                            </span>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            {cadences.map(cadence => {
                                                const pref = prefs[cadence.key] || { enabled: false };
                                                return (
                                                    <div key={cadence.key} className="space-y-3">
                                                        <div className="flex items-center justify-between">
                                                            <div>
                                                                <label className="text-sm font-medium text-[#e6edf3]">
                                                                    {cadence.label}
                                                                </label>
                                                                <p className="text-xs text-[#8b949e]">
                                                                    {cadence.description}
                                                                </p>
                                                            </div>
                                                            <div className="flex items-center">
                                                                <button
                                                                    onClick={() => onUpdatePreference(program.id, cadence.key, {
                                                                        enabled: !pref.enabled
                                                                    })}
                                                                    className={`w-12 h-6 rounded-full transition-colors ${
                                                                        pref.enabled ? 'bg-[#238636]' : 'bg-[#30363d]'
                                                                    }`}
                                                                >
                                                                    <div
                                                                        className={`w-4 h-4 bg-white rounded-full transition-transform ${
                                                                            pref.enabled ? 'translate-x-7' : 'translate-x-1'
                                                                        }`}
                                                                    ></div>
                                                                </button>
                                                            </div>
                                                        </div>

                                                        {/* Time/day settings for periodic notifications */}
                                                        {pref.enabled && cadence.key !== 'as_needed' && (
                                                            <div className="grid grid-cols-2 gap-3">
                                                                {(cadence.key === 'weekly' || cadence.key === 'monthly') && (
                                                                    <div>
                                                                        <label className="block text-xs text-[#8b949e] mb-1">
                                                                            {cadence.key === 'weekly' ? 'Day' : 'Day of Month'}
                                                                        </label>
                                                                        <select
                                                                            value={pref.digestDayOfWeek || 1}
                                                                            onChange={(e) => onUpdatePreference(program.id, cadence.key, {
                                                                                digestDayOfWeek: parseInt(e.target.value)
                                                                            })}
                                                                            className="w-full bg-[#161b22] border border-[#30363d] rounded px-2 py-1 text-[#e6edf3] text-xs"
                                                                        >
                                                                            {(cadence.key === 'weekly' ? dayOptions :
                                                                              Array.from({length: 28}, (_, i) => ({ value: i + 1, label: `${i + 1}` }))
                                                                            ).map(option => (
                                                                                <option key={option.value} value={option.value}>
                                                                                    {option.label}
                                                                                </option>
                                                                            ))}
                                                                        </select>
                                                                    </div>
                                                                )}
                                                                <div>
                                                                    <label className="block text-xs text-[#8b949e] mb-1">Time</label>
                                                                    <select
                                                                        value={pref.digestTime || '09:00'}
                                                                        onChange={(e) => onUpdatePreference(program.id, cadence.key, {
                                                                            digestTime: e.target.value
                                                                        })}
                                                                        className="w-full bg-[#161b22] border border-[#30363d] rounded px-2 py-1 text-[#e6edf3] text-xs"
                                                                    >
                                                                        {timeOptions.map(option => (
                                                                            <option key={option.value} value={option.value}>
                                                                                {option.label}
                                                                            </option>
                                                                        ))}
                                                                    </select>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Global Settings */}
                    {hasAnyPreferences && (
                        <div className="p-6 bg-[#0d1117] border border-[#30363d] rounded-lg">
                            <h4 className="text-lg font-medium text-[#e6edf3] mb-4">Global Settings</h4>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-[#e6edf3] mb-2">
                                        Notification Channels
                                    </label>
                                    <div className="flex flex-wrap gap-3">
                                        {['email', 'in_app'].map(channel => (
                                            <label key={channel} className="flex items-center space-x-2">
                                                <input
                                                    type="checkbox"
                                                    checked={true}
                                                    disabled={channel === 'in_app'} // Always enabled for demo
                                                    className="bg-[#161b22] border border-[#30363d] rounded"
                                                />
                                                <span className="text-sm text-[#e6edf3] capitalize">
                                                    {channel.replace('_', '-')}
                                                </span>
                                                {channel === 'in_app' && (
                                                    <span className="text-xs text-[#8b949e]">(always enabled)</span>
                                                )}
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-[#e6edf3] mb-2">
                                        Timezone
                                    </label>
                                    <select
                                        value="America/New_York"
                                        disabled
                                        className="bg-[#161b22] border border-[#30363d] rounded px-3 py-2 text-[#e6edf3] opacity-50"
                                    >
                                        <option value="America/New_York">Eastern Time (America/New_York)</option>
                                    </select>
                                    <p className="text-xs text-[#8b949e] mt-1">
                                        Timezone configuration will be available in a future update.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Report Settings Component
        function ReportSettings({ currentUser, userPrograms, permissions }) {
            const [reportSchedules, setReportSchedules] = useState([]);
            const roleConfig = NotificationService.getRoleReportingConfig(currentUser.role);
            const hasReachedMaxReports = NotificationService.hasReachedMaxReports(currentUser.id);

            useEffect(() => {
                // Load existing report schedules for this user
                const userSchedules = NOTIFICATION_DATABASE.reportSchedules.filter(
                    schedule => schedule.userId === currentUser.id
                );
                setReportSchedules(userSchedules);
            }, [currentUser.id]);

            const createReportSchedule = (scope, programIds, cadence) => {
                // Check if user has reached max reports
                if (hasReachedMaxReports) {
                    alert(`You have reached the maximum number of concurrent reports (${roleConfig.maxConcurrentReports}) for your role.`);
                    return;
                }
                const newSchedule = {
                    id: Date.now(),
                    userId: currentUser.id,
                    scope,
                    programIds,
                    cadence,
                    nextRunAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // Next week
                    timezone: 'America/New_York',
                    enabled: true,
                    createdAt: new Date()
                };

                NOTIFICATION_DATABASE.reportSchedules.push(newSchedule);
                setReportSchedules([...reportSchedules, newSchedule]);
            };

            return (
                <div className="space-y-6">
                    <div>
                        <h3 className="text-lg font-semibold text-[#e6edf3] mb-2">
                            Report Scheduling
                        </h3>
                        <p className="text-sm text-[#8b949e] mb-4">
                            Configure automatic report generation and delivery for your programs.
                        </p>
                    </div>

                    {/* Role-based access notice */}
                    <div className="p-4 bg-[#0d1117] border border-[#30363d] rounded-lg">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center space-x-2">
                                <Icon name="shield" size={16} className="text-[#58a6ff]" />
                                <span className="text-sm font-medium text-[#e6edf3]">
                                    Access Level: {permissions.level.toUpperCase()}
                                </span>
                            </div>
                            <div className="text-xs text-[#8b949e]">
                                {roleConfig.maxConcurrentReports === 'unlimited' ? 'Unlimited Reports' :
                                `${reportSchedules.length}/${roleConfig.maxConcurrentReports} Reports Used`}
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
                            <div>
                                <div className="text-[#8b949e] space-y-1">
                                    {permissions.canViewAll && <p> Can create cross-program reports</p>}
                                    {permissions.canManagePrograms && <p> Can create program-specific reports</p>}
                                    {!permissions.canViewAll && <p> Limited to your assigned programs</p>}
                                    {roleConfig.canScheduleCustomReports && <p> Can schedule custom reports</p>}
                                </div>
                            </div>
                            <div>
                                <div className="text-[#8b949e]">
                                    <p><span className="font-medium">Retention:</span> {roleConfig.reportRetentionDays} days</p>
                                    <p><span className="font-medium">Role:</span> {currentUser.role}</p>
                                </div>
                            </div>
                        </div>
                        {hasReachedMaxReports && (
                            <div className="mt-3 p-2 bg-[#f85149] bg-opacity-20 border border-[#f85149] rounded text-xs text-[#f85149]">
                                 You have reached the maximum number of concurrent reports for your role.
                            </div>
                        )}
                    </div>

                    {/* Quick Actions */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {permissions.canViewAll && (
                            <button
                                onClick={() => createReportSchedule('ALL', [], 'weekly')}
                                disabled={hasReachedMaxReports}
                                className="p-4 bg-[#0d1117] border border-[#30363d] rounded-lg hover:border-[#58a6ff] transition-colors text-left disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <Icon name="globe" size={20} className="text-[#58a6ff] mb-2" />
                                <h4 className="text-sm font-medium text-[#e6edf3] mb-1">
                                    System-wide Weekly Report
                                </h4>
                                <p className="text-xs text-[#8b949e]">
                                    All programs and resources activity summary
                                </p>
                            </button>
                        )}

                        <button
                            onClick={() => createReportSchedule('PROGRAM', userPrograms.map(p => p.id), 'monthly')}
                            disabled={userPrograms.length === 0 || hasReachedMaxReports}
                            className="p-4 bg-[#0d1117] border border-[#30363d] rounded-lg hover:border-[#58a6ff] transition-colors text-left disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <Icon name="users" size={20} className="text-[#58a6ff] mb-2" />
                            <h4 className="text-sm font-medium text-[#e6edf3] mb-1">
                                My Programs Monthly Report
                            </h4>
                            <p className="text-xs text-[#8b949e]">
                                Activity summary for programs you manage
                            </p>
                        </button>
                    </div>

                    {/* Existing Schedules */}
                    {reportSchedules.length > 0 && (
                        <div>
                            <h4 className="text-md font-medium text-[#e6edf3] mb-4">Active Report Schedules</h4>
                            <div className="space-y-3">
                                {reportSchedules.map(schedule => (
                                    <div key={schedule.id} className="p-4 bg-[#0d1117] border border-[#30363d] rounded-lg">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <h5 className="text-sm font-medium text-[#e6edf3]">
                                                    {schedule.scope === 'ALL' ? 'System-wide' : 'Program-specific'} {schedule.cadence} Report
                                                </h5>
                                                <p className="text-xs text-[#8b949e] mt-1">
                                                    Next run: {schedule.nextRunAt.toLocaleDateString()} at {schedule.nextRunAt.toLocaleTimeString()}
                                                </p>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <span className={`text-xs px-2 py-1 rounded ${
                                                    schedule.enabled
                                                        ? 'bg-[#238636] bg-opacity-20 text-[#238636]'
                                                        : 'bg-[#f85149] bg-opacity-20 text-[#f85149]'
                                                }`}>
                                                    {schedule.enabled ? 'Active' : 'Paused'}
                                                </span>
                                                <button className="text-[#8b949e] hover:text-[#e6edf3] transition-colors">
                                                    <Icon name="more-horizontal" size={16} />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Report Preview */}
                    <div className="p-4 bg-[#0d1117] border border-[#30363d] rounded-lg">
                        <h4 className="text-md font-medium text-[#e6edf3] mb-4">Generate Report Now</h4>
                        <p className="text-sm text-[#8b949e] mb-4">
                            Create an instant report to see what your scheduled reports will look like.
                        </p>
                        <div className="flex gap-3">
                            <button className="px-4 py-2 bg-[#30363d] hover:bg-[#484f58] text-[#e6edf3] rounded-lg transition-colors text-sm">
                                Generate Weekly Summary
                            </button>
                            <button className="px-4 py-2 bg-[#30363d] hover:bg-[#484f58] text-[#e6edf3] rounded-lg transition-colors text-sm">
                                Download CSV Export
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Header Component
        function Header({ searchQuery, setSearchQuery, hasNotifications, currentUser, onLogout, onFileRequest, showStatsDropdown, setShowStatsDropdown, showRequestsDropdown, setShowRequestsDropdown, fileRequests, resources, programs, recentActivity, setShowBulkUpload, setShowNotificationSettings, onRefreshData, isLoading, dataError, lastUpdated }) {
            const [showProfile, setShowProfile] = useState(false);

            // Close dropdowns when clicking outside
            useEffect(() => {
                function handleClickOutside(event) {
                    if (!event.target.closest('.dropdown-container')) {
                        setShowStatsDropdown(false);
                        setShowRequestsDropdown(false);
                        setShowProfile(false);
                    }
                }

                document.addEventListener('mousedown', handleClickOutside);
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [setShowStatsDropdown, setShowRequestsDropdown]);

            // Calculate stats
            const stats = useMemo(() => {
                const total = resources.length;
                const govexCount = resources.filter(r => r.govexOrExternal === 'GovEx').length;
                const externalCount = resources.filter(r => r.govexOrExternal === 'External').length;
                const fillableCount = resources.filter(r => r.fillable).length;
                const multiLangCount = resources.filter(r =>
                    [r.englishLink, r.spanishLink, r.portugueseLink, r.italianLink].filter(Boolean).length > 1
                ).length;

                return { total, govexCount, externalCount, fillableCount, multiLangCount };
            }, [resources]);

            return (
                <header className="bg-[#161b22] border-b border-[#30363d] px-6 py-4">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-6 flex-1">
                            <div className="flex items-center space-x-3">
                                <div className="w-10 h-10 bg-[#137fec] rounded-lg flex items-center justify-center">
                                    <Icon name="book-open" className="text-white" size={24} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-semibold text-[#e6edf3]">GovEx Academy Resources</h1>
                                    <p className="text-xs text-[#8b949e]">Welcome back, {currentUser.name.split(' ')[0]}</p>
                                </div>
                            </div>
                            <UniversalSearch
                                currentUserId={currentUser?.id || 'anonymous'}
                                searchQuery={searchQuery}
                                setSearchQuery={setSearchQuery}
                                onOpen={(url) => window.open(url, '_blank', 'noopener,noreferrer')}
                            />
                        </div>
                        <div className="flex items-center space-x-4">
                            {/* Data Status Indicator */}
                            {dataError && (
                                <div className="flex items-center space-x-2 px-3 py-1 bg-[#f85149] bg-opacity-10 border border-[#f85149] rounded-lg">
                                    <Icon name="alert-circle" size={14} className="text-[#f85149]" />
                                    <span className="text-xs text-[#f85149]">Data sync error</span>
                                </div>
                            )}

                            {/* Last Updated Indicator */}
                            {lastUpdated && !dataError && (
                                <div className="text-xs text-[#8b949e]">
                                    Last updated: {lastUpdated.toLocaleTimeString()}
                                </div>
                            )}

                            {/* Refresh Button */}
                            <button
                                onClick={onRefreshData}
                                disabled={isLoading}
                                className="flex items-center space-x-2 px-3 py-2 bg-[#30363d] hover:bg-[#484f58] disabled:opacity-50 disabled:cursor-not-allowed text-[#e6edf3] rounded-lg transition-colors font-medium text-sm"
                                title="Refresh data from Google Sheets"
                            >
                                <Icon name={isLoading ? "loader-2" : "refresh-cw"} size={16} className={isLoading ? "animate-spin" : ""} />
                                <span>{isLoading ? 'Syncing...' : 'Refresh'}</span>
                            </button>

                            <button
                                onClick={onFileRequest}
                                className="flex items-center space-x-2 px-3 py-2 bg-[#137fec] hover:bg-[#1c5aa8] text-white rounded-lg transition-colors font-medium text-sm"
                            >
                                <Icon name="file-plus" size={16} />
                                <span>Request File</span>
                            </button>

                            {/* Notifications Bell */}
                            {NOTIFICATIONS_V1_ENABLED && <NotificationBell currentUser={currentUser} />}

                            {/* File Requests Button */}
                            <div className="relative dropdown-container">
                                <button
                                    onClick={() => setShowRequestsDropdown(!showRequestsDropdown)}
                                    className="flex items-center space-x-2 px-3 py-2 bg-[#30363d] hover:bg-[#484f58] text-[#e6edf3] rounded-lg transition-colors font-medium text-sm"
                                >
                                    <Icon name="file-text" size={16} />
                                    <span>File Requests</span>
                                    <Icon name="chevron-down" size={14} />
                                </button>

                                {showRequestsDropdown && (
                                    <div className="absolute right-0 mt-2 w-80 bg-[#161b22] border border-[#30363d] rounded-lg shadow-lg z-50">
                                        <div className="p-4">
                                            <h3 className="text-lg font-semibold text-[#e6edf3] mb-4">File Requests</h3>
                                            {fileRequests && fileRequests.length > 0 ? (
                                                <div className="space-y-3">
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div className="bg-[#0d1117] p-3 rounded-lg">
                                                            <div className="text-xs text-[#8b949e]">Active</div>
                                                            <div className="text-xl font-semibold text-[#e6edf3]">
                                                                {fileRequests.filter(r => ['Submitted', 'In Review', 'In Progress'].includes(r.status)).length}
                                                            </div>
                                                        </div>
                                                        <div className="bg-[#0d1117] p-3 rounded-lg">
                                                            <div className="text-xs text-[#8b949e]">Completed</div>
                                                            <div className="text-xl font-semibold text-[#e6edf3]">
                                                                {fileRequests.filter(r => r.status === 'Completed').length}
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div className="space-y-2">
                                                        <div className="text-sm font-medium text-[#e6edf3]">Recent Requests</div>
                                                        {fileRequests.slice(0, 3).map(request => (
                                                            <div key={request.id} className="bg-[#0d1117] p-3 rounded-lg">
                                                                <div className="flex items-start justify-between mb-1">
                                                                    <span className="text-sm text-[#e6edf3] line-clamp-2">
                                                                        {request.description.length > 35
                                                                            ? `${request.description.substring(0, 35)}...`
                                                                            : request.description}
                                                                    </span>
                                                                    <span className={`px-1.5 py-0.5 rounded-full text-xs font-medium text-white ml-2 ${
                                                                        request.status === 'Submitted' ? 'bg-blue-500' :
                                                                        request.status === 'In Review' ? 'bg-yellow-500' :
                                                                        request.status === 'In Progress' ? 'bg-purple-500' :
                                                                        request.status === 'Completed' ? 'bg-green-500' :
                                                                        'bg-gray-500'
                                                                    }`}>
                                                                        {request.status}
                                                                    </span>
                                                                </div>
                                                                <div className="text-xs text-[#8b949e]">
                                                                    {request.program}  {request.assignedTo}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>

                                                    <button
                                                        onClick={() => {
                                                            setShowRequestsDropdown(false);
                                                            onFileRequest();
                                                        }}
                                                        className="w-full mt-3 px-3 py-2 bg-[#137fec] hover:bg-[#1c5aa8] text-white rounded-lg transition-colors font-medium text-sm"
                                                    >
                                                        View All Requests
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="text-center py-4 text-[#8b949e]">
                                                    <Icon name="inbox" size={32} className="mx-auto mb-2 opacity-50" />
                                                    <p className="text-sm">No requests yet</p>
                                                    <button
                                                        onClick={() => {
                                                            setShowRequestsDropdown(false);
                                                            onFileRequest();
                                                        }}
                                                        className="mt-3 px-3 py-2 bg-[#137fec] hover:bg-[#1c5aa8] text-white rounded-lg transition-colors font-medium text-sm"
                                                    >
                                                        Create First Request
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Quick Stats Button */}
                            <div className="relative dropdown-container">
                                <button
                                    onClick={() => setShowStatsDropdown(!showStatsDropdown)}
                                    className="flex items-center space-x-2 px-3 py-2 bg-[#30363d] hover:bg-[#484f58] text-[#e6edf3] rounded-lg transition-colors font-medium text-sm"
                                >
                                    <Icon name="bar-chart-3" size={16} />
                                    <span>Quick Stats</span>
                                    <Icon name="chevron-down" size={14} />
                                </button>

                                {showStatsDropdown && (
                                    <div className="absolute right-0 mt-2 w-72 bg-[#161b22] border border-[#30363d] rounded-lg shadow-lg z-50">
                                        <div className="p-4">
                                            <h3 className="text-lg font-semibold text-[#e6edf3] mb-4">Quick Stats</h3>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div className="bg-[#0d1117] p-3 rounded-lg">
                                                    <div className="text-xs text-[#8b949e]">Total Resources</div>
                                                    <div className="text-xl font-semibold text-[#e6edf3]">{stats.total}</div>
                                                </div>
                                                <div className="bg-[#0d1117] p-3 rounded-lg">
                                                    <div className="text-xs text-[#8b949e]">GovEx Resources</div>
                                                    <div className="text-xl font-semibold text-[#e6edf3]">{stats.govexCount}</div>
                                                </div>
                                                <div className="bg-[#0d1117] p-3 rounded-lg">
                                                    <div className="text-xs text-[#8b949e]">External Resources</div>
                                                    <div className="text-xl font-semibold text-[#e6edf3]">{stats.externalCount}</div>
                                                </div>
                                                <div className="bg-[#0d1117] p-3 rounded-lg">
                                                    <div className="text-xs text-[#8b949e]">Fillable Templates</div>
                                                    <div className="text-xl font-semibold text-[#e6edf3]">{stats.fillableCount}</div>
                                                </div>
                                                <div className="bg-[#0d1117] p-3 rounded-lg col-span-2">
                                                    <div className="text-xs text-[#8b949e]">Multi-language</div>
                                                    <div className="text-xl font-semibold text-[#e6edf3]">{stats.multiLangCount}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <button className="relative p-2 hover:bg-[#30363d] rounded-lg transition-colors">
                                <Icon name="bell" className="text-[#8b949e]" />
                                {hasNotifications && (
                                    <span className="absolute top-1 right-1 w-2 h-2 bg-[#f85149] rounded-full"></span>
                                )}
                            </button>
                            <div className="relative dropdown-container">
                                <button
                                    onClick={() => setShowProfile(!showProfile)}
                                    className="flex items-center space-x-2 p-2 hover:bg-[#30363d] rounded-lg transition-colors"
                                >
                                    <div className="w-8 h-8 bg-[#137fec] rounded-full flex items-center justify-center">
                                        <span className="text-white text-sm font-medium">{currentUser.avatar}</span>
                                    </div>
                                    <div className="text-left">
                                        <div className="text-[#e6edf3] text-sm">{currentUser.name}</div>
                                        <div className="text-[#8b949e] text-xs">{currentUser.role}</div>
                                    </div>
                                    <Icon name="chevron-down" className="text-[#8b949e]" size={16} />
                                </button>
                                {showProfile && (
                                    <div className="absolute right-0 mt-2 w-48 bg-[#161b22] border border-[#30363d] rounded-lg shadow-lg z-50">
                                        <div className="px-4 py-3 border-b border-[#30363d]">
                                            <p className="text-sm font-medium text-[#e6edf3]">{currentUser.name}</p>
                                            <p className="text-xs text-[#8b949e]">{currentUser.email}</p>
                                        </div>
                                        <a href="#" className="block px-4 py-2 text-[#e6edf3] hover:bg-[#30363d] transition-colors">Profile</a>
                                        <div className="px-4 py-2">
                                            <div className="text-xs font-medium text-[#8b949e] uppercase tracking-wider mb-2">Settings</div>
                                            {currentUser?.role === 'Administrator' && bulkUserUploadConfig.featureFlag && (
                                                <button
                                                    onClick={() => {
                                                        setShowProfile(false);
                                                        setShowBulkUpload(true);
                                                    }}
                                                    className="w-full text-left block px-2 py-1 text-[#e6edf3] hover:bg-[#30363d] rounded transition-colors text-sm"
                                                >
                                                    <Icon name="users" className="mr-2" size={14} />
                                                    Bulk User Upload
                                                </button>
                                            )}
                                            {NOTIFICATIONS_V1_ENABLED && (
                                                <button
                                                    onClick={() => {
                                                        console.log('CLICK DEBUG: Button clicked');
                                                        console.log('CLICK DEBUG: setShowNotificationSettings type:', typeof setShowNotificationSettings);
                                                        console.log('CLICK DEBUG: setShowNotificationSettings value:', setShowNotificationSettings);

                                                        if (typeof setShowNotificationSettings !== 'function') {
                                                            console.error('ERROR: setShowNotificationSettings is not a function!');
                                                            return;
                                                        }

                                                        console.log('TEST 1 PASSED: Notification settings button clicked');
                                                        setShowProfile(false);
                                                        setShowNotificationSettings(true);
                                                        console.log('TEST 2 SETUP: State should be: showNotificationSettings = true');

                                                        // Test 2: Verify state change
                                                        setTimeout(() => {
                                                            const modal = document.querySelector('[data-test-modal="notification-settings"]');
                                                            if (modal) {
                                                                console.log('TEST 2 PASSED: State change verified - modal element found');
                                                            } else {
                                                                console.log('TEST 2 FAILED: Modal element not found after state change');
                                                            }
                                                        }, 100);
                                                    }}
                                                    className="w-full text-left block px-2 py-1 text-[#e6edf3] hover:bg-[#30363d] rounded transition-colors text-sm"
                                                >
                                                    <Icon name="bell" className="mr-2" size={14} />
                                                    Notifications & Reports
                                                </button>
                                            )}
                                            <button className="w-full text-left block px-2 py-1 text-[#e6edf3] hover:bg-[#30363d] rounded transition-colors text-sm">
                                                <Icon name="settings" className="mr-2" size={14} />
                                                Preferences
                                            </button>
                                        </div>
                                        <hr className="border-[#30363d]" />
                                        <button
                                            onClick={onLogout}
                                            className="w-full text-left px-4 py-2 text-[#e6edf3] hover:bg-[#30363d] transition-colors"
                                        >
                                            Sign out
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </header>
            );
        }

        // Sidebar Component
        function Sidebar({
            programs,
            resources,
            selectedFilters,
            setSelectedFilters,
            expandedPrograms,
            setExpandedPrograms,
            setShowProgramModal,
            resourceCounts
        }) {
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false);

            const toggleProgram = (programId) => {
                setExpandedPrograms(prev => ({
                    ...prev,
                    [programId]: !prev[programId]
                }));
            };

            const toggleCohort = (programId, cohortId) => {
                setSelectedFilters(prev => {
                    const key = `${programId}-${cohortId}`;
                    const newCohorts = new Set(prev.selectedCohorts);
                    if (newCohorts.has(key)) {
                        newCohorts.delete(key);
                    } else {
                        newCohorts.add(key);
                    }
                    return { ...prev, selectedCohorts: newCohorts };
                });
            };

            const toggleFilter = (filterType, value) => {
                setSelectedFilters(prev => {
                    if (filterType === 'fillableOnly') {
                        return { ...prev, fillableOnly: !prev.fillableOnly };
                    }

                    const newSet = new Set(prev[filterType]);
                    if (newSet.has(value)) {
                        newSet.delete(value);
                    } else {
                        newSet.add(value);
                    }
                    return { ...prev, [filterType]: newSet };
                });
            };

            // Get unique values for dynamic filters
            const uniqueTopics = [...new Set(resources.flatMap(r => r.topics))].sort();
            const uniqueAuthors = [...new Set(resources.flatMap(r => r.authors))].sort();
            const fileTypeGroups = {
                "Spreadsheet": [".xls", ".xlsx"],
                "Document": [".pdf"],
                "Word": [".doc", ".docx"],
                "Presentation": [".pptx"],
                "Web": [".html"]
            };

            if (sidebarCollapsed) {
                return (
                    <aside className="w-12 bg-[#161b22] border-r border-[#30363d] p-2">
                        <button
                            onClick={() => setSidebarCollapsed(false)}
                            className="p-2 hover:bg-[#30363d] rounded-lg transition-colors"
                        >
                            <Icon name="menu" className="text-[#8b949e]" />
                        </button>
                    </aside>
                );
            }

            return (
                <aside className="w-80 bg-[#161b22] border-r border-[#30363d] overflow-y-auto">
                    <div className="p-4">
                        <div className="flex items-center justify-between mb-4">
                            <h2 className="text-lg font-semibold text-[#e6edf3]">Filters</h2>
                            <button
                                onClick={() => setSidebarCollapsed(true)}
                                className="p-1 hover:bg-[#30363d] rounded transition-colors"
                            >
                                <Icon name="x" className="text-[#8b949e]" size={18} />
                            </button>
                        </div>

                        <div className="space-y-6">
                            {/* Programs & Cohorts */}
                            <div>
                                <h3 className="text-sm font-medium text-[#8b949e] mb-3">Programs & Cohorts</h3>
                                <div className="space-y-2">
                                    {programs.map(program => (
                                        <div key={program.id} className="border border-[#30363d] rounded-lg overflow-hidden">
                                            <button
                                                onClick={() => toggleProgram(program.id)}
                                                className="w-full px-3 py-2 flex items-center justify-between hover:bg-[#30363d] transition-colors"
                                            >
                                                <span className="text-[#e6edf3] text-sm font-medium">{program.name}</span>
                                                <Icon
                                                    name={expandedPrograms[program.id] ? "chevron-up" : "chevron-down"}
                                                    className="text-[#8b949e]"
                                                    size={16}
                                                />
                                            </button>
                                            {expandedPrograms[program.id] && (
                                                <div className="px-3 py-2 bg-[#0d1117] space-y-1">
                                                    {program.cohorts.map(cohort => {
                                                        const key = `${program.id}-${cohort.id}`;
                                                        const count = resourceCounts[key] || 0;
                                                        return (
                                                            <label key={cohort.id} className="flex items-center justify-between py-1 cursor-pointer hover:bg-[#161b22] px-2 rounded">
                                                                <div className="flex items-center">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={selectedFilters.selectedCohorts.has(key)}
                                                                        onChange={() => toggleCohort(program.id, cohort.id)}
                                                                        className="mr-2 rounded border-[#30363d] bg-[#0d1117] text-[#137fec] focus:ring-[#137fec]"
                                                                    />
                                                                    <span className="text-[#e6edf3] text-sm">{cohort.name}</span>
                                                                </div>
                                                                <span className="text-[#8b949e] text-xs">({count})</span>
                                                            </label>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                    <button
                                        onClick={() => setShowProgramModal(true)}
                                        className="w-full px-3 py-2 border border-dashed border-[#30363d] rounded-lg flex items-center justify-center space-x-2 hover:border-[#137fec] hover:bg-[#30363d] transition-colors"
                                    >
                                        <Icon name="plus" className="text-[#137fec]" size={16} />
                                        <span className="text-[#137fec] text-sm">Add Program</span>
                                    </button>
                                </div>
                            </div>

                            {/* Source Filter */}
                            <div>
                                <h3 className="text-sm font-medium text-[#8b949e] mb-3">Source</h3>
                                <div className="space-y-2">
                                    {["GovEx", "External"].map(source => (
                                        <label key={source} className="flex items-center cursor-pointer hover:bg-[#30363d] p-2 rounded">
                                            <input
                                                type="checkbox"
                                                checked={selectedFilters.sources.has(source)}
                                                onChange={() => toggleFilter('sources', source)}
                                                className="mr-2 rounded border-[#30363d] bg-[#0d1117] text-[#137fec] focus:ring-[#137fec]"
                                            />
                                            <span className="text-[#e6edf3] text-sm">{source} Resources</span>
                                        </label>
                                    ))}
                                </div>
                            </div>

                            {/* File Type Filter */}
                            <div>
                                <h3 className="text-sm font-medium text-[#8b949e] mb-3">File Type</h3>
                                <div className="space-y-2">
                                    {Object.entries(fileTypeGroups).map(([groupName, types]) => (
                                        <label key={groupName} className="flex items-center cursor-pointer hover:bg-[#30363d] p-2 rounded">
                                            <input
                                                type="checkbox"
                                                checked={types.some(type => selectedFilters.fileTypes.has(type))}
                                                onChange={() => {
                                                    types.forEach(type => toggleFilter('fileTypes', type));
                                                }}
                                                className="mr-2 rounded border-[#30363d] bg-[#0d1117] text-[#137fec] focus:ring-[#137fec]"
                                            />
                                            <span className="text-[#e6edf3] text-sm">
                                                {types.join(' / ')} ({groupName})
                                            </span>
                                        </label>
                                    ))}
                                </div>
                            </div>

                            {/* Fillable Filter */}
                            <div>
                                <h3 className="text-sm font-medium text-[#8b949e] mb-3">Template Type</h3>
                                <div className="space-y-2">
                                    <label className="flex items-center cursor-pointer hover:bg-[#30363d] p-2 rounded">
                                        <input
                                            type="checkbox"
                                            checked={selectedFilters.fillableOnly}
                                            onChange={() => toggleFilter('fillableOnly')}
                                            className="mr-2 rounded border-[#30363d] bg-[#0d1117] text-[#137fec] focus:ring-[#137fec]"
                                        />
                                        <span className="text-[#e6edf3] text-sm">Fillable Templates Only</span>
                                    </label>
                                </div>
                            </div>

                            {/* Topic Tags Filter */}
                            <div>
                                <h3 className="text-sm font-medium text-[#8b949e] mb-3">Topics</h3>
                                <div className="space-y-2 max-h-48 overflow-y-auto">
                                    {uniqueTopics.map(topic => (
                                        <label key={topic} className="flex items-center cursor-pointer hover:bg-[#30363d] p-2 rounded">
                                            <input
                                                type="checkbox"
                                                checked={selectedFilters.topics.has(topic)}
                                                onChange={() => toggleFilter('topics', topic)}
                                                className="mr-2 rounded border-[#30363d] bg-[#0d1117] text-[#137fec] focus:ring-[#137fec]"
                                            />
                                            <span className="text-[#e6edf3] text-sm">{topic}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>

                            {/* Authors Filter */}
                            <div>
                                <h3 className="text-sm font-medium text-[#8b949e] mb-3">Authors</h3>
                                <div className="space-y-2 max-h-32 overflow-y-auto">
                                    {uniqueAuthors.map(author => (
                                        <label key={author} className="flex items-center cursor-pointer hover:bg-[#30363d] p-2 rounded">
                                            <input
                                                type="checkbox"
                                                checked={selectedFilters.authors.has(author)}
                                                onChange={() => toggleFilter('authors', author)}
                                                className="mr-2 rounded border-[#30363d] bg-[#0d1117] text-[#137fec] focus:ring-[#137fec]"
                                            />
                                            <span className="text-[#e6edf3] text-sm">{author}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>

                            {/* Language Availability Filter */}
                            <div>
                                <h3 className="text-sm font-medium text-[#8b949e] mb-3">Language Availability</h3>
                                <div className="space-y-2">
                                    {[
                                        { code: 'english', label: 'English' },
                                        { code: 'spanish', label: 'Spanish' },
                                        { code: 'portuguese', label: 'Portuguese' },
                                        { code: 'italian', label: 'Italian' }
                                    ].map(lang => (
                                        <label key={lang.code} className="flex items-center cursor-pointer hover:bg-[#30363d] p-2 rounded">
                                            <input
                                                type="checkbox"
                                                checked={selectedFilters.languages.has(lang.code)}
                                                onChange={() => toggleFilter('languages', lang.code)}
                                                className="mr-2 rounded border-[#30363d] bg-[#0d1117] text-[#137fec] focus:ring-[#137fec]"
                                            />
                                            <span className="text-[#e6edf3] text-sm">{lang.label}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>

                            {/* Year Filter */}
                            <div>
                                <h3 className="text-sm font-medium text-[#8b949e] mb-3">Year Filter</h3>
                                <label className="flex items-center cursor-pointer hover:bg-[#30363d] p-2 rounded">
                                    <input
                                        type="checkbox"
                                        checked={selectedFilters.showRecent}
                                        onChange={(e) => setSelectedFilters(prev => ({ ...prev, showRecent: e.target.checked }))}
                                        className="mr-2 rounded border-[#30363d] bg-[#0d1117] text-[#137fec] focus:ring-[#137fec]"
                                    />
                                    <span className="text-[#e6edf3] text-sm">Show only 2024+</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </aside>
            );
        }

        // Resource Card Component
        function ResourceCard({ resource, programs, onToggleFavorite }) {
            const [showDownloadDropdown, setShowDownloadDropdown] = useState(false);

            const fileTypeIcons = {
                ".xlsx": "table-2", ".xls": "table-2",
                ".pdf": "file-text",
                ".docx": "file-text", ".doc": "file-text",
                ".pptx": "presentation",
                ".html": "globe"
            };

            const fileTypeColors = {
                ".xlsx": "bg-[#10b981]", ".xls": "bg-[#10b981]",
                ".pdf": "bg-[#f85149]",
                ".docx": "bg-[#3b82f6]", ".doc": "bg-[#3b82f6]",
                ".pptx": "bg-[#f59e0b]",
                ".html": "bg-[#8b5cf6]"
            };

            // Get programs for this resource
            const resourcePrograms = resource.programsUsed || [];

            // Get available languages
            const availableLanguages = [
                { code: 'EN', link: resource.englishLink, label: 'English' },
                { code: 'ES', link: resource.spanishLink, label: 'Spanish' },
                { code: 'PT', link: resource.portugueseLink, label: 'Portuguese' },
                { code: 'IT', link: resource.italianLink, label: 'Italian' }
            ].filter(lang => lang.link);

            return (
                <div className="bg-[#161b22] border border-[#30363d] rounded-lg p-4 hover:border-[#137fec] transition-all fade-in group">
                    {/* Header with badges */}
                    <div className="flex items-start justify-between mb-3">
                        <div className="flex flex-wrap items-center gap-1">
                            {/* Program badges */}
                            {resourcePrograms.map(programCode => (
                                <span
                                    key={programCode}
                                    className="px-2 py-1 text-xs font-medium rounded text-white bg-[#137fec]"
                                >
                                    {programCode}
                                </span>
                            ))}

                            {/* Source badge */}
                            <span className={`px-2 py-1 text-xs font-medium rounded text-white ${
                                resource.govexOrExternal === 'GovEx' ? 'bg-[#137fec]' : 'bg-[#10b981]'
                            }`}>
                                {resource.govexOrExternal}
                            </span>

                            {/* File type badge */}
                            <span className={`px-2 py-1 text-xs font-medium rounded text-white flex items-center space-x-1 ${
                                fileTypeColors[resource.fileType] || 'bg-[#8b949e]'
                            }`}>
                                <Icon name={fileTypeIcons[resource.fileType] || 'file'} size={12} />
                                <span>{resource.fileType}</span>
                            </span>
                        </div>

                        <button
                            onClick={(e) => {
                                e.stopPropagation();
                                onToggleFavorite(resource.id);
                            }}
                            className="p-1 hover:bg-[#30363d] rounded transition-colors"
                        >
                            <Icon
                                name="heart"
                                className={resource.isFavorite ? "text-[#f85149] fill-current" : "text-[#8b949e] group-hover:text-[#e6edf3]"}
                                size={16}
                            />
                        </button>
                    </div>

                    {/* Title */}
                    <h3 className="text-[#e6edf3] font-medium mb-2 group-hover:text-[#137fec] transition-colors">
                        {resource.resourceName}
                    </h3>

                    {/* Topic tags */}
                    {resource.topics && resource.topics.length > 0 && (
                        <div className="flex flex-wrap gap-1 mb-2">
                            {resource.topics.slice(0, 3).map(topic => (
                                <span
                                    key={topic}
                                    className="px-2 py-1 text-xs bg-[#30363d] text-[#8b949e] rounded"
                                >
                                    {topic}
                                </span>
                            ))}
                            {resource.topics.length > 3 && (
                                <span className="px-2 py-1 text-xs bg-[#30363d] text-[#8b949e] rounded">
                                    +{resource.topics.length - 3} more
                                </span>
                            )}
                        </div>
                    )}

                    {/* Description */}
                    <p className="text-[#8b949e] text-sm mb-3 line-clamp-2">"{resource.description}"</p>

                    {/* Authors */}
                    {resource.authors && resource.authors.length > 0 && (
                        <p className="text-[#8b949e] text-sm mb-2">
                            By: <span className="text-[#e6edf3]">{resource.authors.join(", ")}</span>
                        </p>
                    )}

                    {/* Language availability and fillable indicator */}
                    <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center space-x-2">
                            {/* Language icons */}
                            <div className="flex items-center space-x-1">
                                {availableLanguages.map(lang => (
                                    <span
                                        key={lang.code}
                                        className="px-1.5 py-0.5 text-xs bg-[#30363d] text-[#e6edf3] rounded"
                                        title={`Available in ${lang.label}`}
                                    >
                                        {lang.code}
                                    </span>
                                ))}
                            </div>
                        </div>

                        {/* Fillable indicator */}
                        {resource.fillable && (
                            <span className="px-2 py-1 text-xs bg-[#10b981] text-white rounded">
                                Fillable Template
                            </span>
                        )}
                    </div>

                    {/* Footer */}
                    <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-2 text-xs text-[#8b949e]">
                            <span>Updated {new Date(resource.lastUpdated).toLocaleDateString()}</span>
                            {resource.authors && resource.authors.length > 0 && (
                                <>
                                    <span></span>
                                    <span className="font-medium">By {resource.authors.join(', ')}</span>
                                </>
                            )}
                        </div>

                        {/* Multi-language download dropdown */}
                        <div className="relative">
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setShowDownloadDropdown(!showDownloadDropdown);
                                }}
                                className="px-3 py-1.5 bg-[#137fec] text-white rounded hover:bg-[#1c8fed] transition-colors text-sm flex items-center space-x-1"
                            >
                                <Icon name="download" size={14} />
                                <span>Download</span>
                                <Icon name="chevron-down" size={12} />
                            </button>

                            {showDownloadDropdown && (
                                <div className="absolute right-0 mt-1 w-40 bg-[#0d1117] border border-[#30363d] rounded shadow-lg z-10">
                                    {availableLanguages.map(lang => (
                                        <a
                                            key={lang.code}
                                            href={lang.link}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="block w-full text-left px-3 py-2 text-sm text-[#e6edf3] hover:bg-[#30363d] transition-colors"
                                            onClick={(e) => e.stopPropagation()}
                                        >
                                            Download ({lang.label})
                                        </a>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Right Sidebar Component
        function RightSidebar({ recentActivity, programs, resources, fileRequests, onQuickAccess }) {
            // Calculate quick stats
            const stats = useMemo(() => {
                const total = resources.length;
                const govexCount = resources.filter(r => r.govexOrExternal === 'GovEx').length;
                const externalCount = resources.filter(r => r.govexOrExternal === 'External').length;
                const fillableCount = resources.filter(r => r.fillable).length;
                const multiLangCount = resources.filter(r =>
                    [r.englishLink, r.spanishLink, r.portugueseLink, r.italianLink].filter(Boolean).length > 1
                ).length;

                return { total, govexCount, externalCount, fillableCount, multiLangCount };
            }, [resources]);

            return (
                <aside className="w-80 bg-[#161b22] border-l border-[#30363d] p-4 overflow-y-auto">
                    {/* Quick Stats */}
                    <div className="mb-6">
                        <h3 className="text-lg font-semibold text-[#e6edf3] mb-4">Quick Stats</h3>
                        <div className="space-y-3">
                            <div className="flex items-center justify-between p-3 bg-[#0d1117] rounded-lg">
                                <span className="text-sm text-[#8b949e]">Total Resources</span>
                                <span className="text-lg font-semibold text-[#e6edf3]">{stats.total}</span>
                            </div>
                            <div className="flex items-center justify-between p-3 bg-[#0d1117] rounded-lg">
                                <span className="text-sm text-[#8b949e]">GovEx Resources</span>
                                <span className="text-lg font-semibold text-[#137fec]">{stats.govexCount}</span>
                            </div>
                            <div className="flex items-center justify-between p-3 bg-[#0d1117] rounded-lg">
                                <span className="text-sm text-[#8b949e]">External Resources</span>
                                <span className="text-lg font-semibold text-[#10b981]">{stats.externalCount}</span>
                            </div>
                            <div className="flex items-center justify-between p-3 bg-[#0d1117] rounded-lg">
                                <span className="text-sm text-[#8b949e]">Fillable Templates</span>
                                <span className="text-lg font-semibold text-[#f59e0b]">{stats.fillableCount}</span>
                            </div>
                            <div className="flex items-center justify-between p-3 bg-[#0d1117] rounded-lg">
                                <span className="text-sm text-[#8b949e]">Multi-language</span>
                                <span className="text-lg font-semibold text-[#8b5cf6]">{stats.multiLangCount}</span>
                            </div>
                        </div>
                    </div>

                    {/* Recent Activity */}
                    <div className="mb-6">
                        <h3 className="text-lg font-semibold text-[#e6edf3] mb-4">Recent Activity</h3>
                        <div className="space-y-3">
                            {recentActivity.map(activity => {
                                const program = programs.find(p => p.id === activity.programId);
                                const cohort = program?.cohorts.find(c => c.id === activity.cohortId);
                                const isRequestActivity = activity.type === 'request_submitted' || activity.type === 'request_update';

                                return (
                                    <div key={activity.id} className="p-3 bg-[#0d1117] rounded-lg">
                                        <div className="flex items-start justify-between mb-1">
                                            <span className="text-sm font-medium text-[#e6edf3]">{activity.resource}</span>
                                            <span className="text-xs text-[#8b949e]">{activity.timestamp}</span>
                                        </div>
                                        <p className="text-xs text-[#8b949e] mb-1">{activity.description}</p>
                                        <div className="flex items-center space-x-2">
                                            {isRequestActivity ? (
                                                <>
                                                    <span className="px-1.5 py-0.5 text-xs rounded text-white bg-[#137fec]">
                                                        File Request
                                                    </span>
                                                    <span className="text-xs text-[#8b949e]">by {activity.user}</span>
                                                </>
                                            ) : (
                                                <>
                                                    <span
                                                        className="px-1.5 py-0.5 text-xs rounded text-white"
                                                        style={{ backgroundColor: program?.color || '#6b7280' }}
                                                    >
                                                        {program?.shortName || 'Unknown'}{cohort?.id || ''}
                                                    </span>
                                                    <span className="text-xs text-[#8b949e]">by {activity.user}</span>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* File Requests Summary */}
                    <div className="mb-6">
                        <h3 className="text-lg font-semibold text-[#e6edf3] mb-4">File Requests</h3>
                        {fileRequests && fileRequests.length > 0 ? (
                            <div className="space-y-3">
                                <div className="grid grid-cols-2 gap-2">
                                    <div className="bg-[#0d1117] p-3 rounded-lg">
                                        <div className="text-xs text-[#8b949e]">Active</div>
                                        <div className="text-xl font-semibold text-[#e6edf3]">
                                            {fileRequests.filter(r => ['Submitted', 'In Review', 'In Progress'].includes(r.status)).length}
                                        </div>
                                    </div>
                                    <div className="bg-[#0d1117] p-3 rounded-lg">
                                        <div className="text-xs text-[#8b949e]">Completed</div>
                                        <div className="text-xl font-semibold text-[#e6edf3]">
                                            {fileRequests.filter(r => r.status === 'Completed').length}
                                        </div>
                                    </div>
                                </div>

                                {/* Recent Requests */}
                                <div className="space-y-2">
                                    <div className="text-sm font-medium text-[#e6edf3]">Recent Requests</div>
                                    {fileRequests.slice(0, 3).map(request => (
                                        <div key={request.id} className="bg-[#0d1117] p-3 rounded-lg">
                                            <div className="flex items-start justify-between mb-1">
                                                <span className="text-sm text-[#e6edf3] line-clamp-2">
                                                    {request.description.length > 40
                                                        ? `${request.description.substring(0, 40)}...`
                                                        : request.description}
                                                </span>
                                                <span className={`px-1.5 py-0.5 rounded-full text-xs font-medium text-white ml-2 ${
                                                    request.status === 'Submitted' ? 'bg-blue-500' :
                                                    request.status === 'In Review' ? 'bg-yellow-500' :
                                                    request.status === 'In Progress' ? 'bg-purple-500' :
                                                    request.status === 'Completed' ? 'bg-green-500' :
                                                    'bg-gray-500'
                                                }`}>
                                                    {request.status}
                                                </span>
                                            </div>
                                            <div className="text-xs text-[#8b949e]">
                                                {request.program}  {request.assignedTo}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="text-center py-4 text-[#8b949e]">
                                <Icon name="inbox" size={32} className="mx-auto mb-2 opacity-50" />
                                <p className="text-sm">No requests yet</p>
                            </div>
                        )}
                    </div>

                    {/* Quick Access */}
                    <div>
                        <h3 className="text-lg font-semibold text-[#e6edf3] mb-4">Quick Access</h3>
                        <div className="space-y-2">
                            <button
                                onClick={() => onQuickAccess('recent')}
                                className="w-full p-3 bg-[#0d1117] hover:bg-[#30363d] rounded-lg text-left transition-colors"
                            >
                                <div className="flex items-center justify-between">
                                    <span className="text-sm text-[#e6edf3]">Files created since 2024</span>
                                    <Icon name="arrow-right" className="text-[#8b949e]" size={16} />
                                </div>
                            </button>
                            <button
                                onClick={() => onQuickAccess('requests')}
                                className="w-full p-3 bg-[#0d1117] hover:bg-[#30363d] rounded-lg text-left transition-colors"
                            >
                                <div className="flex items-center justify-between">
                                    <span className="text-sm text-[#e6edf3]">File requests</span>
                                    <Icon name="arrow-right" className="text-[#8b949e]" size={16} />
                                </div>
                            </button>
                            <button
                                onClick={() => onQuickAccess('gaps')}
                                className="w-full p-3 bg-[#0d1117] hover:bg-[#30363d] rounded-lg text-left transition-colors"
                            >
                                <div className="flex items-center justify-between">
                                    <span className="text-sm text-[#e6edf3]">Identify gaps</span>
                                    <Icon name="arrow-right" className="text-[#8b949e]" size={16} />
                                </div>
                            </button>
                            <button
                                onClick={() => onQuickAccess('manage')}
                                className="w-full p-3 bg-[#0d1117] hover:bg-[#30363d] rounded-lg text-left transition-colors"
                            >
                                <div className="flex items-center justify-between">
                                    <span className="text-sm text-[#e6edf3]">Manage Programs & Cohorts</span>
                                    <Icon name="arrow-right" className="text-[#8b949e]" size={16} />
                                </div>
                            </button>
                        </div>
                    </div>
                </aside>
            );
        }

        // Add Resource Modal
        function AddResourceModal({ programs, resources, onAddResource, onClose }) {
            const [formData, setFormData] = useState({
                resourceName: '',
                description: '',
                englishLink: '',
                spanishLink: '',
                portugueseLink: '',
                italianLink: '',
                govexOrExternal: 'GovEx',
                topics: [],
                programsUsed: [],
                fileType: '',
                fillable: false,
                authors: []
            });
            const [errors, setErrors] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);

            const fileTypes = [".xlsx", ".xls", ".pdf", ".docx", ".doc", ".pptx", ".html"];
            const commonTopics = [
                "Data Inventory", "Data Management", "Data Quality", "Internal Culture",
                "Capacity Building", "Transparency", "External Stakeholders"
            ];

            const [topicInput, setTopicInput] = useState('');
            const [authorInput, setAuthorInput] = useState('');

            const handleInputChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
                // Clear error when user starts typing
                if (errors[field]) {
                    setErrors(prev => ({ ...prev, [field]: '' }));
                }
            };

            const handleArrayAdd = (field, value, inputSetter) => {
                if (value.trim()) {
                    setFormData(prev => ({
                        ...prev,
                        [field]: [...prev[field], value.trim()]
                    }));
                    inputSetter('');
                }
            };

            const handleArrayRemove = (field, index) => {
                setFormData(prev => ({
                    ...prev,
                    [field]: prev[field].filter((_, i) => i !== index)
                }));
            };

            const handleProgramToggle = (programCode) => {
                setFormData(prev => {
                    const newPrograms = prev.programsUsed.includes(programCode)
                        ? prev.programsUsed.filter(p => p !== programCode)
                        : [...prev.programsUsed, programCode];
                    return { ...prev, programsUsed: newPrograms };
                });
            };

            const validateForm = () => {
                const newErrors = {};

                if (!formData.resourceName.trim()) newErrors.resourceName = 'Resource name is required';
                if (!formData.description.trim()) newErrors.description = 'Description is required';
                if (!formData.englishLink.trim()) newErrors.englishLink = 'English link is required';
                if (!formData.fileType) newErrors.fileType = 'File type is required';
                if (formData.programsUsed.length === 0) newErrors.programsUsed = 'At least one program is required';
                if (formData.topics.length === 0) newErrors.topics = 'At least one topic is required';
                if (formData.authors.length === 0) newErrors.authors = 'At least one author is required';

                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();

                if (!validateForm()) return;

                setIsSubmitting(true);

                try {
                    // Simulate API call delay
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    const newResource = {
                        id: Math.max(...resources.map(r => r.id || 0)) + 1,
                        resourceName: formData.resourceName.trim(),
                        description: formData.description.trim(),
                        englishLink: formData.englishLink.trim(),
                        spanishLink: formData.spanishLink.trim() || null,
                        portugueseLink: formData.portugueseLink.trim() || null,
                        italianLink: formData.italianLink.trim() || null,
                        govexOrExternal: formData.govexOrExternal,
                        topics: formData.topics,
                        programsUsed: formData.programsUsed,
                        fileType: formData.fileType,
                        fillable: formData.fillable,
                        authors: formData.authors,
                        lastUpdated: new Date().toISOString().split('T')[0],
                        isFavorite: false
                    };

                    onAddResource(newResource);
                    onClose();
                } catch (error) {
                    console.error('Error adding resource:', error);
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay">
                    <div className="bg-[#161b22] border border-[#30363d] rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
                        <div className="p-6 border-b border-[#30363d]">
                            <div className="flex items-center justify-between">
                                <h2 className="text-xl font-semibold text-[#e6edf3]">Add New Resource</h2>
                                <button onClick={onClose} className="p-1 hover:bg-[#30363d] rounded transition-colors">
                                    <Icon name="x" className="text-[#8b949e]" />
                                </button>
                            </div>
                        </div>

                        <form onSubmit={handleSubmit} className="p-6">
                            <div className="grid grid-cols-1 gap-6">
                                {/* Resource Name */}
                                <div>
                                    <label className="block text-sm font-medium text-[#e6edf3] mb-2">Resource Name *</label>
                                    <input
                                        type="text"
                                        value={formData.resourceName}
                                        onChange={(e) => handleInputChange('resourceName', e.target.value)}
                                        className="w-full bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] transition-colors"
                                        placeholder="Enter resource name"
                                    />
                                    {errors.resourceName && <p className="text-[#f85149] text-sm mt-1">{errors.resourceName}</p>}
                                </div>

                                {/* Description */}
                                <div>
                                    <label className="block text-sm font-medium text-[#e6edf3] mb-2">Description *</label>
                                    <textarea
                                        value={formData.description}
                                        onChange={(e) => handleInputChange('description', e.target.value)}
                                        rows={3}
                                        className="w-full bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] transition-colors resize-none"
                                        placeholder="Brief description of the resource"
                                    />
                                    {errors.description && <p className="text-[#f85149] text-sm mt-1">{errors.description}</p>}
                                </div>

                                {/* Language Links */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-[#e6edf3] mb-2">English Link *</label>
                                        <input
                                            type="url"
                                            value={formData.englishLink}
                                            onChange={(e) => handleInputChange('englishLink', e.target.value)}
                                            className="w-full bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] transition-colors"
                                            placeholder="https://docs.google.com/..."
                                        />
                                        {errors.englishLink && <p className="text-[#f85149] text-sm mt-1">{errors.englishLink}</p>}
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-[#e6edf3] mb-2">Spanish Link</label>
                                        <input
                                            type="url"
                                            value={formData.spanishLink}
                                            onChange={(e) => handleInputChange('spanishLink', e.target.value)}
                                            className="w-full bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] transition-colors"
                                            placeholder="https://docs.google.com/... (optional)"
                                        />
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-[#e6edf3] mb-2">Portuguese Link</label>
                                        <input
                                            type="url"
                                            value={formData.portugueseLink}
                                            onChange={(e) => handleInputChange('portugueseLink', e.target.value)}
                                            className="w-full bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] transition-colors"
                                            placeholder="https://docs.google.com/... (optional)"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-[#e6edf3] mb-2">Italian Link</label>
                                        <input
                                            type="url"
                                            value={formData.italianLink}
                                            onChange={(e) => handleInputChange('italianLink', e.target.value)}
                                            className="w-full bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] transition-colors"
                                            placeholder="https://docs.google.com/... (optional)"
                                        />
                                    </div>
                                </div>

                                {/* Source and File Type */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-[#e6edf3] mb-2">Source</label>
                                        <select
                                            value={formData.govexOrExternal}
                                            onChange={(e) => handleInputChange('govexOrExternal', e.target.value)}
                                            className="w-full bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] focus:outline-none focus:border-[#137fec] transition-colors"
                                        >
                                            <option value="GovEx">GovEx</option>
                                            <option value="External">External</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-[#e6edf3] mb-2">File Type *</label>
                                        <select
                                            value={formData.fileType}
                                            onChange={(e) => handleInputChange('fileType', e.target.value)}
                                            className="w-full bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] focus:outline-none focus:border-[#137fec] transition-colors"
                                        >
                                            <option value="">Select file type</option>
                                            {fileTypes.map(type => (
                                                <option key={type} value={type}>
                                                    {type}
                                                </option>
                                            ))}
                                        </select>
                                        {errors.fileType && <p className="text-[#f85149] text-sm mt-1">{errors.fileType}</p>}
                                    </div>
                                </div>

                                {/* Fillable checkbox and Version */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="flex items-center cursor-pointer hover:bg-[#30363d] p-2 rounded">
                                            <input
                                                type="checkbox"
                                                checked={formData.fillable}
                                                onChange={(e) => handleInputChange('fillable', e.target.checked)}
                                                className="mr-2 rounded border-[#30363d] bg-[#0d1117] text-[#137fec] focus:ring-[#137fec]"
                                            />
                                            <span className="text-[#e6edf3] text-sm">Fillable Template</span>
                                        </label>
                                    </div>

                                </div>

                                {/* Programs Used */}
                                <div>
                                    <label className="block text-sm font-medium text-[#e6edf3] mb-2">Programs Used *</label>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                        {programs.flatMap(program =>
                                            program.cohorts.map(cohort => {
                                                const programCode = `${program.shortName}${cohort.id}`;
                                                return (
                                                    <label key={programCode} className="flex items-center cursor-pointer hover:bg-[#30363d] p-2 rounded">
                                                        <input
                                                            type="checkbox"
                                                            checked={formData.programsUsed.includes(programCode)}
                                                            onChange={() => handleProgramToggle(programCode)}
                                                            className="mr-2 rounded border-[#30363d] bg-[#0d1117] text-[#137fec] focus:ring-[#137fec]"
                                                        />
                                                        <span className="text-[#e6edf3] text-sm">{programCode}</span>
                                                    </label>
                                                );
                                            })
                                        )}
                                    </div>
                                    {errors.programsUsed && <p className="text-[#f85149] text-sm mt-1">{errors.programsUsed}</p>}
                                </div>

                                {/* Topics */}
                                <div>
                                    <label className="block text-sm font-medium text-[#e6edf3] mb-2">Topics *</label>
                                    <div className="space-y-2">
                                        <div className="flex flex-wrap gap-2">
                                            {commonTopics.map(topic => (
                                                <button
                                                    key={topic}
                                                    type="button"
                                                    onClick={() => {
                                                        if (!formData.topics.includes(topic)) {
                                                            handleArrayAdd('topics', topic, () => {});
                                                        }
                                                    }}
                                                    className={`px-2 py-1 text-xs rounded transition-colors ${
                                                        formData.topics.includes(topic)
                                                            ? 'bg-[#137fec] text-white'
                                                            : 'bg-[#30363d] text-[#8b949e] hover:bg-[#484f58]'
                                                    }`}
                                                >
                                                    {topic}
                                                </button>
                                            ))}
                                        </div>
                                        <div className="flex space-x-2">
                                            <input
                                                type="text"
                                                value={topicInput}
                                                onChange={(e) => setTopicInput(e.target.value)}
                                                onKeyPress={(e) => {
                                                    if (e.key === 'Enter') {
                                                        e.preventDefault();
                                                        handleArrayAdd('topics', topicInput, setTopicInput);
                                                    }
                                                }}
                                                className="flex-1 bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] transition-colors"
                                                placeholder="Add custom topic..."
                                            />
                                            <button
                                                type="button"
                                                onClick={() => handleArrayAdd('topics', topicInput, setTopicInput)}
                                                className="px-3 py-2 bg-[#137fec] text-white rounded-lg hover:bg-[#1c8fed] transition-colors"
                                            >
                                                Add
                                            </button>
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {formData.topics.map((topic, index) => (
                                                <span key={index} className="inline-flex items-center px-2 py-1 bg-[#137fec] text-white text-xs rounded">
                                                    {topic}
                                                    <button
                                                        type="button"
                                                        onClick={() => handleArrayRemove('topics', index)}
                                                        className="ml-1 hover:text-[#f85149]"
                                                    >
                                                        
                                                    </button>
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                    {errors.topics && <p className="text-[#f85149] text-sm mt-1">{errors.topics}</p>}
                                </div>

                                {/* Authors */}
                                <div>
                                    <label className="block text-sm font-medium text-[#e6edf3] mb-2">Authors *</label>
                                    <div className="space-y-2">
                                        <div className="flex space-x-2">
                                            <input
                                                type="text"
                                                value={authorInput}
                                                onChange={(e) => setAuthorInput(e.target.value)}
                                                onKeyPress={(e) => {
                                                    if (e.key === 'Enter') {
                                                        e.preventDefault();
                                                        handleArrayAdd('authors', authorInput, setAuthorInput);
                                                    }
                                                }}
                                                className="flex-1 bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] transition-colors"
                                                placeholder="Add author name..."
                                            />
                                            <button
                                                type="button"
                                                onClick={() => handleArrayAdd('authors', authorInput, setAuthorInput)}
                                                className="px-3 py-2 bg-[#137fec] text-white rounded-lg hover:bg-[#1c8fed] transition-colors"
                                            >
                                                Add
                                            </button>
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {formData.authors.map((author, index) => (
                                                <span key={index} className="inline-flex items-center px-2 py-1 bg-[#10b981] text-white text-xs rounded">
                                                    {author}
                                                    <button
                                                        type="button"
                                                        onClick={() => handleArrayRemove('authors', index)}
                                                        className="ml-1 hover:text-[#f85149]"
                                                    >
                                                        
                                                    </button>
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                    {errors.authors && <p className="text-[#f85149] text-sm mt-1">{errors.authors}</p>}
                                </div>

                                {/* Submit Buttons */}
                                <div className="flex items-center justify-end space-x-3 pt-4 border-t border-[#30363d]">
                                    <button
                                        type="button"
                                        onClick={onClose}
                                        className="px-4 py-2 text-[#8b949e] hover:text-[#e6edf3] hover:bg-[#30363d] rounded-lg transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        disabled={isSubmitting}
                                        className="px-6 py-2 bg-[#137fec] text-white rounded-lg hover:bg-[#1c8fed] transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                                    >
                                        {isSubmitting ? (
                                            <>
                                                <Icon name="loader-2" className="animate-spin" size={16} />
                                                <span>Adding...</span>
                                            </>
                                        ) : (
                                            <>
                                                <Icon name="plus" size={16} />
                                                <span>Add Resource</span>
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // File Request Modal
        function FileRequestModal({ programs, fileRequests, onSubmitRequest, onClose }) {
            const [formData, setFormData] = useState({
                description: '',
                program: '',
                additionalContext: ''
            });
            const [errors, setErrors] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleInputChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
                if (errors[field]) {
                    setErrors(prev => ({ ...prev, [field]: '' }));
                }
            };

            const validateForm = () => {
                const newErrors = {};
                if (!formData.description.trim()) {
                    newErrors.description = 'Description is required';
                }
                if (!formData.program) {
                    newErrors.program = 'Program is required';
                }
                return newErrors;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const newErrors = validateForm();

                if (Object.keys(newErrors).length > 0) {
                    setErrors(newErrors);
                    return;
                }

                setIsSubmitting(true);

                const newRequest = {
                    id: Date.now(),
                    description: formData.description,
                    program: formData.program,
                    status: 'Submitted',
                    assignedTo: 'Unassigned',
                    notes: '',
                    requestedBy: 'Current User',
                    requestDate: new Date().toISOString().split('T')[0],
                    expectedCompletion: '',
                    additionalContext: formData.additionalContext
                };

                try {
                    await onSubmitRequest(newRequest);
                    setFormData({ description: '', program: '', additionalContext: '' });
                    setErrors({});
                    onClose(); // Close modal after successful submission
                } catch (error) {
                    setErrors({ submit: 'Failed to submit request. Please try again.' });
                } finally {
                    setIsSubmitting(false);
                }
            };


            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay">
                    <div className="bg-[#161b22] border border-[#30363d] rounded-lg w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto modal-content">
                        {/* Modal Header */}
                        <div className="flex items-center justify-between p-6 border-b border-[#30363d]">
                            <div className="flex items-center space-x-3">
                                <div className="w-8 h-8 bg-[#137fec] rounded-lg flex items-center justify-center">
                                    <Icon name="file-plus" className="text-white" size={18} />
                                </div>
                                <div>
                                    <h2 className="text-xl font-semibold text-[#e6edf3]">File Request & Gap Identification</h2>
                                    <p className="text-sm text-[#8b949e]">Request new resources or identify content gaps</p>
                                </div>
                            </div>
                            <button
                                onClick={onClose}
                                className="p-2 hover:bg-[#30363d] rounded-lg transition-colors"
                            >
                                <Icon name="x" className="text-[#8b949e]" size={20} />
                            </button>
                        </div>

                        {/* Modal Content */}
                        <div className="p-6">
                            <h3 className="text-lg font-medium text-[#e6edf3] mb-4">Submit New Request</h3>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                            {/* Description Field */}
                                            <div>
                                                <label className="block text-sm font-medium text-[#e6edf3] mb-2">
                                                    Description *
                                                </label>
                                                <textarea
                                                    value={formData.description}
                                                    onChange={(e) => handleInputChange('description', e.target.value)}
                                                    placeholder="Describe the resource you need..."
                                                    rows="4"
                                                    className={`w-full bg-[#0d1117] border rounded-lg px-3 py-2 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] transition-colors resize-none ${
                                                        errors.description ? 'border-[#f85149]' : 'border-[#30363d]'
                                                    }`}
                                                />
                                                {errors.description && (
                                                    <p className="text-[#f85149] text-sm mt-1">{errors.description}</p>
                                                )}
                                            </div>

                                            {/* Program Field */}
                                            <div>
                                                <label className="block text-sm font-medium text-[#e6edf3] mb-2">
                                                    Program *
                                                </label>
                                                <select
                                                    value={formData.program}
                                                    onChange={(e) => handleInputChange('program', e.target.value)}
                                                    className={`w-full bg-[#0d1117] border rounded-lg px-3 py-2 text-[#e6edf3] focus:outline-none focus:border-[#137fec] transition-colors ${
                                                        errors.program ? 'border-[#f85149]' : 'border-[#30363d]'
                                                    }`}
                                                >
                                                    <option value="">Select a program...</option>
                                                    {programs.map(program => (
                                                        <option key={program.id} value={program.name}>
                                                            {program.name}
                                                        </option>
                                                    ))}
                                                </select>
                                                {errors.program && (
                                                    <p className="text-[#f85149] text-sm mt-1">{errors.program}</p>
                                                )}
                                            </div>

                                            {/* Additional Context Field */}
                                            <div>
                                                <label className="block text-sm font-medium text-[#e6edf3] mb-2">
                                                    Additional Context
                                                </label>
                                                <textarea
                                                    value={formData.additionalContext}
                                                    onChange={(e) => handleInputChange('additionalContext', e.target.value)}
                                                    placeholder="Any additional details or requirements..."
                                                    rows="3"
                                                    className="w-full bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] transition-colors resize-none"
                                                />
                                            </div>

                                            {/* Submit Button */}
                                            <div className="pt-4">
                                                <button
                                                    type="submit"
                                                    disabled={isSubmitting}
                                                    className="w-full bg-[#137fec] hover:bg-[#1c5aa8] disabled:bg-[#30363d] text-white py-2 px-4 rounded-lg font-medium transition-colors flex items-center justify-center space-x-2"
                                                >
                                                    {isSubmitting ? (
                                                        <>
                                                            <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                            <span>Submitting...</span>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <Icon name="send" size={16} />
                                                            <span>Submit Request</span>
                                                        </>
                                                    )}
                                                </button>
                                            </div>

                                {errors.submit && (
                                    <p className="text-[#f85149] text-sm text-center">{errors.submit}</p>
                                )}
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // Simple Demo Chatbot Sidebar
        function DemoChatbot({ resources, programs, setSelectedFilters, setSearchQuery }) {
            const [messages, setMessages] = useState([
                {
                    id: 1,
                    type: 'bot',
                    message: " Hi! I'm your AI assistant. Try asking:\n\n \"Find data quality resources\"\n \"Show me GovEx resources\"\n \"How many resources?\"\n \"Resources by Laila\"",
                    timestamp: new Date()
                }
            ]);
            const [inputMessage, setInputMessage] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const getResponse = (message) => {
                const msg = message.toLowerCase();

                if (msg.includes('data quality') || msg.includes('quality')) {
                    return {
                        message: " Found resources about data quality! Filtering now...",
                        action: () => setSelectedFilters(prev => ({ ...prev, topics: new Set(['Data Quality']) }))
                    };
                }

                if (msg.includes('govex') || msg.includes('internal')) {
                    const count = resources.filter(r => r.govexOrExternal === 'GovEx').length;
                    return {
                        message: ` Showing ${count} GovEx resources!`,
                        action: () => setSelectedFilters(prev => ({ ...prev, sources: new Set(['GovEx']) }))
                    };
                }

                if (msg.includes('laila')) {
                    const count = resources.filter(r => r.authors?.includes('Laila')).length;
                    return {
                        message: ` Found ${count} resources by Laila!`,
                        action: () => setSelectedFilters(prev => ({ ...prev, authors: new Set(['Laila']) }))
                    };
                }

                if (msg.includes('how many') || msg.includes('count') || msg.includes('stats')) {
                    const total = resources.length;
                    const govex = resources.filter(r => r.govexOrExternal === 'GovEx').length;
                    const external = resources.filter(r => r.govexOrExternal === 'External').length;
                    const fillable = resources.filter(r => r.fillable).length;
                    const multiLang = resources.filter(r =>
                        [r.englishLink, r.spanishLink, r.portugueseLink, r.italianLink].filter(Boolean).length > 1
                    ).length;
                    return {
                        message: ` **Live Dashboard Stats:**\n Total: ${total} resources\n GovEx: ${govex}\n External: ${external}\n Fillable: ${fillable}\n Multi-language: ${multiLang}\n\n Data synced from Google Sheets!`,
                        action: null
                    };
                }

                if (msg.includes('excel') || msg.includes('xlsx')) {
                    return {
                        message: " Filtering Excel files for you!",
                        action: () => setSelectedFilters(prev => ({ ...prev, fileTypes: new Set(['.xlsx', '.xls']) }))
                    };
                }

                if (msg.includes('transparency')) {
                    return {
                        message: " Showing transparency resources!",
                        action: () => setSelectedFilters(prev => ({ ...prev, topics: new Set(['Transparency']) }))
                    };
                }

                // Check for any author name in the message
                const allAuthors = [...new Set(resources.flatMap(r => r.authors || []))];
                const mentionedAuthor = allAuthors.find(author =>
                    msg.includes(author.toLowerCase())
                );

                if (mentionedAuthor) {
                    const count = resources.filter(r => r.authors?.includes(mentionedAuthor)).length;
                    return {
                        message: ` Found ${count} resources by ${mentionedAuthor}!`,
                        action: () => setSelectedFilters(prev => ({ ...prev, authors: new Set([mentionedAuthor]) }))
                    };
                }

                // Check for any topic in the message
                const allTopics = [...new Set(resources.flatMap(r => r.topics || []))];
                const mentionedTopic = allTopics.find(topic =>
                    msg.includes(topic.toLowerCase())
                );

                if (mentionedTopic) {
                    const count = resources.filter(r => r.topics?.includes(mentionedTopic)).length;
                    return {
                        message: ` Found ${count} resources about ${mentionedTopic}!`,
                        action: () => setSelectedFilters(prev => ({ ...prev, topics: new Set([mentionedTopic]) }))
                    };
                }

                const availableAuthors = allAuthors.slice(0, 3).join(', ');
                const availableTopics = allTopics.slice(0, 3).join(', ');

                return {
                    message: `I can help you find resources! Try:\n \"Dashboard stats\"\n \"Show GovEx resources\"\n \"Find Excel files\"\n Authors: ${availableAuthors}\n Topics: ${availableTopics}\n\n Live data from Google Sheets!`,
                    action: null
                };
            };

            const handleSend = async () => {
                if (!inputMessage.trim()) return;

                const userMsg = {
                    id: Date.now(),
                    type: 'user',
                    message: inputMessage,
                    timestamp: new Date()
                };

                setMessages(prev => [...prev, userMsg]);
                setInputMessage('');
                setIsTyping(true);

                setTimeout(() => {
                    const response = getResponse(inputMessage);

                    const botMsg = {
                        id: Date.now() + 1,
                        type: 'bot',
                        message: response.message,
                        timestamp: new Date()
                    };

                    setMessages(prev => [...prev, botMsg]);
                    setIsTyping(false);

                    if (response.action) {
                        response.action();
                    }
                }, 800);
            };

            return (
                <div className="w-80 bg-[#161b22] border-l border-[#30363d] flex flex-col">
                    {/* Header */}
                    <div className="p-4 border-b border-[#30363d]">
                        <div className="flex items-center space-x-2">
                            <div className="w-8 h-8 bg-[#137fec] rounded-full flex items-center justify-center">
                                <Icon name="bot" className="text-white" size={16} />
                            </div>
                            <div>
                                <h3 className="text-sm font-medium text-[#e6edf3]">AI Assistant</h3>
                                <p className="text-xs text-[#8b949e]">Demo</p>
                            </div>
                        </div>
                    </div>

                    {/* Messages */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-3 max-h-[400px]">
                        {messages.map(message => (
                            <div key={message.id} className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] rounded-lg p-2 text-sm ${
                                    message.type === 'user'
                                        ? 'bg-[#137fec] text-white'
                                        : 'bg-[#0d1117] text-[#e6edf3] border border-[#30363d]'
                                }`}>
                                    <div className="whitespace-pre-line">{message.message}</div>
                                </div>
                            </div>
                        ))}

                        {isTyping && (
                            <div className="flex justify-start">
                                <div className="bg-[#0d1117] border border-[#30363d] rounded-lg p-2">
                                    <div className="flex space-x-1">
                                        <div className="w-1.5 h-1.5 bg-[#8b949e] rounded-full animate-bounce"></div>
                                        <div className="w-1.5 h-1.5 bg-[#8b949e] rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                                        <div className="w-1.5 h-1.5 bg-[#8b949e] rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input */}
                    <div className="p-4 border-t border-[#30363d]">
                        <div className="flex space-x-2">
                            <input
                                type="text"
                                value={inputMessage}
                                onChange={(e) => setInputMessage(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                                placeholder="Ask me anything..."
                                className="flex-1 bg-[#0d1117] border border-[#30363d] rounded px-2 py-1 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] text-sm"
                            />
                            <button
                                onClick={handleSend}
                                disabled={!inputMessage.trim() || isTyping}
                                className="p-1.5 bg-[#137fec] text-white rounded hover:bg-[#1c8fed] transition-colors disabled:opacity-50"
                            >
                                <Icon name="send" size={14} />
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // AI Chatbot Component
        function AIChatbot({
            isOpen,
            onClose,
            resources,
            programs,
            selectedFilters,
            setSelectedFilters,
            setSearchQuery,
            currentUser
        }) {
            const [messages, setMessages] = useState([
                {
                    id: 1,
                    type: 'bot',
                    message: " Hi! I'm your GovEx Academy assistant. I can help you find resources, navigate the dashboard, or answer questions about our content. What can I help you with today?",
                    timestamp: new Date()
                }
            ]);
            const [inputMessage, setInputMessage] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            // Predefined responses and AI logic
            const getAIResponse = (userMessage) => {
                const message = userMessage.toLowerCase();

                // Navigation help
                if (message.includes('navigate') || message.includes('how to use') || message.includes('help')) {
                    return {
                        message: "I can help you navigate the dashboard! Here are the main areas:\n\n **Left Sidebar**: Filter resources by programs, topics, authors, file types, and more\n **Main Area**: Browse resource cards with download links\n **Right Sidebar**: View quick stats and recent activity\n\nWhat would you like to explore?",
                        actions: []
                    };
                }

                // Search help
                if (message.includes('find') || message.includes('search') || message.includes('looking for')) {
                    const searchTerms = [];

                    // Extract potential search terms
                    const topics = ["data inventory", "data management", "data quality", "transparency", "capacity building", "internal culture", "external stakeholders"];
                    const foundTopics = topics.filter(topic => message.includes(topic));

                    if (foundTopics.length > 0) {
                        return {
                            message: `I found you're looking for resources about: **${foundTopics.join(', ')}**. Let me help you find those!`,
                            actions: [
                                { type: 'filter', filter: 'topics', values: foundTopics },
                                { type: 'search', query: foundTopics[0] }
                            ]
                        };
                    }

                    // Check for file types
                    const fileTypes = [".xlsx", ".pdf", ".docx", ".pptx"];
                    const foundFileTypes = fileTypes.filter(type => message.includes(type.replace('.', '')));

                    if (foundFileTypes.length > 0) {
                        return {
                            message: `Looking for ${foundFileTypes.join(' or ')} files? I'll filter those for you!`,
                            actions: [
                                { type: 'filter', filter: 'fileTypes', values: foundFileTypes }
                            ]
                        };
                    }

                    // Check for programs
                    const programNames = programs.map(p => p.name.toLowerCase());
                    const foundPrograms = programNames.filter(name => message.includes(name.split(' ')[0]));

                    if (foundPrograms.length > 0) {
                        return {
                            message: `I can help you find resources from specific programs! Would you like me to filter by program?`,
                            actions: []
                        };
                    }

                    return {
                        message: "I can help you search! Try asking me:\n\n \"Find resources about data quality\"\n \"Show me Excel files\"\n \"What's available from GovEx?\"\n \"Resources by Laila\"\n\nWhat are you looking for?",
                        actions: []
                    };
                }

                // Statistics questions
                if (message.includes('how many') || message.includes('stats') || message.includes('count')) {
                    const totalResources = resources.length;
                    const govexCount = resources.filter(r => r.govexOrExternal === 'GovEx').length;
                    const externalCount = resources.filter(r => r.govexOrExternal === 'External').length;
                    const fillableCount = resources.filter(r => r.fillable).length;

                    return {
                        message: ` **Dashboard Statistics:**\n\n **Total Resources**: ${totalResources}\n **GovEx Resources**: ${govexCount}\n **External Resources**: ${externalCount}\n **Fillable Templates**: ${fillableCount}\n\nYou can see live stats in the right sidebar!`,
                        actions: []
                    };
                }

                // Add resource help
                if (message.includes('add') || message.includes('create') || message.includes('new resource')) {
                    return {
                        message: "To add a new resource:\n\n1 Click the **\"Add Resource\"** button in the main dashboard\n2 Fill in the resource details (name, description, links)\n3 Select programs, topics, and authors\n4 Choose file type and mark if fillable\n\nWould you like me to open the add resource form?",
                        actions: [
                            { type: 'action', action: 'openAddResource' }
                        ]
                    };
                }

                // Filter help
                if (message.includes('filter') || message.includes('narrow down')) {
                    return {
                        message: " **Available Filters:**\n\n **Programs & Cohorts**: Filter by specific program/cohort combinations\n **Source**: GovEx or External resources\n **File Type**: Excel, PDF, Word, PowerPoint, Web\n **Fillable**: Templates you can fill out\n **Topics**: Data management, transparency, etc.\n **Authors**: Filter by creator\n **Languages**: Available in multiple languages\n\nWhat would you like to filter by?",
                        actions: []
                    };
                }

                // Authors question
                if (message.includes('author') || message.includes('who created') || message.includes('made by')) {
                    const uniqueAuthors = [...new Set(resources.flatMap(r => r.authors))];

                    // Check if asking about specific author
                    const foundAuthor = uniqueAuthors.find(author =>
                        message.includes(author.toLowerCase())
                    );

                    if (foundAuthor) {
                        const authorResources = resources.filter(r => r.authors.includes(foundAuthor));
                        return {
                            message: ` **${foundAuthor}** has created ${authorResources.length} resource(s):\n\n${authorResources.map(r => ` ${r.resourceName}`).slice(0, 5).join('\n')}${authorResources.length > 5 ? `\n... and ${authorResources.length - 5} more` : ''}\n\nWould you like me to filter by this author?`,
                            actions: [
                                { type: 'filter', filter: 'authors', values: [foundAuthor] }
                            ]
                        };
                    }

                    return {
                        message: ` **Available Authors:**\n\n${uniqueAuthors.map(author => ` ${author}`).join('\n')}\n\nYou can filter by any author using the sidebar. Who are you looking for?`,
                        actions: []
                    };
                }

                // Source questions
                if (message.includes('govex') || message.includes('external') || message.includes('source')) {
                    const govexCount = resources.filter(r => r.govexOrExternal === 'GovEx').length;
                    const externalCount = resources.filter(r => r.govexOrExternal === 'External').length;

                    if (message.includes('govex')) {
                        return {
                            message: ` **GovEx Resources**: We have ${govexCount} resources created by GovEx. These include templates, guides, and tools developed internally.\n\nWould you like me to show only GovEx resources?`,
                            actions: [
                                { type: 'filter', filter: 'sources', values: ['GovEx'] }
                            ]
                        };
                    }

                    if (message.includes('external')) {
                        return {
                            message: ` **External Resources**: We have ${externalCount} resources from external partners and organizations.\n\nWould you like me to show only external resources?`,
                            actions: [
                                { type: 'filter', filter: 'sources', values: ['External'] }
                            ]
                        };
                    }

                    return {
                        message: ` **Resource Sources:**\n\n **GovEx**: ${govexCount} internal resources\n **External**: ${externalCount} partner resources\n\nWhich would you like to explore?`,
                        actions: []
                    };
                }

                // Language questions
                if (message.includes('language') || message.includes('spanish') || message.includes('portuguese') || message.includes('italian')) {
                    const multiLangResources = resources.filter(r =>
                        [r.englishLink, r.spanishLink, r.portugueseLink, r.italianLink].filter(Boolean).length > 1
                    );

                    return {
                        message: ` **Multi-language Resources**: ${multiLangResources.length} resources are available in multiple languages.\n\n **English**: All resources\n **Spanish**: ${resources.filter(r => r.spanishLink).length} resources\n **Portuguese**: ${resources.filter(r => r.portugueseLink).length} resources\n **Italian**: ${resources.filter(r => r.italianLink).length} resources\n\nWhich language are you interested in?`,
                        actions: []
                    };
                }

                // Default response with suggestions
                return {
                    message: "I'm here to help! Here are some things you can ask me:\n\n **\"Find resources about [topic]\"**\n **\"How many resources do we have?\"**\n **\"How do I add a new resource?\"**\n **\"How do I filter resources?\"**\n **\"Who are the authors?\"**\n **\"Help me navigate the dashboard\"**\n\nWhat would you like to know?",
                    actions: []
                };
            };

            const executeActions = (actions) => {
                actions.forEach(action => {
                    switch(action.type) {
                        case 'filter':
                            setSelectedFilters(prev => {
                                const newFilters = { ...prev };
                                if (action.filter === 'topics') {
                                    action.values.forEach(value => {
                                        newFilters.topics.add(value);
                                    });
                                } else if (action.filter === 'fileTypes') {
                                    action.values.forEach(value => {
                                        newFilters.fileTypes.add(value);
                                    });
                                } else if (action.filter === 'authors') {
                                    action.values.forEach(value => {
                                        newFilters.authors.add(value);
                                    });
                                } else if (action.filter === 'sources') {
                                    action.values.forEach(value => {
                                        newFilters.sources.add(value);
                                    });
                                }
                                return newFilters;
                            });
                            break;
                        case 'search':
                            setSearchQuery(action.query);
                            break;
                        case 'action':
                            if (action.action === 'openAddResource') {
                                onClose(); // Close chatbot
                                // This action will be handled by the parent component
                                window.dispatchEvent(new CustomEvent('openAddResource'));
                            }
                            break;
                    }
                });
            };

            const handleSendMessage = async () => {
                if (!inputMessage.trim()) return;

                const userMessage = {
                    id: Date.now(),
                    type: 'user',
                    message: inputMessage,
                    timestamp: new Date()
                };

                setMessages(prev => [...prev, userMessage]);
                setInputMessage('');
                setIsTyping(true);

                // Simulate AI thinking time
                setTimeout(() => {
                    const aiResponse = getAIResponse(inputMessage);

                    const botMessage = {
                        id: Date.now() + 1,
                        type: 'bot',
                        message: aiResponse.message,
                        timestamp: new Date()
                    };

                    setMessages(prev => [...prev, botMessage]);
                    setIsTyping(false);

                    // Execute any actions
                    if (aiResponse.actions && aiResponse.actions.length > 0) {
                        executeActions(aiResponse.actions);
                    }
                }, 1000 + Math.random() * 1000);
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end justify-end z-50 p-4">
                    <div className="bg-[#161b22] border border-[#30363d] rounded-lg w-96 h-[600px] flex flex-col modal-content">
                        {/* Header */}
                        <div className="p-4 border-b border-[#30363d] flex items-center justify-between">
                            <div className="flex items-center space-x-3">
                                <div className="w-8 h-8 bg-[#137fec] rounded-full flex items-center justify-center">
                                    <Icon name="bot" className="text-white" size={18} />
                                </div>
                                <div>
                                    <h3 className="text-sm font-medium text-[#e6edf3]">GovEx Assistant</h3>
                                    <p className="text-xs text-[#8b949e]">AI-powered help</p>
                                </div>
                            </div>
                            <button
                                onClick={onClose}
                                className="p-1 hover:bg-[#30363d] rounded transition-colors"
                            >
                                <Icon name="x" className="text-[#8b949e]" size={18} />
                            </button>
                        </div>

                        {/* Messages */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {messages.map(message => (
                                <div
                                    key={message.id}
                                    className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}
                                >
                                    <div
                                        className={`max-w-[80%] rounded-lg p-3 ${
                                            message.type === 'user'
                                                ? 'bg-[#137fec] text-white'
                                                : 'bg-[#0d1117] text-[#e6edf3] border border-[#30363d]'
                                        }`}
                                    >
                                        <div className="text-sm whitespace-pre-line">{message.message}</div>
                                        <div className={`text-xs mt-1 opacity-70 ${
                                            message.type === 'user' ? 'text-blue-100' : 'text-[#8b949e]'
                                        }`}>
                                            {message.timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                        </div>
                                    </div>
                                </div>
                            ))}

                            {isTyping && (
                                <div className="flex justify-start">
                                    <div className="bg-[#0d1117] border border-[#30363d] rounded-lg p-3">
                                        <div className="flex space-x-1">
                                            <div className="w-2 h-2 bg-[#8b949e] rounded-full animate-bounce"></div>
                                            <div className="w-2 h-2 bg-[#8b949e] rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                                            <div className="w-2 h-2 bg-[#8b949e] rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Input */}
                        <div className="p-4 border-t border-[#30363d]">
                            <div className="flex space-x-2">
                                <input
                                    type="text"
                                    value={inputMessage}
                                    onChange={(e) => setInputMessage(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                    placeholder="Ask me anything about the dashboard..."
                                    className="flex-1 bg-[#0d1117] border border-[#30363d] rounded-lg px-3 py-2 text-[#e6edf3] placeholder-[#8b949e] focus:outline-none focus:border-[#137fec] transition-colors text-sm"
                                />
                                <button
                                    onClick={handleSendMessage}
                                    disabled={!inputMessage.trim() || isTyping}
                                    className="px-3 py-2 bg-[#137fec] text-white rounded-lg hover:bg-[#1c8fed] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    <Icon name="send" size={16} />
                                </button>
                            </div>
                            <p className="text-xs text-[#8b949e] mt-2">
                                Try asking: "Find data quality resources" or "How do I add a resource?"
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // Program Management Modal
        function ProgramManagementModal({ programs, setPrograms, onClose }) {
            const [newProgramName, setNewProgramName] = useState('');
            const [newProgramShortName, setNewProgramShortName] = useState('');
            const [initialCohort, setInitialCohort] = useState('');
            const [programColor, setProgramColor] = useState('#137fec');
            const [addingCohortTo, setAddingCohortTo] = useState(null);
            const [newCohortName, setNewCohortName] = useState('');

            const addNewProgram = () => {
                if (!newProgramName || !newProgramShortName || !initialCohort) return;

                // TODO: Will connect to Google Sheets API
                console.log("Adding new program:", newProgramName);

                const newProgram = {
                    id: Math.max(...programs.map(p => p.id)) + 1,
                    name: newProgramName,
                    shortName: newProgramShortName,
                    cohorts: [{
                        id: 1,
                        name: initialCohort,
                        active: true
                    }],
                    color: programColor
                };

                setPrograms([...programs, newProgram]);
                setNewProgramName('');
                setNewProgramShortName('');
                setInitialCohort('');
                setProgramColor('#137fec');
            };

            const addCohortToProgram = (programId) => {
                if (!newCohortName) return;

                // TODO: Will connect to Google Sheets API
                console.log("Adding cohort:", newCohortName, "to program:", programId);

                setPrograms(programs.map(program => {
                    if (program.id === programId) {
                        const maxCohortId = Math.max(...program.cohorts.map(c => c.id));
                        return {
                            ...program,
                            cohorts: [...program.cohorts, {
                                id: maxCohortId + 1,
                                name: newCohortName,
                                active: true
                            }]
                        };
                    }
                    return program;
                }));

                setNewCohortName('');
                setAddingCohortTo(null);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay">
                    <div className="bg-[#161b22] border border-[#30363d] rounded-lg w-full max-w-2xl max-h-[80vh] overflow-y-auto modal-content">
                        <div className="p-6 border-b border-[#30363d]">
                            <div className="flex items-center justify-between">
                                <h2 className="text-xl font-semibold text-[#e6edf3]">Manage Programs & Cohorts</h2>
                                <button onClick={onClose} className="p-1 hover:bg-[#30363d] rounded">
                                    <Icon name="x" className="text-[#8b949e]" />
                                </button>
                            </div>
                        </div>

                        <div className="p-6">
                            {/* Add New Program Form */}
                            <div className="mb-6 p-4 bg-[#0d1117] rounded-lg">
                                <h3 className="text-lg font-medium text-[#e6edf3] mb-4">Add New Program</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm text-[#8b949e] mb-1">Program Name</label>
                                        <input
                                            type="text"
                                            value={newProgramName}
                                            onChange={(e) => setNewProgramName(e.target.value)}
                                            className="w-full bg-[#161b22] border border-[#30363d] rounded px-3 py-2 text-[#e6edf3] focus:outline-none focus:border-[#137fec]"
                                            placeholder="e.g., Data Analytics Program"
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-[#8b949e] mb-1">Short Name</label>
                                            <input
                                                type="text"
                                                value={newProgramShortName}
                                                onChange={(e) => setNewProgramShortName(e.target.value)}
                                                className="w-full bg-[#161b22] border border-[#30363d] rounded px-3 py-2 text-[#e6edf3] focus:outline-none focus:border-[#137fec]"
                                                placeholder="e.g., DAP"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-[#8b949e] mb-1">Initial Cohort</label>
                                            <input
                                                type="text"
                                                value={initialCohort}
                                                onChange={(e) => setInitialCohort(e.target.value)}
                                                className="w-full bg-[#161b22] border border-[#30363d] rounded px-3 py-2 text-[#e6edf3] focus:outline-none focus:border-[#137fec]"
                                                placeholder="e.g., Cohort 1"
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-[#8b949e] mb-1">Program Color</label>
                                        <div className="flex items-center space-x-2">
                                            <input
                                                type="color"
                                                value={programColor}
                                                onChange={(e) => setProgramColor(e.target.value)}
                                                className="h-10 w-20 bg-[#161b22] border border-[#30363d] rounded cursor-pointer"
                                            />
                                            <span className="text-[#e6edf3]">{programColor}</span>
                                        </div>
                                    </div>
                                    <button
                                        onClick={addNewProgram}
                                        className="w-full px-4 py-2 bg-[#137fec] text-white rounded hover:bg-[#1c8fed] transition-colors"
                                    >
                                        Add Program
                                    </button>
                                </div>
                            </div>

                            {/* Existing Programs */}
                            <div>
                                <h3 className="text-lg font-medium text-[#e6edf3] mb-4">Existing Programs</h3>
                                <div className="space-y-3">
                                    {programs.map(program => (
                                        <div key={program.id} className="p-4 bg-[#0d1117] rounded-lg">
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center space-x-3">
                                                    <div
                                                        className="w-4 h-4 rounded"
                                                        style={{ backgroundColor: program.color }}
                                                    ></div>
                                                    <h4 className="text-[#e6edf3] font-medium">{program.name}</h4>
                                                    <span className="text-xs text-[#8b949e]">({program.shortName})</span>
                                                </div>
                                                {addingCohortTo !== program.id && (
                                                    <button
                                                        onClick={() => setAddingCohortTo(program.id)}
                                                        className="px-3 py-1 text-sm bg-[#30363d] text-[#137fec] rounded hover:bg-[#484f58] transition-colors"
                                                    >
                                                        Add Cohort
                                                    </button>
                                                )}
                                            </div>
                                            {addingCohortTo === program.id && (
                                                <div className="mb-3 flex items-center space-x-2">
                                                    <input
                                                        type="text"
                                                        value={newCohortName}
                                                        onChange={(e) => setNewCohortName(e.target.value)}
                                                        placeholder="Cohort name"
                                                        className="flex-1 bg-[#161b22] border border-[#30363d] rounded px-3 py-1 text-[#e6edf3] text-sm focus:outline-none focus:border-[#137fec]"
                                                    />
                                                    <button
                                                        onClick={() => addCohortToProgram(program.id)}
                                                        className="px-3 py-1 text-sm bg-[#137fec] text-white rounded hover:bg-[#1c8fed]"
                                                    >
                                                        Add
                                                    </button>
                                                    <button
                                                        onClick={() => {setAddingCohortTo(null); setNewCohortName('');}}
                                                        className="px-3 py-1 text-sm bg-[#30363d] text-[#8b949e] rounded hover:bg-[#484f58]"
                                                    >
                                                        Cancel
                                                    </button>
                                                </div>
                                            )}
                                            <div className="flex flex-wrap gap-2">
                                                {program.cohorts.map(cohort => (
                                                    <span
                                                        key={cohort.id}
                                                        className={`px-2 py-1 text-xs rounded ${
                                                            cohort.active
                                                                ? 'bg-[#30363d] text-[#e6edf3]'
                                                                : 'bg-[#161b22] text-[#8b949e] border border-[#30363d]'
                                                        }`}
                                                    >
                                                        {cohort.name}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [data, setData] = useState(MOCK_DATABASE);
            const [programs, setPrograms] = useState(MOCK_DATABASE.programs);
            const [resources, setResources] = useState(MOCK_DATABASE.resources);
            const [isLoading, setIsLoading] = useState(false);
            const [dataError, setDataError] = useState(null);
            const [lastUpdated, setLastUpdated] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedFilters, setSelectedFilters] = useState({
                selectedCohorts: new Set(),
                sources: new Set(),
                fileTypes: new Set(),
                fillableOnly: false,
                topics: new Set(),
                authors: new Set(),
                languages: new Set(),
                showRecent: true
            });
            const [expandedPrograms, setExpandedPrograms] = useState({});
            const [showProgramModal, setShowProgramModal] = useState(false);
            const [showResourceModal, setShowResourceModal] = useState(false);
            const [showFileRequestModal, setShowFileRequestModal] = useState(false);
            const [showStatsDropdown, setShowStatsDropdown] = useState(false);
            const [showRequestsDropdown, setShowRequestsDropdown] = useState(false);
            const [showBulkUpload, setShowBulkUpload] = useState(false);
            const [showNotificationSettings, setShowNotificationSettings] = useState(false);

            // Calculate resource counts for each program-cohort combination
            const resourceCounts = useMemo(() => {
                const counts = {};
                resources.forEach(resource => {
                    const key = `${resource.programId}-${resource.cohortId}`;
                    counts[key] = (counts[key] || 0) + 1;
                });
                return counts;
            }, [resources]);

            // Filter resources based on selected filters and search
            const filteredResources = useMemo(() => {
                return resources.filter(resource => {
                    // Search filter - now searches across multiple fields
                    if (searchQuery) {
                        const query = searchQuery.toLowerCase();
                        const searchableFields = [
                            resource.resourceName,
                            resource.description,
                            ...(resource.topics || []),
                            ...(resource.authors || []),
                            ...(resource.programsUsed || []),
                            resource.fileType
                        ].join(' ').toLowerCase();

                        if (!searchableFields.includes(query)) {
                            return false;
                        }
                    }

                    // Program/Cohort filter - now supports many-to-many relationship
                    if (selectedFilters.selectedCohorts.size > 0) {
                        const hasMatchingProgram = resource.programsUsed?.some(programCode => {
                            // Convert program codes back to program/cohort IDs for filtering
                            return programs.some(program => {
                                return program.cohorts.some(cohort => {
                                    const expectedCode = `${program.shortName}${cohort.id}`;
                                    const key = `${program.id}-${cohort.id}`;
                                    return expectedCode === programCode && selectedFilters.selectedCohorts.has(key);
                                });
                            });
                        });
                        if (!hasMatchingProgram) {
                            return false;
                        }
                    }

                    // Source filter
                    if (selectedFilters.sources.size > 0) {
                        if (!selectedFilters.sources.has(resource.govexOrExternal)) {
                            return false;
                        }
                    }

                    // File type filter
                    if (selectedFilters.fileTypes.size > 0) {
                        if (!selectedFilters.fileTypes.has(resource.fileType)) {
                            return false;
                        }
                    }

                    // Fillable filter
                    if (selectedFilters.fillableOnly) {
                        if (!resource.fillable) {
                            return false;
                        }
                    }

                    // Topics filter
                    if (selectedFilters.topics.size > 0) {
                        const hasMatchingTopic = resource.topics?.some(topic =>
                            selectedFilters.topics.has(topic)
                        );
                        if (!hasMatchingTopic) {
                            return false;
                        }
                    }

                    // Authors filter
                    if (selectedFilters.authors.size > 0) {
                        const hasMatchingAuthor = resource.authors?.some(author =>
                            selectedFilters.authors.has(author)
                        );
                        if (!hasMatchingAuthor) {
                            return false;
                        }
                    }

                    // Language availability filter
                    if (selectedFilters.languages.size > 0) {
                        const hasMatchingLanguage = selectedFilters.languages.has('english') && resource.englishLink ||
                                                   selectedFilters.languages.has('spanish') && resource.spanishLink ||
                                                   selectedFilters.languages.has('portuguese') && resource.portugueseLink ||
                                                   selectedFilters.languages.has('italian') && resource.italianLink;
                        if (!hasMatchingLanguage) {
                            return false;
                        }
                    }

                    // Year filter - using lastUpdated since createdYear is not in Google Sheets
                    if (selectedFilters.showRecent) {
                        const lastUpdatedYear = new Date(resource.lastUpdated).getFullYear();
                        if (lastUpdatedYear < 2024) {
                            return false;
                        }
                    }

                    return true;
                });
            }, [resources, searchQuery, selectedFilters, programs]);

            const toggleFavorite = (resourceId) => {
                setResources(resources.map(r =>
                    r.id === resourceId ? { ...r, isFavorite: !r.isFavorite } : r
                ));

                // Capture resource change event for notifications
                if (NOTIFICATIONS_V1_ENABLED && currentUser) {
                    NotificationService.captureResourceChange(
                        resourceId,
                        'updated',
                        currentUser.id,
                        'Resource favorite status changed'
                    );
                }
            };

            const handleAddResource = (newResource) => {
                // TODO: Will connect to Google Sheets API
                console.log("Adding new resource:", newResource);

                const updatedResources = [...resources, newResource];
                setResources(updatedResources);

                // Store resources globally for notification access
                window.currentResources = updatedResources;

                // Also save to localStorage for persistence in demo
                localStorage.setItem('resources', JSON.stringify(updatedResources));

                // Capture resource creation event for notifications
                if (NOTIFICATIONS_V1_ENABLED && currentUser) {
                    NotificationService.captureResourceChange(
                        newResource.id,
                        'created',
                        currentUser.id,
                        `New resource created: ${newResource.resourceName}`
                    );
                }
            };

            const handleFileRequest = async (newRequest) => {
                console.log("Adding new file request:", newRequest);

                try {
                    // Add user info to the request
                    const requestWithUserInfo = {
                        ...newRequest,
                        userName: currentUser.name,
                        userEmail: currentUser.email,
                        id: Date.now()
                    };

                    // Submit to Google Sheets (or localStorage as fallback)
                    const result = await FileRequestsService.submitFileRequest(requestWithUserInfo);

                    if (result.success) {
                        // Update local state with the new request
                        const updatedRequests = [...data.fileRequests, result.request];

                        // Add activity entry for the new request
                        const newActivity = {
                            id: Date.now() + Math.random(),
                            type: "request_submitted",
                            resource: newRequest.description.length > 50
                                ? `${newRequest.description.substring(0, 50)}...`
                                : newRequest.description,
                            requestId: result.request.id,
                            user: currentUser.name,
                            timestamp: "just now",
                            description: " File request submitted to Google Sheets"
                        };

                        const updatedActivity = [newActivity, ...data.recentActivity];

                        setData(prev => ({
                            ...prev,
                            fileRequests: updatedRequests,
                            recentActivity: updatedActivity
                        }));

                        // Also save to localStorage for persistence in demo
                        localStorage.setItem('fileRequests', JSON.stringify(updatedRequests));
                        localStorage.setItem('recentActivity', JSON.stringify(updatedActivity));

                        console.log(" File request successfully saved!");
                    } else {
                        console.error(" Failed to save file request:", result.error);
                        alert("Failed to submit request. Please try again.");
                    }
                } catch (error) {
                    console.error(" Error submitting file request:", error);
                    alert("Error submitting request. Please try again.");
                }
            };

            const handleLogin = (user) => {
                setCurrentUser(user);
                localStorage.setItem('govex_user', JSON.stringify(user));
            };

            const handleLogout = () => {
                setCurrentUser(null);
                localStorage.removeItem('govex_user');
            };

            const handleQuickAccess = (action) => {
                switch(action) {
                    case 'recent':
                        setSelectedFilters(prev => ({ ...prev, showRecent: true }));
                        break;
                    case 'requests':
                        alert('File requests view - Coming soon!');
                        break;
                    case 'gaps':
                        alert('Gap analysis - Coming soon!');
                        break;
                    case 'manage':
                        setShowProgramModal(true);
                        break;
                }
            };

            // Function to load data from Google Sheets with error handling
            const loadDataFromGoogleSheets = async () => {
                setIsLoading(true);
                setDataError(null);

                try {
                    const newData = await fetchDataFromGoogleSheets();

                    // Validate that we have proper data structure
                    if (!newData || !newData.resources || !Array.isArray(newData.resources)) {
                        throw new Error('Invalid data structure returned from Google Sheets');
                    }

                    console.log(' Setting new data:', {
                        resourceCount: newData.resources.length,
                        programCount: newData.programs?.length || 0,
                        hasTopics: newData.resources.some(r => r.topics && r.topics.length > 0)
                    });

                    // Detect resource changes for notifications
                    if (NOTIFICATIONS_V1_ENABLED && currentUser && resources.length > 0) {
                        const oldResourceIds = new Set(resources.map(r => r.id));
                        const newResourceIds = new Set(newData.resources.map(r => r.id));

                        // Find new resources
                        const addedResources = newData.resources.filter(r => !oldResourceIds.has(r.id));
                        addedResources.forEach(resource => {
                            NotificationService.captureResourceChange(
                                resource.id,
                                'created',
                                currentUser.id,
                                `New resource detected: ${resource.resourceName}`
                            );
                        });

                        // Find updated resources (compare lastUpdated field)
                        const updatedResources = newData.resources.filter(newR => {
                            const oldR = resources.find(r => r.id === newR.id);
                            return oldR && oldR.lastUpdated !== newR.lastUpdated;
                        });
                        updatedResources.forEach(resource => {
                            NotificationService.captureResourceChange(
                                resource.id,
                                'updated',
                                currentUser.id,
                                `Resource updated: ${resource.resourceName}`
                            );
                        });
                    }

                    setData(newData);
                    setPrograms(newData.programs || MOCK_DATABASE.programs);
                    setResources(newData.resources);
                    setLastUpdated(new Date());

                    // Store resources globally for notification access
                    window.currentResources = newData.resources;

                    console.log(' Data successfully loaded and set in state');
                } catch (error) {
                    console.error(' Error loading data from Google Sheets:', error);
                    setDataError('Failed to load data from Google Sheets. Using mock data.');

                    // Ensure we fall back to mock data
                    setData(MOCK_DATABASE);
                    setPrograms(MOCK_DATABASE.programs);
                    setResources(MOCK_DATABASE.resources);
                } finally {
                    setIsLoading(false);
                }
            };

            // Function to refresh data manually
            const refreshData = () => {
                loadDataFromGoogleSheets();
            };

            useEffect(() => {
                // Initialize global resources
                window.currentResources = resources;

                // Check for saved user session
                const savedUser = localStorage.getItem('govex_user');
                if (savedUser) {
                    setCurrentUser(JSON.parse(savedUser));
                }

                // Fetch data from Google Sheets on component mount
                loadDataFromGoogleSheets();
            }, []);

            // Update global resources when resources change
            useEffect(() => {
                window.currentResources = resources;
            }, [resources]);

            // Show login page if no user is logged in
            if (!currentUser) {
                return <LoginPage onLogin={handleLogin} />;
            }

            return (
                <div className="min-h-screen bg-[#0d1117] flex flex-col">
                    <Header
                        searchQuery={searchQuery}
                        setSearchQuery={setSearchQuery}
                        hasNotifications={true}
                        currentUser={currentUser}
                        onLogout={handleLogout}
                        onFileRequest={() => setShowFileRequestModal(true)}
                        showStatsDropdown={showStatsDropdown}
                        setShowStatsDropdown={setShowStatsDropdown}
                        showRequestsDropdown={showRequestsDropdown}
                        setShowRequestsDropdown={setShowRequestsDropdown}
                        fileRequests={data.fileRequests}
                        resources={resources}
                        programs={programs}
                        recentActivity={data.recentActivity}
                        setShowBulkUpload={setShowBulkUpload}
                        setShowNotificationSettings={setShowNotificationSettings}
                        onRefreshData={refreshData}
                        isLoading={isLoading}
                        dataError={dataError}
                        lastUpdated={lastUpdated}
                    />

                    <div className="flex flex-1 overflow-hidden">
                        <Sidebar
                            programs={programs}
                            resources={resources}
                            selectedFilters={selectedFilters}
                            setSelectedFilters={setSelectedFilters}
                            expandedPrograms={expandedPrograms}
                            setExpandedPrograms={setExpandedPrograms}
                            setShowProgramModal={setShowProgramModal}
                            resourceCounts={resourceCounts}
                        />

                        <main className="flex-1 overflow-y-auto p-6">
                            <div className="mb-6 flex items-center justify-between">
                                <div>
                                    <h2 className="text-2xl font-semibold text-[#e6edf3]">Resources</h2>
                                    <p className="text-[#8b949e] mt-1">
                                        Showing {filteredResources.length} of {resources.length} resources
                                    </p>
                                </div>
                                <button
                                    onClick={() => setShowResourceModal(true)}
                                    className="px-4 py-2 bg-[#137fec] text-white rounded-lg hover:bg-[#1c8fed] transition-colors flex items-center space-x-2"
                                >
                                    <Icon name="plus" size={16} />
                                    <span>Add Resource</span>
                                </button>
                            </div>

                            {isLoading ? (
                                <div className="text-center py-12">
                                    <Icon name="loader-2" className="mx-auto text-[#8b949e] mb-4 animate-spin" size={48} />
                                    <h3 className="text-lg font-medium text-[#e6edf3] mb-2">Loading Resources</h3>
                                    <p className="text-[#8b949e]">Syncing data from Google Sheets...</p>
                                </div>
                            ) : (
                                <>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {filteredResources.map(resource => (
                                            <ResourceCard
                                                key={resource.id}
                                                resource={resource}
                                                programs={programs}
                                                onToggleFavorite={toggleFavorite}
                                            />
                                        ))}
                                    </div>

                                    {filteredResources.length === 0 && (
                                        <div className="text-center py-12">
                                            <Icon name="inbox" className="mx-auto text-[#8b949e] mb-4" size={48} />
                                            <h3 className="text-lg font-medium text-[#e6edf3] mb-2">No resources found</h3>
                                            <p className="text-[#8b949e]">Try adjusting your filters or search query</p>
                                        </div>
                                    )}
                                </>
                            )}
                        </main>

                        <DemoChatbot
                            resources={resources}
                            programs={programs}
                            setSelectedFilters={setSelectedFilters}
                            setSearchQuery={setSearchQuery}
                        />
                    </div>

                    {showProgramModal && (
                        <ProgramManagementModal
                            programs={programs}
                            setPrograms={setPrograms}
                            onClose={() => setShowProgramModal(false)}
                        />
                    )}

                    {showResourceModal && (
                        <AddResourceModal
                            programs={programs}
                            resources={resources}
                            onAddResource={handleAddResource}
                            onClose={() => setShowResourceModal(false)}
                        />
                    )}

                    {showFileRequestModal && (
                        <FileRequestModal
                            programs={programs}
                            fileRequests={data.fileRequests}
                            onSubmitRequest={handleFileRequest}
                            onClose={() => setShowFileRequestModal(false)}
                        />
                    )}

                    {showBulkUpload && (
                        <BulkUploadCard
                            currentUser={currentUser}
                            onClose={() => setShowBulkUpload(false)}
                        />
                    )}

                    {showNotificationSettings && NOTIFICATIONS_V1_ENABLED && (
                        <div
                            data-test-modal="notification-settings"
                            style={{
                                position: 'fixed',
                                top: '0',
                                left: '0',
                                width: '100vw',
                                height: '100vh',
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                zIndex: 99999,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}
                            onLoad={() => console.log('TEST 3 PASSED: Modal displayed and visible to user')}
                        >
                            <div style={{
                                background: 'white',
                                padding: '50px',
                                borderRadius: '10px',
                                color: 'black',
                                fontSize: '20px'
                            }}
                            ref={(el) => {
                                if (el) {
                                    console.log('TEST 3 PASSED: Modal displayed and visible to user');
                                }
                            }}>
                                <h2>SETTINGS MODAL TEST</h2>
                                <p>This proves the state is working!</p>
                                <p style={{color: 'green', fontWeight: 'bold'}}> ALL TESTS COMPLETED</p>
                                <button
                                    onClick={() => setShowNotificationSettings(false)}
                                    style={{
                                        padding: '10px 20px',
                                        marginTop: '20px',
                                        fontSize: '16px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    )}
                    {/* Debug: Check showNotificationSettings state */}
                    {console.log('Modal render check:', { showNotificationSettings, NOTIFICATIONS_V1_ENABLED, currentUser: !!currentUser })}

                    {/* Temporary visual debug indicator */}
                    {showNotificationSettings && (
                        <div style={{
                            position: 'fixed',
                            top: '50px',
                            right: '50px',
                            background: 'red',
                            color: 'white',
                            padding: '10px',
                            zIndex: 9999,
                            border: '3px solid yellow'
                        }}>
                            DEBUG: showNotificationSettings is TRUE
                        </div>
                    )}

                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>